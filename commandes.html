<!DOCTYPE html>
<html lang="fr" class="font-inter">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"/>
  <title>ViralFlowr | Transactions</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{ color-scheme: light; }
    html, body{ width:100%; max-width:100%; overflow-x:hidden; overscroll-behavior-x:none; }
    *{ box-sizing:border-box; }

    body{
      font-family:'Inter',sans-serif;
      background:#F3F3F3;
      color:#201B16;
      -webkit-text-size-adjust:100%;
      text-rendering:optimizeLegibility;
    }

    .page{ width:100%; max-width:980px; margin:0 auto; padding:16px; }
    @media (min-width: 768px){ .page{ padding:32px; } }

    .text-orange-bsv{ color:#F07E13; }
    .brand-gradient { background: linear-gradient(135deg, #F07E13 0%, #FFB26B 100%); }

    .card{
      background:#fff;
      border:1px solid #eee;
      border-radius:24px;
      box-shadow:0 10px 25px rgba(0,0,0,.06);
      width:100%;
      max-width:100%;
      overflow:hidden;
    }

    /* Buttons */
    .btn{
      height:44px;
      border-radius:16px;
      font-weight:900;
      font-size:12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:0 14px;
      max-width:100%;
      white-space:nowrap;
      flex:0 0 auto;
      -webkit-tap-highlight-color:transparent;
      transition:.2s;
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .btn-outline{ border:1px solid #E5E7EB; background:#fff; color:#111827; }
    .btn-outline:hover{ border-color:#F07E13; color:#F07E13; }
    .btn-primary{ color:#fff; }
    .btn-primary:hover{ filter:brightness(.98); }

    /* Icon buttons (mobile topbar) */
    .icon-btn{
      width:44px;
      height:44px;
      border-radius:16px;
      border:1px solid #E5E7EB;
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:.2s;
      color:#374151;
      flex:0 0 auto;
      -webkit-tap-highlight-color:transparent;
    }
    .icon-btn:hover{ transform:translateY(-1px); border-color:#F07E13; color:#F07E13; }

    /* Topbar layout (fix buttons above) */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:18px;
    }
    .brand-link{ flex:0 0 auto; min-width:0; }
    .top-actions{
      display:flex;
      align-items:center;
      gap:8px;
      flex:0 0 auto;
      min-width:0;
    }

    /* On very small screens: if needed, allow horizontal scroll instead of overflow/wrap */
    @media (max-width: 420px){
      .top-actions{
        max-width: 62vw;
        overflow-x:auto;
        -webkit-overflow-scrolling:touch;
        padding-bottom:2px;
      }
      .top-actions::-webkit-scrollbar{ display:none; }
    }

    .safe-text{ min-width:0; overflow-wrap:anywhere; word-break:break-word; }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%);
      background: rgba(17,24,39,.95);
      color: #fff;
      padding: 12px 14px;
      border-radius: 16px;
      font-weight: 800;
      font-size: 12px;
      letter-spacing: .04em;
      box-shadow: 0 10px 25px rgba(0,0,0,.18);
      z-index: 9999;
      max-width: min(92vw, 520px);
      display:none;
    }
    .toast.show{ display:block; animation: pop .18s ease-out; }
    @keyframes pop{
      from{ transform: translateX(-50%) translateY(8px); opacity:0 }
      to{ transform: translateX(-50%) translateY(0); opacity:1 }
    }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }

    .badge{
      font-size:10px;
      font-weight:900;
      letter-spacing:.08em;
      text-transform:uppercase;
      padding:6px 10px;
      border-radius:999px;
      max-width:100%;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      white-space:nowrap;
    }
  </style>
</head>

<body>
  <div class="page">

    <div class="topbar">
      <a href="/index.html" class="inline-flex items-center gap-2 brand-link" aria-label="ViralFlowr">
        <span class="text-2xl font-black tracking-tighter safe-text">
          Viral<span class="text-orange-bsv">Flowr</span>
        </span>
      </a>

      <div class="top-actions">
        <!-- Mobile (icons) -->
        <a href="/index.html" class="icon-btn sm:hidden" title="Boutique" aria-label="Boutique">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 11l9-8 9 8"></path>
            <path d="M9 22V12h6v10"></path>
          </svg>
        </a>

        <a href="/wallet.html" class="icon-btn sm:hidden" title="Wallet" aria-label="Wallet">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 7H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h13a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2Z"/>
            <path d="M16 7V5a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v2"/>
            <path d="M20 12h-4a2 2 0 0 0 0 4h4"/>
            <circle cx="16" cy="14" r="0.5" />
          </svg>
        </a>

        <button id="logoutBtnIcon" class="icon-btn sm:hidden" type="button" title="Déconnexion" aria-label="Déconnexion">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
            <path d="M10 17l5-5-5-5"></path>
            <path d="M15 12H3"></path>
          </svg>
        </button>

        <!-- Desktop (text buttons) -->
        <a href="/index.html" class="btn btn-outline hidden sm:inline-flex">Boutique</a>
        <a href="/wallet.html" class="btn btn-outline hidden sm:inline-flex">Wallet</a>
        <button id="logoutBtn" class="btn btn-outline hidden sm:inline-flex" type="button">Déconnexion</button>
      </div>
    </div>

    <div class="card p-6 md:p-8 mb-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div class="safe-text">
          <div class="text-[10px] font-black uppercase tracking-widest text-gray-400">Compte connecté</div>
          <div id="userEmail" class="text-lg font-black text-gray-900 safe-text">—</div>
          <div id="modeLine" class="text-[12px] font-bold text-gray-500 mt-1 safe-text">
            Chargement des transactions…
          </div>
        </div>
        <div class="flex gap-2 w-full md:w-auto">
          <button id="refreshBtn" class="btn brand-gradient btn-primary w-full md:w-auto" type="button">Actualiser</button>
        </div>
      </div>
    </div>

    <div id="stateBox" class="card p-6 md:p-8 text-center text-gray-500 font-bold">
      Chargement…
    </div>

    <div id="txWrap" class="hidden card overflow-hidden"></div>

    <pre id="debugBox" class="hidden mt-4 p-4 rounded-2xl bg-black text-white text-[11px] overflow-auto mono"></pre>

    <div class="mt-8 text-center">
      <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">© 2026 ViralFlowr • Transactions</p>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- MODAL Voir (colonne M / réponse) -->
  <div id="respModal" class="hidden fixed inset-0 z-[9999]">
    <div id="respOverlay" class="absolute inset-0 bg-black/50"></div>
    <div class="relative max-w-[980px] mx-auto mt-16 p-4">
      <div class="card p-5">
        <div class="flex items-center justify-between gap-3">
          <div class="font-black text-sm uppercase tracking-widest text-gray-400">Réponse</div>
          <button id="closeRespBtn" class="btn btn-outline" type="button" style="height:34px;padding:0 10px;font-size:10px;">
            Fermer
          </button>
        </div>
        <pre id="respText"
             class="mt-3 p-3 rounded-2xl bg-gray-50 border border-gray-200 text-[12px] font-semibold text-gray-800 overflow-auto mono"
             style="white-space:pre-wrap;"></pre>
        <div class="mt-3 flex flex-wrap gap-2">
          <button id="copyRespBtn" class="btn btn-outline" type="button" style="height:38px;padding:0 12px;font-size:11px;">Copier</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const GOOGLE_URL = "https://script.google.com/macros/s/AKfycbx_Tm3cGZs4oYdKmPieUU2SCjegAvn-BTufubyqZTFU4geAiRXN53YYE9XVGdq_uq1H/exec";
    const DEBUG = new URLSearchParams(location.search).has("debug");

    // =========================
    // Debug helper
    // =========================
    const debugBox = document.getElementById("debugBox");
    function dbg(title, obj){
      if(!DEBUG) return;
      debugBox.classList.remove("hidden");
      debugBox.textContent += "\n" + title + ":\n" + (typeof obj === "string" ? obj : JSON.stringify(obj, null, 2)) + "\n";
      try { console.log(title, obj); } catch(_){}
    }

    // =========================
    // Toast
    // =========================
    function toast(msg){
      const el = document.getElementById("toast");
      el.textContent = String(msg || "");
      el.classList.add("show");
      clearTimeout(window.__vf_toast_t);
      window.__vf_toast_t = setTimeout(()=> el.classList.remove("show"), 2200);
    }

    // =========================
    // Helpers
    // =========================
    function esc_(s){
      return String(s||"").replace(/[&<>"']/g, (c)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    function fmt2(n){
      const x = Number(n||0);
      if(!isFinite(x)) return "0.00";
      return x.toFixed(2);
    }

    function toNumber_(v){
      if (v === null || v === undefined) return 0;
      if (typeof v === "number") return isFinite(v) ? v : 0;
      const s = String(v).trim().replace(/\s+/g,"").replace(",",".");
      const x = parseFloat(s);
      return isFinite(x) ? x : 0;
    }

    function badgeForStatus_(st){
      const s = String(st||"").toUpperCase();
      if (s.includes("PAID") || s.includes("VALID") || s.includes("RECEIVED")) return ["bg-blue-100 text-blue-700","Paiement reçu"];
      if (s.includes("PENDING") || s.includes("ATTENTE")) return ["bg-yellow-100 text-yellow-700","En attente"];
      if (s.includes("PROCESS") || s.includes("TRAIT")) return ["bg-purple-100 text-purple-700","En traitement"];
      if (s.includes("DONE") || s.includes("SUCCESS") || s.includes("DELIVER")) return ["bg-green-100 text-green-700","Terminé"];
      if (s.includes("FAIL") || s.includes("REFUS") || s.includes("ERROR")) return ["bg-red-100 text-red-700","Erreur"];
      return ["bg-gray-100 text-gray-700", st || "—"];
    }

    function tryParse_(raw){ try { return JSON.parse(raw); } catch { return null; } }

    // =========================
    // Session robuste (comme wallet)
    // =========================
    function getSession_(){
      const keys = ["vf_session","VF_SESSION","vfSession","VFSession","session","auth","vf_auth"];
      for(const k of keys){
        const raw = localStorage.getItem(k);
        if(!raw) continue;
        const s = tryParse_(raw);
        if(s && typeof s === "object") return s;
      }
      return null;
    }
    function pickStr_(v){
      const s = String(v||"").trim();
      return s ? s : "";
    }
    function getAuth_(s){
      const email =
        pickStr_(s?.email) ||
        pickStr_(s?.userEmail) ||
        pickStr_(s?.mail) ||
        pickStr_(s?.username) ||
        pickStr_(s?.user?.email) || "";

      const token =
        pickStr_(s?.token) ||
        pickStr_(s?.sessionToken) ||
        pickStr_(s?.access_token) ||
        pickStr_(s?.accessToken) ||
        pickStr_(s?.jwt) ||
        pickStr_(s?.user?.token) || "";

      return { email: email.toLowerCase(), token };
    }

    // =========================
    // Clipboard (robuste)
    // =========================
    async function copy_(text){
      const t = String(text || "");
      try{
        if (navigator.clipboard && typeof navigator.clipboard.writeText === "function"){
          await navigator.clipboard.writeText(t);
          return true;
        }
      }catch(_){}

      try{
        const ta = document.createElement("textarea");
        ta.value = t;
        ta.setAttribute("readonly","true");
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        ta.style.top = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        const ok = document.execCommand("copy");
        ta.remove();
        return !!ok;
      }catch(_){}
      return false;
    }

    // =========================
    // JSONP
    // =========================
    function jsonp_(params, onOk, onErr, timeoutMs=12000){
      const cb = "VF_CB_" + Date.now() + "_" + Math.floor(Math.random()*1000000);
      let done = false;

      const timer = setTimeout(() => {
        if(done) return;
        done = true;
        try { delete window[cb]; } catch(_){}
        onErr && onErr("TIMEOUT");
      }, timeoutMs);

      window[cb] = function(payload){
        if(done) return;
        done = true;
        clearTimeout(timer);
        try { onOk(payload); }
        finally { try { delete window[cb]; } catch(_){} }
      };

      const s = document.createElement("script");
      const qs = new URLSearchParams({ ...params, callback: cb, t: String(Date.now()) });
      const url = GOOGLE_URL + "?" + qs.toString();
      dbg("JSONP URL", url);
      s.src = url;

      s.onerror = function(){
        if(done) return;
        done = true;
        clearTimeout(timer);
        try { delete window[cb]; } catch(_){}
        onErr && onErr("NETWORK");
      };

      document.body.appendChild(s);
      s.onload = () => setTimeout(() => { try { s.remove(); } catch(_){ } }, 0);
    }

    // =========================
    // Modal Voir
    // =========================
    const respModal = document.getElementById("respModal");
    const respOverlay = document.getElementById("respOverlay");
    const respText = document.getElementById("respText");
    const closeRespBtn = document.getElementById("closeRespBtn");
    const copyRespBtn = document.getElementById("copyRespBtn");

    function openResp_(text){
      respText.textContent = String(text || "—");
      respModal.classList.remove("hidden");
    }
    function closeResp_(){
      respModal.classList.add("hidden");
      respText.textContent = "";
    }
    closeRespBtn?.addEventListener("click", closeResp_);
    respOverlay?.addEventListener("click", closeResp_);
    copyRespBtn?.addEventListener("click", async () => {
      const t = respText.textContent || "";
      const ok = await copy_(t);
      toast(ok ? "Copié." : "Copie impossible.");
    });

    // =========================
    // Response field (col M) robust
    // =========================
    function getResponseText_(o){
      const cand = [
        o.colM, o.manualResponse, o.reponse_site, o.reponseSite, o.response_site, o.responseSite,
        o.reponse, o.response, o.delivery, o.siteResponse, o.site_response,
        o.rep, o.m, o.M
      ];
      for(const v of cand){
        const t = String(v || "").trim();
        if(t) return t;
      }
      return "";
    }

    function pickAmount_(o){
      const cand = [o.prix_achat, o.prixAchat, o.purchase_price, o.buy_price, o.buyPrice, o.amount, o.montant, o.total];
      for(const v of cand){
        if(v === 0) return 0;
        if(v !== null && v !== undefined && String(v).trim() !== "") return v;
      }
      return 0;
    }

    // =========================
    // Render table
    // =========================
    function renderTable_(list, title){
      const stateBox = document.getElementById("stateBox");
      const wrap = document.getElementById("txWrap");

      if(!Array.isArray(list) || list.length === 0){
        wrap.classList.add("hidden");
        stateBox.classList.remove("hidden");
        stateBox.innerHTML = "Aucune transaction trouvée.";
        return;
      }

      // Tri léger: si "ts" est dispo, on met les plus récentes en haut
      const sorted = [...list].sort((a,b)=>{
        const ta = toNumber_(a?.ts || a?.timestamp || 0);
        const tb = toNumber_(b?.ts || b?.timestamp || 0);
        return tb - ta;
      });

      stateBox.classList.add("hidden");
      wrap.classList.remove("hidden");

      const rows = sorted.map((o) => {
        const orderId = String(o.orderId || o.id || o.order_id || "").trim();
        const created = String(o.createdAt || o.date || o.created_at || o.ts || "").trim() || "—";
        const product = String(o.produit || o.product || o.nom || o.title || "—");
        const qty = Number(o.quantite || o.qty || o.quantity || 1) || 1;

        const amountRaw = pickAmount_(o);
        const amount = toNumber_(amountRaw);

        const status = String(o.status || o.statut || "");
        const [badgeCls, badgeTxt] = badgeForStatus_(status);

        const resp = getResponseText_(o);
        const hasResp = !!String(resp||"").trim();
        const respEnc = encodeURIComponent(resp || "");

        return `
          <tr class="border-t">
            <td class="p-3 font-bold text-gray-500">${esc_(created)}</td>
            <td class="p-3 font-black text-gray-900">${esc_(orderId || "—")}</td>
            <td class="p-3 font-semibold text-gray-700">${esc_(product)}</td>
            <td class="p-3 font-black text-gray-900">${esc_(String(qty))}</td>
            <td class="p-3 font-black text-gray-900">${esc_(fmt2(amount))} $</td>
            <td class="p-3"><span class="badge ${badgeCls}">${esc_(badgeTxt)}</span></td>
            <td class="p-3">
              ${hasResp
                ? `<button class="btn btn-outline seeBtn" type="button" style="height:32px;padding:0 10px;font-size:10px;" data-resp="${respEnc}">Voir</button>`
                : `<span class="text-[11px] font-black text-gray-300 uppercase tracking-widest">—</span>`}
            </td>
          </tr>
        `;
      }).join("");

      wrap.innerHTML = `
        <div class="p-5 md:p-6 border-b border-gray-100">
          <div class="text-[10px] font-black uppercase tracking-widest text-gray-400">${esc_(title)}</div>
          <div class="text-[12px] font-bold text-gray-500 mt-1">
            Total: <span class="font-black text-gray-900">${sorted.length}</span>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-gray-50">
              <tr class="text-left text-[11px] uppercase tracking-widest text-gray-400 font-black">
                <th class="p-3">Date</th>
                <th class="p-3">Commande</th>
                <th class="p-3">Produit</th>
                <th class="p-3">Qté</th>
                <th class="p-3">Montant</th>
                <th class="p-3">Statut</th>
                <th class="p-3">Voir</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;

      wrap.querySelectorAll(".seeBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          const respEnc = btn.getAttribute("data-resp") || "";
          const text = decodeURIComponent(respEnc || "");
          openResp_(text || "—");
        });
      });
    }

    // =========================
    // Auth UI (text + icon)
    // =========================
    function applyAuthUI_(){
      const btnText = document.getElementById("logoutBtn");
      const btnIcon = document.getElementById("logoutBtnIcon");

      const s = getSession_();

      function setBoth_(label, onClick){
        if (btnText){
          btnText.textContent = label;
          btnText.disabled = false;
          btnText.onclick = onClick;
        }
        if (btnIcon){
          btnIcon.setAttribute("aria-label", label);
          btnIcon.setAttribute("title", label);
          btnIcon.disabled = false;
          btnIcon.onclick = onClick;
        }
      }

      if(!s){
        setBoth_("Connexion", () => { window.location.href = "/login.html"; });
        return;
      }

      setBoth_("Déconnexion", () => {
        ["vf_session","VF_SESSION","vfSession","VFSession","session","auth","vf_auth"].forEach(k => {
          try { localStorage.removeItem(k); } catch(_){}
        });
        toast("Déconnecté.");
        applyAuthUI_();
        loadTransactions_();
      });
    }

    window.addEventListener("storage", (e) => {
      const keys = ["vf_session","VF_SESSION","vfSession","VFSession","session","auth","vf_auth"];
      if(keys.includes(e.key)) {
        applyAuthUI_();
        loadTransactions_();
      }
    });

    // =========================
    // Load transactions: try order_history then fallback purchase_tx
    // =========================
    function extractListFromRes_(res){
      if(Array.isArray(res)) return res;
      if(res && Array.isArray(res.orders)) return res.orders;
      if(res && Array.isArray(res.items)) return res.items;
      if(res && Array.isArray(res.list)) return res.list;
      if(res && Array.isArray(res.data)) return res.data;
      return [];
    }

    function loadTransactions_(){
      const s = getSession_();
      const stateBox = document.getElementById("stateBox");
      const wrap = document.getElementById("txWrap");
      const userEmail = document.getElementById("userEmail");
      const modeLine = document.getElementById("modeLine");
      const refreshBtn = document.getElementById("refreshBtn");

      wrap.classList.add("hidden");
      stateBox.classList.remove("hidden");
      stateBox.innerHTML = "Chargement…";

      applyAuthUI_();

      if (refreshBtn){
        refreshBtn.disabled = true;
        refreshBtn.textContent = "Actualisation…";
      }

      if(!s){
        userEmail.textContent = "—";
        modeLine.textContent = "Connectez-vous pour voir vos transactions.";
        stateBox.innerHTML = `
          <div class="text-gray-900 font-black text-lg">Vous n’êtes pas connecté.</div>
          <div class="text-gray-500 font-bold mt-2">Connectez-vous pour voir vos transactions.</div>
          <div class="mt-4">
            <a class="btn brand-gradient btn-primary w-full sm:w-auto" href="/login.html">Connexion</a>
          </div>
        `;
        if (refreshBtn){
          refreshBtn.disabled = false;
          refreshBtn.textContent = "Actualiser";
        }
        return;
      }

      const auth = getAuth_(s);
      userEmail.textContent = auth.email || "Utilisateur";
      modeLine.textContent = "API: tentative order_history…";

      // 1) order_history
      jsonp_(
        { action:"order_history", email: auth.email, token: auth.token, limit:"200" },
        (res) => {
          dbg("order_history response", res);

          const list = extractListFromRes_(res);
          const ok = (res && res.ok === true);

          if(ok || list.length){
            modeLine.textContent = "Source: order_history";
            renderTable_(list, "Transactions d’achat (order_history)");
            if (refreshBtn){
              refreshBtn.disabled = false;
              refreshBtn.textContent = "Actualiser";
            }
            return;
          }

          // fallback
          modeLine.textContent = "order_history indisponible → fallback purchase_tx…";

          jsonp_(
            { action:"purchase_tx", email: auth.email, token: auth.token, limit:"200" },
            (res2) => {
              dbg("purchase_tx response", res2);

              const list2 = extractListFromRes_(res2);
              const ok2 = (res2 && res2.ok === true);

              if(ok2 || list2.length){
                modeLine.textContent = "Source: purchase_tx";
                renderTable_(list2, "Transactions d’achat (purchase_tx)");
                if (refreshBtn){
                  refreshBtn.disabled = false;
                  refreshBtn.textContent = "Actualiser";
                }
                return;
              }

              const err = (res2 && (res2.error || res2.message)) || (res && (res.error || res.message)) || "Aucune donnée";
              stateBox.innerHTML = "Erreur: " + esc_(err);
              modeLine.textContent = "Aucune transaction chargée.";
              if (refreshBtn){
                refreshBtn.disabled = false;
                refreshBtn.textContent = "Actualiser";
              }
            },
            (why2) => {
              stateBox.innerHTML = "Erreur réseau (purchase_tx): " + esc_(why2);
              modeLine.textContent = "Erreur réseau.";
              if (refreshBtn){
                refreshBtn.disabled = false;
                refreshBtn.textContent = "Actualiser";
              }
            }
          );
        },
        (why) => {
          dbg("order_history error", why);

          modeLine.textContent = "order_history réseau KO → fallback purchase_tx…";

          const auth2 = getAuth_(getSession_() || {});
          jsonp_(
            { action:"purchase_tx", email: auth2.email, token: auth2.token, limit:"200" },
            (res2) => {
              dbg("purchase_tx response", res2);

              const list2 = extractListFromRes_(res2);
              const ok2 = (res2 && res2.ok === true);

              if(ok2 || list2.length){
                modeLine.textContent = "Source: purchase_tx";
                renderTable_(list2, "Transactions d’achat (purchase_tx)");
              } else {
                const err = (res2 && (res2.error || res2.message)) || "Impossible de charger";
                stateBox.innerHTML = "Erreur: " + esc_(err);
                modeLine.textContent = "Aucune transaction chargée.";
              }

              if (refreshBtn){
                refreshBtn.disabled = false;
                refreshBtn.textContent = "Actualiser";
              }
            },
            (why2) => {
              stateBox.innerHTML = "Erreur réseau: " + esc_(why) + " / " + esc_(why2);
              modeLine.textContent = "Erreur réseau.";
              if (refreshBtn){
                refreshBtn.disabled = false;
                refreshBtn.textContent = "Actualiser";
              }
            }
          );
        }
      );
    }

    document.getElementById("refreshBtn").addEventListener("click", loadTransactions_);

    // INIT
    applyAuthUI_();
    loadTransactions_();
  </script>
</body>
</html>
