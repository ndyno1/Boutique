<!DOCTYPE html>
<html lang="fr" class="font-inter">
<head>
  <meta charset="utf-8"/>
  <!-- ✅ Empêche le “zoom auto” et aide à stabiliser l’affichage -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"/>
  <title>ViralFlowr | Mes commandes</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{ color-scheme: light; }
    html, body{
      width:100%;
      max-width:100%;
      overflow-x:hidden;            /* ✅ stop scroll horizontal */
      overscroll-behavior-x:none;   /* ✅ stop “glisse” latérale */
    }
    *{ box-sizing:border-box; }

    body{
      font-family:'Inter',sans-serif;
      background:#F3F3F3;
      color:#201B16;
      -webkit-text-size-adjust:100%;
      text-rendering:optimizeLegibility;
    }

    /* ✅ Conteneur “verrouillé” mobile (aucun débordement) */
    .page{
      width:100%;
      max-width:980px;
      margin:0 auto;
      padding:16px;
    }
    @media (min-width: 768px){
      .page{ padding:32px; }
    }

    .text-orange-bsv{ color:#F07E13; }
    .brand-gradient { background: linear-gradient(135deg, #F07E13 0%, #FFB26B 100%); }

    .card{
      background:#fff;
      border:1px solid #eee;
      border-radius:24px;
      box-shadow:0 10px 25px rgba(0,0,0,.06);
      width:100%;
      max-width:100%;
      overflow:hidden; /* ✅ empêche un enfant de pousser la carte */
    }

    .badge{
      font-size:10px;
      font-weight:900;
      letter-spacing:.08em;
      text-transform:uppercase;
      padding:6px 10px;
      border-radius:999px;
      max-width:100%;
    }

    /* ✅ Boutons mobiles qui “ne poussent pas” */
    .btn{
      height:44px;
      border-radius:16px;
      font-weight:900;
      font-size:12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:0 14px;
      max-width:100%;
      white-space:nowrap;
      flex:0 0 auto;
    }

    .btn-outline{
      border:1px solid #E5E7EB;
      background:#fff;
      color:#111827;
    }
    .btn-outline:hover{ border-color:#F07E13; color:#F07E13; }
    .btn-primary{ color:#fff; }
    .btn-primary:hover{ filter:brightness(.98); }

    /* ✅ Header mobile: wrap + pas de débordement */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;      /* ✅ wrap sur mobile */
      margin-bottom:18px;
    }
    .top-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;      /* ✅ wrap sur mobile */
      justify-content:flex-end;
      width:100%;
    }
    @media (min-width: 520px){
      .top-actions{ width:auto; }
    }

    /* ✅ Texte/IDs qui ne débordent jamais */
    .safe-text{
      min-width:0;
      overflow-wrap:anywhere;
      word-break:break-word;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%);
      background: rgba(17,24,39,.95);
      color: #fff;
      padding: 12px 14px;
      border-radius: 16px;
      font-weight: 800;
      font-size: 12px;
      letter-spacing: .04em;
      box-shadow: 0 10px 25px rgba(0,0,0,.18);
      z-index: 9999;
      max-width: min(92vw, 520px);
      display:none;
    }
    .toast.show{ display:block; animation: pop .18s ease-out; }
    @keyframes pop{
      from{ transform: translateX(-50%) translateY(8px); opacity:0 }
      to{ transform: translateX(-50%) translateY(0); opacity:1 }
    }

    /* ✅ Livraison: ne doit jamais créer un scroll horizontal */
    .delbox{
      background:#0b1220;
      color:#fff;
      border-radius:16px;
      padding:12px;
      font-size:12px;
      font-weight:800;
      letter-spacing:.02em;
      white-space:pre-wrap;
      overflow-wrap:anywhere;
      word-break:break-word;
      line-height:1.45;
      max-width:100%;
    }

    /* ✅ Empêche le bug “100vw + scrollbar” sur mobile */
    .fullw{ width:100%; max-width:100%; }
  </style>
</head>

<body>
  <div class="page">

    <div class="topbar">
      <a href="/index.html" class="inline-flex items-center gap-2">
        <span class="text-2xl font-black tracking-tighter safe-text">
          Viral<span class="text-orange-bsv">Flowr</span>
        </span>
      </a>

      <div class="top-actions">
        <a href="/index.html" class="btn btn-outline">Boutique</a>
        <a href="/wallet.html" class="btn btn-outline">Wallet</a>
        <button id="logoutBtn" class="btn btn-outline">Déconnexion</button>
      </div>
    </div>

    <div class="card p-6 md:p-8 mb-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div class="safe-text">
          <div class="text-[10px] font-black uppercase tracking-widest text-gray-400">Compte connecté</div>
          <div id="userEmail" class="text-lg font-black text-gray-900 safe-text">—</div>
          <div class="text-[12px] font-bold text-gray-500 mt-1 safe-text">
            Historique de tes commandes + bouton Recharger si disponible.
          </div>
        </div>
        <div class="flex gap-2 fullw md:w-auto">
          <button id="refreshBtn" class="btn brand-gradient btn-primary w-full md:w-auto">Actualiser</button>
        </div>
      </div>
    </div>

    <div id="stateBox" class="card p-6 md:p-8 text-center text-gray-500 font-bold">
      Chargement…
    </div>

    <div id="ordersWrap" class="hidden space-y-4"></div>

    <div class="mt-8 text-center">
      <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">© 2026 ViralFlowr • Historique commandes</p>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const GOOGLE_URL = "https://script.google.com/macros/s/AKfycbyCvuy-WiLMlAkBb7k6YyPVMk4lQhGGke05heSWSw--twKE2L-oVSOs884g3jn6lt6m/exec";

    function getSession_(){
      try{
        const raw = localStorage.getItem("vf_session");
        if(!raw) return null;
        const s = JSON.parse(raw);
        if(!s || !s.email) return null;
        return s;
      }catch{ return null; }
    }

    function toast(msg){
      const el = document.getElementById("toast");
      el.textContent = String(msg || "");
      el.classList.add("show");
      clearTimeout(window.__vf_toast_t);
      window.__vf_toast_t = setTimeout(()=> el.classList.remove("show"), 2200);
    }

    function jsonp_(params, onOk, onErr){
      const cb = "VF_CB_" + Date.now() + "_" + Math.floor(Math.random()*1000000);

      let done = false;
      const timer = setTimeout(() => {
        if (done) return;
        done = true;
        try { delete window[cb]; } catch(_){}
        onErr && onErr("TIMEOUT");
      }, 12000);

      window[cb] = function(payload){
        if (done) return;
        done = true;
        clearTimeout(timer);
        try { onOk(payload); }
        finally { try { delete window[cb]; } catch(_){} }
      };

      const s = document.createElement("script");
      const qs = new URLSearchParams({ ...params, callback: cb, t: String(Date.now()) });
      s.src = GOOGLE_URL + "?" + qs.toString();

      s.onerror = function(){
        if (done) return;
        done = true;
        clearTimeout(timer);
        try { delete window[cb]; } catch(_){}
        onErr && onErr("NETWORK");
      };

      document.body.appendChild(s);
    }

    function badgeForStatus_(st){
      const s = String(st||"").toUpperCase();
      if (s.includes("PAID") || s.includes("VALID") || s.includes("RECEIVED")) return ["bg-blue-100 text-blue-700","Paiement reçu"];
      if (s.includes("PENDING") || s.includes("ATTENTE")) return ["bg-yellow-100 text-yellow-700","En attente"];
      if (s.includes("PROCESS") || s.includes("TRAIT")) return ["bg-purple-100 text-purple-700","En traitement"];
      if (s.includes("DONE") || s.includes("SUCCESS") || s.includes("DELIVER")) return ["bg-green-100 text-green-700","Terminé"];
      if (s.includes("FAIL") || s.includes("REFUS") || s.includes("ERROR")) return ["bg-red-100 text-red-700","Erreur"];
      return ["bg-gray-100 text-gray-700", st || "—"];
    }

    function esc_(s){
      return String(s||"").replace(/[&<>"']/g, (c)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    function reasonRechargeOffClientSafe_(){
      return "Recharge indisponible pour cette commande.";
    }

    function buildReorderLink_(o){
      const idService = o && o.idService ? String(o.idService) : "";
      const orderId = o && (o.orderId || o.id) ? String(o.orderId || o.id) : "";
      const qs = new URLSearchParams({
        id: idService,
        reorder: "1",
        hide_desc: "1",
        orderId: orderId
      });
      return "/paiement.html?" + qs.toString();
    }

    async function copyText_(txt){
      const t = String(txt || "");
      try{
        if (navigator.clipboard && navigator.clipboard.writeText){
          await navigator.clipboard.writeText(t);
          toast("✅ Copié");
          return;
        }
      }catch(_){}
      const ta = document.createElement("textarea");
      ta.value = t;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.select();
      try { document.execCommand("copy"); toast("✅ Copié"); }
      catch(e){ toast("❌ Copie impossible"); }
      document.body.removeChild(ta);
    }

    function renderOrders_(orders){
      const stateBox = document.getElementById("stateBox");
      const wrap = document.getElementById("ordersWrap");

      if (!orders || !orders.length){
        wrap.classList.add("hidden");
        stateBox.classList.remove("hidden");
        stateBox.innerHTML = "Aucune commande trouvée pour ce compte.";
        return;
      }

      stateBox.classList.add("hidden");
      wrap.classList.remove("hidden");
      wrap.innerHTML = "";

      orders.forEach((o, idx) => {
        const orderId = String(o.orderId || o.id || "").trim();
        const [badgeCls, badgeTxt] = badgeForStatus_(o.status || o.statut);
        const canRecharge = !!(o.allowRecharge);
        const created = (o.createdAt || o.date) ? esc_(o.createdAt || o.date) : "—";

        const deliveryRaw = String(
          o.manualResponse || o.colM || o.delivery || o.reponse || o.response || ""
        );
        const hasDelivery = deliveryRaw.trim().length > 0;
        const isManual = (o && o.isManual === true) || (hasDelivery && !(o && o.isSmm === true));
        const showDelivery = isManual && hasDelivery;

        const deliveryId = "delivery_" + idx;
        const boxId = "box_" + idx;
        const btnId = "btn_" + idx;

        const card = document.createElement("div");
        card.className = "card p-6";

        card.innerHTML = `
          <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
            <div class="min-w-0 safe-text">
              <div class="flex flex-wrap items-center gap-2 safe-text">
                <span class="badge ${badgeCls}">${esc_(badgeTxt)}</span>
                <span class="text-[11px] font-black uppercase tracking-widest text-gray-400">Commande</span>
                <span class="text-[12px] font-black text-gray-900 safe-text">${esc_(orderId || "—")}</span>
              </div>

              <div class="mt-3 safe-text">
                <div class="text-lg font-black text-gray-900 leading-tight safe-text">${esc_(o.produit || "—")}</div>

                <div class="text-[12px] font-bold text-gray-500 mt-1 safe-text">
                  Cat: <span class="text-gray-700 font-black">${esc_(o.categorie || "—")}</span> •
                  Service: <span class="text-gray-700 font-black safe-text">${esc_(o.idService || "—")}</span>
                </div>

                <div class="text-[12px] font-bold text-gray-500 mt-1 safe-text">
                  Qté: <span class="text-gray-700 font-black">${Number(o.quantite||1)}</span> •
                  Total: <span class="text-gray-700 font-black">${Number(o.total||0).toFixed(2)} $</span> •
                  Paiement: <span class="text-gray-700 font-black safe-text">${esc_(o.payMethod || "—")}</span>
                </div>

                <div class="text-[12px] font-bold text-gray-500 mt-1 safe-text">
                  Date: <span class="text-gray-700 font-black safe-text">${created}</span>
                </div>

                ${o.rechargeCount ? `
                  <div class="text-[12px] font-bold text-gray-500 mt-1 safe-text">
                    Recharges: <span class="text-gray-700 font-black">${Number(o.rechargeCount||0)}</span>
                    ${o.lastRechargeAt ? ` • Dernière: <span class="text-gray-700 font-black safe-text">${esc_(o.lastRechargeAt)}</span>` : ""}
                  </div>
                ` : ""}

                ${!canRecharge ? `
                  <div class="text-[11px] font-black text-gray-400 mt-2 uppercase tracking-widest safe-text">
                    ${esc_(reasonRechargeOffClientSafe_())}
                  </div>
                ` : ""}

                ${showDelivery ? `
                  <div class="mt-4">
                    <div class="flex items-center justify-between gap-2 flex-wrap">
                      <div class="text-[10px] font-black uppercase tracking-widest text-gray-400">Livraison (commande manuelle)</div>
                      <button id="${btnId}" class="btn btn-outline h-[36px] text-[11px] px-3 w-full sm:w-auto">Voir</button>
                    </div>

                    <div id="${boxId}" class="mt-2 hidden">
                      <div id="${deliveryId}" class="delbox">${esc_(deliveryRaw)}</div>
                      <div class="mt-2 flex gap-2 flex-wrap">
                        <button class="btn btn-outline copyDeliveryBtn w-full sm:w-auto" data-target="${deliveryId}">Copier</button>
                      </div>
                    </div>
                  </div>
                ` : ""}
              </div>
            </div>

            <div class="flex flex-col gap-2 w-full md:w-[220px]">
              <button class="btn brand-gradient btn-primary rechargeBtn w-full ${canRecharge ? "" : "opacity-50 cursor-not-allowed"}"
                      data-order="${esc_(orderId)}"
                      ${canRecharge ? "" : "disabled"}>
                Recharger
              </button>

              <a class="btn btn-outline w-full" href="${buildReorderLink_(o)}">Recommander</a>
            </div>
          </div>
        `;

        wrap.appendChild(card);

        if (showDelivery){
          const btn = card.querySelector("#" + CSS.escape(btnId));
          const box = card.querySelector("#" + CSS.escape(boxId));
          if (btn && box){
            btn.addEventListener("click", () => {
              const isHidden = box.classList.contains("hidden");
              box.classList.toggle("hidden");
              btn.textContent = isHidden ? "Masquer" : "Voir";
            });
          }
        }
      });

      wrap.querySelectorAll(".rechargeBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          const orderId = btn.getAttribute("data-order");
          if (!orderId) return;

          btn.disabled = true;
          btn.textContent = "Rechargement…";

          const s = getSession_();
          const email = s && s.email ? String(s.email).trim().toLowerCase() : "";
          const token = s && s.token ? String(s.token) : "";

          jsonp_(
            { action: "order_recharge", email, token, orderId },
            (res) => {
              if (res && res.ok) {
                toast("✅ Recharge demandée !");
                loadOrders_();
              } else {
                toast("❌ Impossible: " + ((res && (res.message || res.error)) || "Erreur"));
                btn.disabled = false;
                btn.textContent = "Recharger";
              }
            },
            () => {
              toast("❌ Erreur réseau");
              btn.disabled = false;
              btn.textContent = "Recharger";
            }
          );
        });
      });

      wrap.querySelectorAll(".copyDeliveryBtn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-target");
          const el = id ? document.getElementById(id) : null;
          if (!el) return;
          await copyText_(el.textContent || "");
        });
      });
    }

    function loadOrders_(){
      const s = getSession_();
      const stateBox = document.getElementById("stateBox");
      const wrap = document.getElementById("ordersWrap");

      wrap.classList.add("hidden");
      stateBox.classList.remove("hidden");
      stateBox.innerHTML = "Chargement…";

      if (!s){
        stateBox.innerHTML = `
          <div class="text-gray-900 font-black text-lg">Tu n’es pas connecté.</div>
          <div class="text-gray-500 font-bold mt-2">Connecte-toi dans Wallet pour voir tes commandes.</div>
          <div class="mt-4">
            <a class="btn brand-gradient btn-primary w-full sm:w-auto" href="/wallet.html">Aller au Wallet</a>
          </div>
        `;
        return;
      }

      const email = String(s.email || "").trim().toLowerCase();
      const token = s && s.token ? String(s.token) : "";
      document.getElementById("userEmail").textContent = email;

      jsonp_(
        { action:"order_history", email, token, limit:"80" },
        (res) => {
          if (!res || !res.ok){
            stateBox.innerHTML = "Erreur: " + ((res && (res.error || res.message)) || "Impossible de charger l'historique.");
            return;
          }
          renderOrders_(res.orders || []);
        },
        () => {
          stateBox.innerHTML = "Erreur réseau: impossible de charger.";
        }
      );
    }

    document.getElementById("refreshBtn").addEventListener("click", loadOrders_);
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("vf_session");
      toast("Déconnecté.");
      loadOrders_();
    });

    loadOrders_();
  </script>
</body>
</html>
