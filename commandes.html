<!DOCTYPE html>
<html lang="fr" class="font-inter">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ViralFlowr | Mes commandes</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    body { font-family:'Inter',sans-serif; background:#F3F3F3; color:#201B16; }
    .text-orange-bsv{ color:#F07E13; }
    .brand-gradient { background: linear-gradient(135deg, #F07E13 0%, #FFB26B 100%); }
    .card { background:#fff; border:1px solid #eee; border-radius:24px; box-shadow:0 10px 25px rgba(0,0,0,.06); }
    .badge { font-size:10px; font-weight:900; letter-spacing:.08em; text-transform:uppercase; padding:6px 10px; border-radius:999px; }
    .btn { height:44px; border-radius:16px; font-weight:900; font-size:12px; letter-spacing:.08em; text-transform:uppercase; display:inline-flex; align-items:center; justify-content:center; padding:0 14px; }
    .btn-outline { border:1px solid #E5E7EB; background:#fff; color:#111827; }
    .btn-outline:hover { border-color:#F07E13; color:#F07E13; }
    .btn-primary { color:#fff; }
    .btn-primary:hover { filter:brightness(.98); }

    /* ✅ mini toast */
    .toast {
      position: fixed; left: 50%; bottom: 20px; transform: translateX(-50%);
      background: rgba(17,24,39,.95); color: #fff;
      padding: 12px 14px; border-radius: 16px;
      font-weight: 800; font-size: 12px; letter-spacing: .04em;
      box-shadow: 0 10px 25px rgba(0,0,0,.18);
      z-index: 9999;
      max-width: min(92vw, 520px);
      display:none;
    }
    .toast.show{ display:block; animation: pop .18s ease-out; }
    @keyframes pop{ from{ transform: translateX(-50%) translateY(8px); opacity:0 } to{ transform: translateX(-50%) translateY(0); opacity:1 } }
  </style>
</head>

<body class="p-4 md:p-8">
  <div class="max-w-[980px] mx-auto">

    <!-- Header -->
    <div class="flex items-center justify-between gap-3 mb-6">
      <a href="/index.html" class="inline-flex items-center gap-2">
        <span class="text-2xl font-black tracking-tighter">
          Viral<span class="text-orange-bsv">Flowr</span>
        </span>
      </a>
      <div class="flex items-center gap-2">
        <a href="/index.html" class="btn btn-outline">Boutique</a>
        <a href="/wallet.html" class="btn btn-outline">Wallet</a>
        <button id="logoutBtn" class="btn btn-outline">Déconnexion</button>
      </div>
    </div>

    <!-- Top card -->
    <div class="card p-6 md:p-8 mb-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <div class="text-[10px] font-black uppercase tracking-widest text-gray-400">Compte connecté</div>
          <div id="userEmail" class="text-lg font-black text-gray-900">—</div>
          <div class="text-[12px] font-bold text-gray-500 mt-1">
            Ici tu vois l’historique de tes commandes + bouton Recharger si disponible.
          </div>
        </div>
        <div class="flex gap-2">
          <button id="refreshBtn" class="btn brand-gradient btn-primary">Actualiser</button>
        </div>
      </div>
    </div>

    <!-- Orders list -->
    <div id="stateBox" class="card p-6 md:p-8 text-center text-gray-500 font-bold">
      Chargement…
    </div>

    <div id="ordersWrap" class="hidden space-y-4"></div>

    <div class="mt-8 text-center">
      <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">© 2026 ViralFlowr • Historique commandes</p>
    </div>
  </div>

  <!-- ✅ Toast -->
  <div id="toast" class="toast"></div>

  <script>
    const GOOGLE_URL = "https://script.google.com/macros/s/AKfycbyCvuy-WiLMlAkBb7k6YyPVMk4lQhGGke05heSWSw--twKE2L-oVSOs884g3jn6lt6m/exec";

    function getSession_(){
      try{
        const raw = localStorage.getItem("vf_session");
        if(!raw) return null;
        const s = JSON.parse(raw);
        if(!s || !s.email) return null;
        return s;
      }catch{ return null; }
    }

    // ✅ toast propre (remplace alert)
    function toast(msg){
      const el = document.getElementById("toast");
      el.textContent = String(msg || "");
      el.classList.add("show");
      clearTimeout(window.__vf_toast_t);
      window.__vf_toast_t = setTimeout(()=> el.classList.remove("show"), 2200);
    }

    function jsonp_(params, onOk, onErr){
      const cb = "VF_CB_" + Date.now() + "_" + Math.floor(Math.random()*1000000);
      window[cb] = function(payload){
        try { onOk(payload); }
        finally { try { delete window[cb]; } catch(_){} }
      };
      const s = document.createElement("script");
      const qs = new URLSearchParams({ ...params, callback: cb, t: String(Date.now()) });
      s.src = GOOGLE_URL + "?" + qs.toString();
      s.onerror = function(){
        try { delete window[cb]; } catch(_){}
        onErr && onErr();
      };
      document.body.appendChild(s);
    }

    function badgeForStatus_(st){
      const s = String(st||"").toUpperCase();
      if (s.includes("PAID") || s.includes("VALID") || s.includes("RECEIVED")) return ["bg-blue-100 text-blue-700","Paiement reçu"];
      if (s.includes("PENDING") || s.includes("ATTENTE")) return ["bg-yellow-100 text-yellow-700","En attente"];
      if (s.includes("PROCESS") || s.includes("TRAIT")) return ["bg-purple-100 text-purple-700","En traitement"];
      if (s.includes("DONE") || s.includes("SUCCESS") || s.includes("DELIVER")) return ["bg-green-100 text-green-700","Terminé"];
      if (s.includes("FAIL") || s.includes("REFUS") || s.includes("ERROR")) return ["bg-red-100 text-red-700","Erreur"];
      return ["bg-gray-100 text-gray-700", st || "—"];
    }

    function esc_(s){
      return String(s||"").replace(/[&<>"']/g, (c)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    // ✅ Texte sous le bouton quand recharge désactivée
    function reasonRechargeOff_(o){
      if (!o) return "Recharge indisponible.";
      if (!o.allowRecharge) return "Recharge non disponible pour ce service.";
      if (!o.fournisseurOrderId) return "ID fournisseur manquant (commande non envoyée au panel).";
      return "Recharge indisponible.";
    }

    function renderOrders_(orders){
      const stateBox = document.getElementById("stateBox");
      const wrap = document.getElementById("ordersWrap");

      if (!orders || !orders.length){
        wrap.classList.add("hidden");
        stateBox.classList.remove("hidden");
        stateBox.innerHTML = "Aucune commande trouvée pour ce compte.";
        return;
      }

      stateBox.classList.add("hidden");
      wrap.classList.remove("hidden");
      wrap.innerHTML = "";

      orders.forEach(o => {
        const [badgeCls, badgeTxt] = badgeForStatus_(o.status);

        // ✅ recharge seulement si allowRecharge + id fournisseur
        const canRecharge = !!(o.allowRecharge && o.fournisseurOrderId);
        const created = o.createdAt ? esc_(o.createdAt) : "—";

        const card = document.createElement("div");
        card.className = "card p-6";

        card.innerHTML = `
          <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
            <div class="min-w-0">
              <div class="flex flex-wrap items-center gap-2">
                <span class="badge ${badgeCls}">${esc_(badgeTxt)}</span>
                <span class="text-[11px] font-black uppercase tracking-widest text-gray-400">Commande</span>
                <span class="text-[12px] font-black text-gray-900">${esc_(o.orderId)}</span>
              </div>

              <div class="mt-3">
                <div class="text-lg font-black text-gray-900 leading-tight">${esc_(o.produit || "—")}</div>

                <div class="text-[12px] font-bold text-gray-500 mt-1">
                  Cat: <span class="text-gray-700 font-black">${esc_(o.categorie || "—")}</span> •
                  Service: <span class="text-gray-700 font-black">${esc_(o.idService || "—")}</span>
                </div>

                <div class="text-[12px] font-bold text-gray-500 mt-1">
                  Qté: <span class="text-gray-700 font-black">${Number(o.quantite||1)}</span> •
                  Total: <span class="text-gray-700 font-black">${Number(o.total||0).toFixed(2)} $</span> •
                  Paiement: <span class="text-gray-700 font-black">${esc_(o.payMethod || "—")}</span>
                </div>

                <div class="text-[12px] font-bold text-gray-500 mt-1">
                  Date: <span class="text-gray-700 font-black">${created}</span>
                </div>

                <div class="text-[12px] font-bold text-gray-500 mt-2">
                  Fournisseur: <span class="text-gray-700 font-black">${esc_(o.fournisseur || "—")}</span>
                  ${o.fournisseurOrderId ? ` • ID fournisseur: <span class="text-gray-700 font-black">${esc_(o.fournisseurOrderId)}</span>` : ""}
                </div>

                ${o.rechargeCount ? `
                  <div class="text-[12px] font-bold text-gray-500 mt-1">
                    Recharges: <span class="text-gray-700 font-black">${Number(o.rechargeCount||0)}</span>
                    ${o.lastRechargeAt ? ` • Dernière: <span class="text-gray-700 font-black">${esc_(o.lastRechargeAt)}</span>` : ""}
                  </div>
                ` : ""}

                ${!canRecharge ? `
                  <div class="text-[11px] font-black text-gray-400 mt-2 uppercase tracking-widest">
                    ${esc_(reasonRechargeOff_(o))}
                  </div>
                ` : ""}
              </div>
            </div>

            <div class="flex flex-col gap-2 w-full md:w-[220px]">
              <button class="btn brand-gradient btn-primary rechargeBtn ${canRecharge ? "" : "opacity-50 cursor-not-allowed"}"
                      data-order="${esc_(o.orderId)}"
                      ${canRecharge ? "" : "disabled"}>
                Recharger
              </button>
              <a class="btn btn-outline" href="/paiement.html?id=${encodeURIComponent(o.idService || "")}">Recommander</a>
            </div>
          </div>
        `;

        wrap.appendChild(card);
      });

      // Bind recharge buttons
      wrap.querySelectorAll(".rechargeBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          const orderId = btn.getAttribute("data-order");
          if (!orderId) return;

          btn.disabled = true;
          btn.textContent = "Rechargement…";

          const s = getSession_();
          const email = s && s.email ? String(s.email).trim().toLowerCase() : "";
          const token = s && s.token ? String(s.token) : ""; // ✅ si tu as un token côté wallet

          jsonp_(
            { action: "order_recharge", email, token, orderId },
            (res) => {
              if (res && res.ok) {
                toast("✅ Recharge demandée ! (refillId: " + (res.refillId || "OK") + ")");
                loadOrders_(); // refresh
              } else {
                toast("❌ Impossible: " + ((res && (res.message || res.error)) || "Erreur"));
                btn.disabled = false;
                btn.textContent = "Recharger";
              }
            },
            () => {
              toast("❌ Erreur réseau");
              btn.disabled = false;
              btn.textContent = "Recharger";
            }
          );
        });
      });
    }

    function loadOrders_(){
      const s = getSession_();
      const stateBox = document.getElementById("stateBox");
      const wrap = document.getElementById("ordersWrap");

      wrap.classList.add("hidden");
      stateBox.classList.remove("hidden");
      stateBox.innerHTML = "Chargement…";

      if (!s){
        stateBox.innerHTML = `
          <div class="text-gray-900 font-black text-lg">Tu n’es pas connecté.</div>
          <div class="text-gray-500 font-bold mt-2">Connecte-toi dans Wallet pour voir tes commandes.</div>
          <div class="mt-4">
            <a class="btn brand-gradient btn-primary" href="/wallet.html">Aller au Wallet</a>
          </div>
        `;
        return;
      }

      const email = String(s.email || "").trim().toLowerCase();
      const token = s && s.token ? String(s.token) : ""; // ✅ si tu as un token côté wallet
      document.getElementById("userEmail").textContent = email;

      jsonp_(
        { action:"order_history", email, token, limit:"80" },
        (res) => {
          if (!res || !res.ok){
            stateBox.innerHTML = "Erreur: " + ((res && (res.error || res.message)) || "Impossible de charger l'historique.");
            return;
          }
          renderOrders_(res.orders || []);
        },
        () => {
          stateBox.innerHTML = "Erreur réseau: impossible de charger.";
        }
      );
    }

    // Buttons
    document.getElementById("refreshBtn").addEventListener("click", loadOrders_);
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("vf_session");
      toast("Déconnecté.");
      loadOrders_();
    });

    // Start
    loadOrders_();
  </script>
</body>
</html>
