<!DOCTYPE html>
<html lang="fr" class="font-inter">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Portefeuille | ViralFlowr</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #F3F3F3; color: #201B16; overflow-x:hidden; }
    .text-orange-bsv { color: #F07E13; }
    .brand-gradient { background: linear-gradient(90deg, #F07E13 0%, #FFB26B 100%); }
    .brand-gradient:hover { background: linear-gradient(90deg, #d96d0c 0%, #F07E13 100%); }
    .card { background:#fff; border:1px solid #eee; border-radius:24px; box-shadow: 0 12px 25px rgba(0,0,0,.06); }
    .pill { border-radius: 999px; }
    .icon-btn{
      display:flex; align-items:center; justify-content:center;
      width:40px; height:40px; border-radius:14px;
      background:#fff; border:1px solid #E5E7EB; color:#374151;
      transition:.2s;
    }
    .icon-btn:hover{ border-color:#F07E13; color:#F07E13; transform:translateY(-1px); }
    .vf-brand-wrap{ min-width:0; overflow:hidden; }
    .vf-brand-text{
      display:block; max-width:100%;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; line-height:1;
    }
    .muted { color:#8A8A8A; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .btn {
      height: 44px; padding: 0 16px; border-radius: 14px;
      font-weight: 900; font-size: 12px; letter-spacing:.08em;
      text-transform: uppercase; transition: .2s; display:inline-flex; align-items:center; justify-content:center; gap:10px;
      white-space: nowrap;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn-outline { background:#fff; border:1px solid #E5E7EB; color:#111827; }
    .btn-outline:hover { border-color:#F07E13; color:#F07E13; }
    .btn-primary { color:#fff; }
    .box-note { border:2px dashed #E5E7EB; border-radius: 22px; background: #FBFBFB; }
    .small { font-size: 12px; }
  </style>
</head>

<body class="min-h-screen flex flex-col">

  <!-- HEADER -->
  <header class="bg-white sticky top-0 w-full z-50 border-b border-gray-200 shadow-sm">
    <div class="max-w-[1240px] mx-auto h-16 px-4 flex items-center justify-between gap-4">
      <a class="flex items-center gap-2 shrink-0 vf-brand-wrap" href="index.html" aria-label="ViralFlowr">
        <div class="text-2xl font-black tracking-tighter vf-brand-text">
          Viral<span class="text-orange-bsv">Flowr</span>
        </div>
      </a>

      <div class="flex items-center gap-2">
        <a href="index.html" class="btn btn-outline hidden sm:inline-flex">Boutique</a>
        <a href="wallet.html" class="icon-btn" title="Portefeuille" aria-label="Portefeuille">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 7H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h13a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2Z"/>
            <path d="M16 7V5a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v2"/>
            <path d="M20 12h-4a2 2 0 0 0 0 4h4"/>
            <circle cx="16" cy="14" r="0.5" />
          </svg>
        </a>
      </div>
    </div>
  </header>

  <main class="flex-1 p-4">
    <div class="max-w-[860px] mx-auto">

      <div class="text-center mt-6 mb-4">
        <div class="text-3xl font-black tracking-tighter">Portefeuille <span class="text-orange-bsv">ViralFlowr</span></div>
        <div class="text-[11px] font-black uppercase tracking-[.2em] text-gray-300 mt-1">Dépôt • Crédit • Paiement instantané</div>
      </div>

      <!-- ALERT -->
      <div id="alertBox" class="hidden mb-4 px-4 py-3 rounded-2xl border text-sm font-bold"></div>

      <!-- CARD -->
      <section class="card p-6 md:p-8">

        <!-- TOP ROW -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <div class="text-[11px] font-black uppercase tracking-[.18em] text-gray-300">Solde (USD)</div>
            <div class="text-4xl font-black tracking-tighter mt-1">
              <span id="balanceValue">—</span><span class="text-gray-300 ml-1">$</span>
            </div>
            <div class="mt-2 small font-bold">
              <span class="muted">Compte:</span> <span id="userLabel">—</span>
            </div>
          </div>

          <div class="flex items-center gap-2">
            <button id="refreshBtn" class="btn btn-outline">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <path d="M21 12a9 9 0 1 1-3-6.7"/><path d="M21 3v7h-7"/>
              </svg>
              Actualiser
            </button>

            <button id="logoutBtn" class="btn btn-outline">
              Déconnexion
            </button>
          </div>
        </div>

        <!-- WHY DEPOSIT -->
        <div class="mt-6 p-4 rounded-2xl bg-[#FFF7EE] border border-[#FFD7B0]">
          <div class="font-black text-[12px] uppercase tracking-[.18em] text-[#B65E0B]">Pourquoi déposer de l’argent ?</div>
          <ul class="mt-2 text-[13px] font-semibold text-[#3B2A16] leading-relaxed list-disc pl-5">
            <li>Tu ajoutes du <b>crédit</b> dans ton wallet.</li>
            <li>Après ça, tu peux payer les commandes <b>instantanément</b> sans refaire de paiement à chaque fois.</li>
            <li>Ton solde se met à jour après validation / synchronisation (Binance Pay ou Mobile Money via WhatsApp).</li>
          </ul>
        </div>

        <!-- NOTE -->
        <div class="mt-6 box-note p-5">
          <div class="text-[10px] font-black uppercase tracking-[.22em] text-gray-300 text-center">Note de dépôt (important)</div>
          <div class="text-center text-2xl md:text-3xl font-black tracking-tight mt-2 mono" id="topupNote">TOPUP-—</div>

          <div class="flex items-center justify-center gap-2 mt-3">
            <button id="copyNoteBtn" class="btn btn-outline">
              Copier la note
            </button>
          </div>

          <div class="mt-3 text-center text-[12px] font-bold text-gray-500">
            ⚠️ Mets cette <b>NOTE</b> dans Binance (“Note / Message”) ou dans ton message WhatsApp (Mobile Money) pour t’identifier.
          </div>
        </div>

        <!-- PAY METHODS -->
        <div class="mt-6">
          <div class="text-[11px] font-black uppercase tracking-[.18em] text-gray-300 mb-3">Moyens disponibles</div>

          <!-- BINANCE PAY -->
          <div class="p-4 rounded-2xl bg-[#0B0F14] text-white">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-[10px] font-black uppercase tracking-[.2em] text-gray-400">Binance Pay (ID)</div>
                <div class="text-xl font-black mt-1 mono" id="binanceId">744370418</div>
                <div class="text-[12px] font-semibold text-gray-400 mt-2">
                  ✅ Mets la NOTE ci-dessus dans “Note/Message” pendant le paiement.
                </div>
              </div>
              <button id="copyBinanceBtn" class="btn btn-outline" style="background:#111827;color:white;border-color:#1F2937">
                Copier
              </button>
            </div>
          </div>

          <!-- USDT TRC20 -->
          <div class="mt-3 p-4 rounded-2xl bg-white border border-gray-200">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-[10px] font-black uppercase tracking-[.2em] text-gray-300">USDT (TRC-20)</div>
                <div class="text-[13px] font-black mt-1 mono break-all" id="usdtAddr">
                  TN6c8PcWF1TU2XKPFDsGHw1fgen1MTRGka
                </div>
                <div class="text-[12px] font-semibold text-gray-400 mt-2">
                  ✅ Envoie USDT puis contacte WhatsApp avec la NOTE.
                </div>
              </div>
              <button id="copyUsdtBtn" class="btn btn-outline">
                Copier
              </button>
            </div>
          </div>

          <!-- MOBILE MONEY (NO PROOF) -->
          <div class="mt-3 p-4 rounded-2xl bg-white border border-gray-200">
            <div class="flex items-start justify-between gap-3 flex-col md:flex-row">
              <div>
                <div class="text-[10px] font-black uppercase tracking-[.2em] text-gray-300">Mobile Money (sans preuve)</div>
                <div class="text-[13px] font-semibold text-gray-600 mt-2 leading-relaxed">
                  Si tu veux déposer via <b>Orange Money</b>, <b>Airtel Money</b> ou <b>Wave</b> :
                  clique un bouton WhatsApp et envoie le message pré-rempli avec ta NOTE.
                </div>
              </div>

              <div class="flex flex-col gap-2 w-full md:w-[260px]">
                <a id="waOrange" target="_blank" rel="noopener" class="btn brand-gradient btn-primary w-full">
                  Orange Money
                </a>
                <a id="waAirtel" target="_blank" rel="noopener" class="btn brand-gradient btn-primary w-full">
                  Airtel Money
                </a>
                <a id="waWave" target="_blank" rel="noopener" class="btn brand-gradient btn-primary w-full">
                  Wave
                </a>
              </div>
            </div>
          </div>
        </div>

        <!-- HISTORY -->
        <div class="mt-7">
          <div class="flex items-center justify-between">
            <div class="text-[11px] font-black uppercase tracking-[.18em] text-gray-300">Historique</div>
            <button id="refreshTxBtn" class="btn btn-outline" style="height:38px;padding:0 12px;font-size:11px;">
              Rafraîchir
            </button>
          </div>

          <div id="txBox" class="mt-3 rounded-2xl border border-gray-200 bg-white overflow-hidden">
            <div class="p-4 text-sm font-bold text-gray-400">Chargement…</div>
          </div>
        </div>

      </section>
    </div>
  </main>

  <footer class="bg-white border-t border-gray-200 py-8">
    <div class="max-w-[1240px] mx-auto px-4 text-center">
      <p class="text-[11px] text-[#767676]">© 2026 ViralFlowr. Tous droits réservés.</p>
    </div>
  </footer>

  <script>
    // ✅ JSONP (évite CORS) + même logique session que tes pages
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyCvuy-WiLMlAkBb7k6YyPVMk4lQhGGke05heSWSw--twKE2L-oVSOs884g3jn6lt6m/exec";

    const alertBox = document.getElementById("alertBox");
    const balanceValue = document.getElementById("balanceValue");
    const userLabel = document.getElementById("userLabel");
    const topupNoteEl = document.getElementById("topupNote");
    const txBox = document.getElementById("txBox");

    const BINANCE_PAY_ID = "744370418";
    const USDT_TRC20_ADDR = "TN6c8PcWF1TU2XKPFDsGHw1fgen1MTRGka";
    const SUPPORT_WA = "243850373991"; // sans +

    function showAlert(msg, type="info"){
      alertBox.classList.remove("hidden");
      alertBox.classList.remove("bg-green-50","text-green-700","border-green-200","bg-red-50","text-red-700","border-red-200","bg-gray-50","text-gray-700","border-gray-200");
      if (type==="success") alertBox.classList.add("bg-green-50","text-green-700","border-green-200");
      else if (type==="error") alertBox.classList.add("bg-red-50","text-red-700","border-red-200");
      else alertBox.classList.add("bg-gray-50","text-gray-700","border-gray-200");
      alertBox.textContent = msg;
    }
    function hideAlert(){ alertBox.classList.add("hidden"); alertBox.textContent=""; }

    function getSession_(){
      try{
        const raw = localStorage.getItem("vf_session"); // ✅ ton même nom
        if(!raw) return null;
        const s = JSON.parse(raw);
        if(!s || !s.email) return null;
        return s;
      }catch{ return null; }
    }

    function ensureTopupNote_(email){
      // Note stable par session (stockée)
      const k = "vf_topup_note_" + String(email||"").toLowerCase();
      let note = localStorage.getItem(k);
      if(!note){
        note = "TOPUP-" + Date.now() + "-" + Math.floor(1000 + Math.random()*9000);
        localStorage.setItem(k, note);
      }
      topupNoteEl.textContent = note;
      return note;
    }

    function copyText_(text){
      const t = String(text||"").trim();
      if(!t) return;
      navigator.clipboard?.writeText(t).then(()=> {
        showAlert("Copié ✅", "success");
        setTimeout(hideAlert, 900);
      }).catch(()=>{
        // fallback
        const ta = document.createElement("textarea");
        ta.value = t;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        showAlert("Copié ✅", "success");
        setTimeout(hideAlert, 900);
      });
    }

    function jsonp_(params, onOk, onErr){
      const cb = "vf_cb_" + Date.now() + "_" + Math.floor(Math.random()*1000000);
      window[cb] = function(payload){
        try { onOk(payload); }
        finally { try { delete window[cb]; } catch(_){} }
      };

      const s = document.createElement("script");
      const qs = new URLSearchParams({ ...params, callback: cb, t: String(Date.now()) });
      s.src = SCRIPT_URL + "?" + qs.toString();
      s.onerror = function(){
        try { delete window[cb]; } catch(_){}
        onErr && onErr();
      };
      document.body.appendChild(s);
    }

    function fmt2(n){
      const x = Number(n||0);
      if(!isFinite(x)) return "0.00";
      return x.toFixed(2);
    }

    function renderTx_(list){
      if(!Array.isArray(list) || list.length===0){
        txBox.innerHTML = `<div class="p-4 text-sm font-bold text-gray-400">Aucune transaction.</div>`;
        return;
      }

      txBox.innerHTML = `
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-gray-50">
              <tr class="text-left text-[11px] uppercase tracking-widest text-gray-400 font-black">
                <th class="p-3">Date</th>
                <th class="p-3">Type</th>
                <th class="p-3">Montant</th>
                <th class="p-3">Ref</th>
              </tr>
            </thead>
            <tbody>
              ${list.map(tx => `
                <tr class="border-t">
                  <td class="p-3 font-bold text-gray-500">${tx.created_at || "-"}</td>
                  <td class="p-3 font-black ${String(tx.type||"").toUpperCase()==="CREDIT" ? "text-green-700" : "text-red-700"}">${tx.type || "-"}</td>
                  <td class="p-3 font-black text-gray-900">${fmt2(tx.amount)} $</td>
                  <td class="p-3 font-semibold text-gray-400">${tx.ref || ""}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      `;
    }

    function loadWallet_(email){
      balanceValue.textContent = "—";
      jsonp_( { action:"wallet_get", email: email, currency:"USD" },
        (res) => {
          if(res && res.ok){
            balanceValue.textContent = fmt2(res.balance);
            hideAlert();
          }else{
            showAlert("Impossible de charger le solde. (" + (res?.error || "ERREUR") + ")", "error");
            balanceValue.textContent = "0.00";
          }
        },
        () => {
          showAlert("Erreur réseau/API: solde non chargé.", "error");
          balanceValue.textContent = "0.00";
        }
      );
    }

    function loadTx_(email){
      txBox.innerHTML = `<div class="p-4 text-sm font-bold text-gray-400">Chargement…</div>`;
      jsonp_(
        { action:"wallet_tx", email: email, currency:"USD", limit:"50" },
        (res) => {
          if(res && res.ok){
            renderTx_(res.items || []);
          }else{
            txBox.innerHTML = `<div class="p-4 text-sm font-bold text-gray-400">Historique indisponible (${res?.error || "ERREUR"}).</div>`;
          }
        },
        () => {
          txBox.innerHTML = `<div class="p-4 text-sm font-bold text-gray-400">Erreur réseau/API: historique non chargé.</div>`;
        }
      );
    }

    // INIT
    (function(){
      document.getElementById("binanceId").textContent = BINANCE_PAY_ID;
      document.getElementById("usdtAddr").textContent = USDT_TRC20_ADDR;

      const s = getSession_();
      if(!s){
        showAlert("Connecte-toi d’abord pour utiliser le wallet.", "error");
        userLabel.textContent = "Non connecté";
        balanceValue.textContent = "—";
        txBox.innerHTML = `<div class="p-4 text-sm font-bold text-gray-400">Connecte-toi pour voir ton solde.</div>`;
        return;
      }

      // ✅ Ici on considère l’utilisateur connecté (plus de faux message)
      const email = String(s.email || "").trim().toLowerCase();
      userLabel.textContent = email;

      const note = ensureTopupNote_(email);

      // WhatsApp prefill (Mobile Money)
      const baseMsg =
        `Bonjour, je veux déposer du crédit sur mon wallet ViralFlowr.%0A` +
        `Email: ${encodeURIComponent(email)}%0A` +
        `NOTE: ${encodeURIComponent(note)}%0A` +
        `Montant (USD): ____%0A` +
        `Méthode: ____%0A` +
        `Merci.`;

      document.getElementById("waOrange").href = `https://wa.me/${SUPPORT_WA}?text=${baseMsg.replace("Méthode:%20____","Méthode:%20ORANGE%20MONEY")}`;
      document.getElementById("waAirtel").href = `https://wa.me/${SUPPORT_WA}?text=${baseMsg.replace("Méthode:%20____","Méthode:%20AIRTEL%20MONEY")}`;
      document.getElementById("waWave").href   = `https://wa.me/${SUPPORT_WA}?text=${baseMsg.replace("Méthode:%20____","Méthode:%20WAVE")}`;

      // Load data
      loadWallet_(email);
      loadTx_(email);

      // Buttons
      document.getElementById("refreshBtn").addEventListener("click", () => loadWallet_(email));
      document.getElementById("refreshTxBtn").addEventListener("click", () => loadTx_(email));

      document.getElementById("logoutBtn").addEventListener("click", () => {
        localStorage.removeItem("vf_session");
        location.href = "login.html";
      });

      document.getElementById("copyNoteBtn").addEventListener("click", () => copyText_(note));
      document.getElementById("copyBinanceBtn").addEventListener("click", () => copyText_(BINANCE_PAY_ID));
      document.getElementById("copyUsdtBtn").addEventListener("click", () => copyText_(USDT_TRC20_ADDR));
    })();
  </script>

</body>
</html>
