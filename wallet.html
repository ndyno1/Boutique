<!DOCTYPE html>
<html lang="fr" class="font-inter">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>Portefeuille | ViralFlowr</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{ color-scheme: light; }
    html, body{ width:100%; max-width:100%; overflow-x:hidden; overscroll-behavior-x:none; }
    *{ box-sizing:border-box; }

    body{
      font-family:'Inter',sans-serif;
      background:#F3F3F3;
      color:#201B16;
      -webkit-text-size-adjust:100%;
      text-rendering:optimizeLegibility;
    }

    .text-orange-bsv{ color:#F07E13; }
    .brand-gradient{ background: linear-gradient(90deg, #F07E13 0%, #FFB26B 100%); }
    .brand-gradient:hover{ filter: brightness(.98); }

    .card{
      background:#fff;
      border:1px solid #eee;
      border-radius:24px;
      box-shadow: 0 12px 25px rgba(0,0,0,.06);
      overflow:hidden;
    }

    .vf-brand-wrap{ min-width:0; overflow:hidden; }
    .vf-brand-text{
      display:block; max-width:100%;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      line-height:1;
    }

    .muted{ color:#8A8A8A; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    /* Buttons */
    .btn{
      height:44px;
      padding:0 16px;
      border-radius:14px;
      font-weight:900;
      font-size:12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      transition:.2s;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      white-space:nowrap;
      -webkit-tap-highlight-color:transparent;
      flex:0 0 auto;
      max-width:100%;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; transform:none; }
    .btn-outline{ background:#fff; border:1px solid #E5E7EB; color:#111827; }
    .btn-outline:hover{ border-color:#F07E13; color:#F07E13; }
    .btn-primary{ color:#fff; }

    .icon-btn{
      display:flex; align-items:center; justify-content:center;
      width:44px; height:44px; border-radius:14px;
      background:#fff; border:1px solid #E5E7EB; color:#374151;
      transition:.2s;
      -webkit-tap-highlight-color:transparent;
      flex:0 0 auto;
    }
    .icon-btn:hover{ border-color:#F07E13; color:#F07E13; transform:translateY(-1px); }
    .icon-btn:disabled{ opacity:.6; cursor:not-allowed; transform:none; }

    .box-note{ border:2px dashed #E5E7EB; border-radius: 22px; background: #FBFBFB; }
    .small{ font-size: 12px; }

    .input{
      width:100%;
      height:44px;
      padding:0 14px;
      border-radius:14px;
      background:#fff;
      border:1px solid #E5E7EB;
      outline:none;
      font-weight:800;
      font-size:13px;
      transition:.2s;
    }
    .input:focus{ border-color:#F07E13; box-shadow:0 6px 16px rgba(240,126,19,.10); }

    .select{ appearance:none; }

    /* Sticky header */
    header{
      background:#fff;
      position:sticky;
      top:0;
      z-index:50;
      border-bottom:1px solid #E5E7EB;
      box-shadow:0 6px 14px rgba(0,0,0,.04);
    }

    .topbar{
      max-width:1240px;
      margin:0 auto;
      height:64px;
      padding:0 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .top-actions{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
    }

    /* On very small screens: allow actions to scroll instead of overflow */
    @media (max-width: 420px){
      .top-actions{
        max-width: 62vw;
        overflow-x:auto;
        -webkit-overflow-scrolling:touch;
        padding-bottom:2px;
      }
      .top-actions::-webkit-scrollbar{ display:none; }
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:20px;
      transform:translateX(-50%);
      background: rgba(17,24,39,.95);
      color:#fff;
      padding:12px 14px;
      border-radius:16px;
      font-weight:900;
      font-size:12px;
      letter-spacing:.04em;
      box-shadow:0 10px 25px rgba(0,0,0,.18);
      z-index:9999;
      max-width:min(92vw, 520px);
      display:none;
    }
    .toast.show{ display:block; animation: pop .18s ease-out; }
    @keyframes pop{
      from{ transform: translateX(-50%) translateY(8px); opacity:0 }
      to{ transform: translateX(-50%) translateY(0); opacity:1 }
    }

    /* Skeleton (faster perceived load) */
    .skeleton{
      position:relative;
      overflow:hidden;
      background:#f3f4f6;
      border-radius:12px;
    }
    .skeleton::after{
      content:"";
      position:absolute;
      top:0; left:-60%;
      width:60%;
      height:100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.55), transparent);
      animation: shimmer 1.1s infinite;
    }
    @keyframes shimmer{
      0%{ left:-60%; }
      100%{ left:120%; }
    }

    .kpi-line{
      display:flex;
      align-items:baseline;
      gap:8px;
      flex-wrap:wrap;
    }

    .mono-box{
      white-space:pre-wrap;
      word-break:break-word;
      overflow-wrap:anywhere;
    }
  </style>
</head>

<body class="min-h-screen flex flex-col">

  <header>
    <div class="topbar">
      <a class="flex items-center gap-2 shrink-0 vf-brand-wrap" href="index.html" aria-label="ViralFlowr">
        <div class="text-2xl font-black tracking-tighter vf-brand-text">
          Viral<span class="text-orange-bsv">Flowr</span>
        </div>
      </a>

      <div class="top-actions">
        <!-- Mobile icons -->
        <a href="index.html" class="icon-btn sm:hidden" title="Boutique" aria-label="Boutique">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 11l9-8 9 8"></path>
            <path d="M9 22V12h6v10"></path>
          </svg>
        </a>

        <a href="transactions.html" class="icon-btn sm:hidden" title="Transactions" aria-label="Transactions">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 3v6h6"></path>
            <path d="M21 21v-6h-6"></path>
            <path d="M21 9a9 9 0 0 0-15.3-6.3L3 9"></path>
            <path d="M3 15a9 9 0 0 0 15.3 6.3L21 15"></path>
          </svg>
        </a>

        <a href="wallet.html" class="icon-btn sm:hidden" title="Portefeuille" aria-label="Portefeuille">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 7H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h13a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2Z"/>
            <path d="M16 7V5a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v2"/>
            <path d="M20 12h-4a2 2 0 0 0 0 4h4"/>
            <circle cx="16" cy="14" r="0.5" />
          </svg>
        </a>

        <button id="logoutBtnIcon" class="icon-btn sm:hidden" type="button" title="Déconnexion" aria-label="Déconnexion">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
            <path d="M10 17l5-5-5-5"></path>
            <path d="M15 12H3"></path>
          </svg>
        </button>

        <!-- Desktop text -->
        <a href="index.html" class="btn btn-outline hidden sm:inline-flex">Boutique</a>
        <a href="transactions.html" class="btn btn-outline hidden sm:inline-flex">Transactions</a>
        <a href="wallet.html" class="btn btn-outline hidden sm:inline-flex">Wallet</a>
        <button id="logoutBtn" class="btn btn-outline hidden sm:inline-flex" type="button">Déconnexion</button>
      </div>
    </div>
  </header>

  <main class="flex-1 p-4">
    <div class="max-w-[860px] mx-auto">

      <div class="text-center mt-6 mb-4">
        <div class="text-3xl font-black tracking-tighter">Portefeuille <span class="text-orange-bsv">ViralFlowr</span></div>
        <div class="text-[11px] font-black uppercase tracking-[.2em] text-gray-300 mt-1">Dépôt • Crédit • Paiement instantané</div>
      </div>

      <div id="alertBox" class="hidden mb-4 px-4 py-3 rounded-2xl border text-sm font-bold"></div>

      <section class="card p-6 md:p-8">

        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <div class="text-[11px] font-black uppercase tracking-[.18em] text-gray-300">
              Solde (<span id="balanceCurrencyLabel">USD</span>)
            </div>

            <div class="kpi-line mt-1">
              <div class="text-4xl font-black tracking-tighter">
                <span id="balanceValue" class="inline-block">—</span><span id="balanceCurrencySym" class="text-gray-300 ml-1">$</span>
              </div>
              <div class="text-[11px] font-extrabold text-gray-400">
                <span id="lastUpdated">—</span>
              </div>
            </div>

            <div class="mt-2 small font-bold">
              <span class="muted">Compte:</span> <span id="userLabel">—</span>
            </div>
            <div id="authModeLine" class="mt-1 text-[11px] font-extrabold text-gray-400 hidden"></div>
          </div>

          <div class="flex items-center gap-2 flex-wrap">
            <button id="refreshBtn" class="btn btn-outline" type="button">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <path d="M21 12a9 9 0 1 1-3-6.7"/><path d="M21 3v7h-7"/>
              </svg>
              Actualiser
            </button>
            <button id="logoutBtnInline" class="btn btn-outline sm:hidden" type="button">Déconnexion</button>
          </div>
        </div>

        <div class="mt-6 p-4 rounded-2xl bg-[#FFF7EE] border border-[#FFD7B0]">
          <div class="font-black text-[12px] uppercase tracking-[.18em] text-[#B65E0B]">Pourquoi déposer de l’argent ?</div>
          <ul class="mt-2 text-[13px] font-semibold text-[#3B2A16] leading-relaxed list-disc pl-5">
            <li>Tu ajoutes du crédit dans ton wallet.</li>
            <li>Après ça, tu peux payer les commandes instantanément sans refaire de paiement.</li>
            <li>Moneroo = paiement Mobile Money + redirection automatique vers la page de paiement.</li>
            <li>Dépôt manuel (Binance/USDT) = WhatsApp avec un message déjà rempli.</li>
          </ul>
        </div>

        <div class="mt-6 box-note p-5">
          <div class="text-[10px] font-black uppercase tracking-[.22em] text-gray-300 text-center">Note de dépôt (important)</div>
          <div class="text-center text-2xl md:text-3xl font-black tracking-tight mt-2 mono" id="topupNote">TOPUP-—</div>

          <div class="flex flex-wrap items-center justify-center gap-2 mt-3">
            <button id="copyNoteBtn" class="btn btn-outline" type="button">Copier la note</button>
            <button id="newNoteBtn" class="btn btn-outline" type="button">Nouvelle note</button>
          </div>

          <div class="mt-3 text-center text-[12px] font-bold text-gray-500">
            Ta note sert de référence interne (wallet).
          </div>
        </div>

        <div class="mt-6 p-5 rounded-2xl bg-white border border-gray-200">
          <div>
            <div class="text-[11px] font-black uppercase tracking-[.18em] text-gray-300">Recharger mon wallet</div>
            <div class="text-[13px] font-semibold text-gray-600 mt-2 leading-relaxed">
              Sélectionne la méthode.
              <b>Moneroo</b> = redirection automatique.
              <b>Binance/USDT</b> = dépôt manuel via WhatsApp (message pré-rempli).
            </div>
          </div>

          <div id="methodHint" class="mt-3 text-[12px] font-bold text-gray-500">
            Moneroo: redirection + retour automatique + confirmation serveur.
          </div>

          <div class="grid md:grid-cols-4 gap-3 mt-4">
            <div>
              <label class="text-[10px] font-black uppercase tracking-widest text-gray-400 ml-1">Montant (USD)</label>
              <input id="amountInp" type="number" min="1" step="0.01" class="input" placeholder="Ex: 10">
            </div>

            <div id="field2Wrap">
              <label id="field2Label" class="text-[10px] font-black uppercase tracking-widest text-gray-400 ml-1">
                Téléphone (Mobile Money)
              </label>
              <input id="field2Inp" type="text" class="input" placeholder="Ex: +243...">
              <div id="field2Help" class="mt-2 text-[11px] font-extrabold text-gray-400"></div>
            </div>

            <div>
              <label class="text-[10px] font-black uppercase tracking-widest text-gray-400 ml-1">Méthode</label>
              <div class="relative">
                <select id="methodSel" class="input select pr-10">
                  <option value="MONEROO_MOMO">Mobile Money (Moneroo)</option>
                  <option value="BINANCE_PAY">Binance Pay (manuel WhatsApp)</option>
                  <option value="USDT_TRC20">USDT (TRC-20) (manuel WhatsApp)</option>
                  <option value="USDT_BEP20">USDT (BEP-20) (manuel WhatsApp)</option>
                </select>
                <div class="pointer-events-none absolute right-4 top-1/2 -translate-y-1/2 text-gray-400">▾</div>
              </div>
            </div>

            <div class="flex items-end">
              <button id="paidBtn" class="btn brand-gradient btn-primary w-full" type="button">Continuer</button>
            </div>
          </div>

          <div id="manualBox" class="hidden mt-4 p-4 rounded-2xl bg-gray-50 border border-gray-200">
            <div class="text-[11px] font-black uppercase tracking-[.18em] text-gray-400">Dépôt manuel</div>
            <div class="mt-2 text-[13px] font-semibold text-gray-700 leading-relaxed">
              WhatsApp est prêt. Tu peux copier le message ou l’envoyer directement.
            </div>
            <div id="manualMeta" class="mt-3 text-[12px] font-bold text-gray-500"></div>

            <pre id="manualMsgPreview" class="mt-3 p-3 rounded-2xl bg-white border border-gray-200 text-[12px] font-semibold text-gray-800 mono mono-box"></pre>

            <div class="flex flex-wrap gap-2 mt-3">
              <button id="openWaBtn" class="btn brand-gradient btn-primary" type="button" style="height:38px;padding:0 12px;font-size:11px;">
                Ouvrir WhatsApp
              </button>
              <button id="copyManualBtn" class="btn btn-outline" type="button" style="height:38px;padding:0 12px;font-size:11px;">
                Copier le message
              </button>
              <button id="hideManualBtn" class="btn btn-outline" type="button" style="height:38px;padding:0 12px;font-size:11px;">
                Fermer
              </button>
            </div>
          </div>
        </div>

        <!-- HISTORIQUE WALLET_TX (SEULEMENT) -->
        <div class="mt-7">
          <div class="flex items-center justify-between gap-2 flex-wrap">
            <div class="text-[11px] font-black uppercase tracking-[.18em] text-gray-300">Historique</div>
            <button id="refreshTxBtn" class="btn btn-outline" type="button" style="height:38px;padding:0 12px;font-size:11px;">
              Rafraîchir
            </button>
          </div>

          <div id="txBox" class="mt-3 rounded-2xl border border-gray-200 bg-white overflow-hidden">
            <div class="p-4 text-sm font-bold text-gray-400">
              <div class="h-4 w-44 skeleton"></div>
              <div class="mt-2 h-4 w-64 skeleton"></div>
            </div>
          </div>

          <pre id="debugBox" class="hidden mt-3 p-3 rounded-2xl bg-black text-white text-[11px] overflow-auto"></pre>
        </div>

      </section>
    </div>
  </main>

  <footer class="bg-white border-t border-gray-200 py-8">
    <div class="max-w-[1240px] mx-auto px-4 text-center">
      <p class="text-[11px] text-[#767676]">© 2026 ViralFlowr. Tous droits réservés.</p>
    </div>
  </footer>

  <div id="toast" class="toast"></div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx_Tm3cGZs4oYdKmPieUU2SCjegAvn-BTufubyqZTFU4geAiRXN53YYE9XVGdq_uq1H/exec";
    const WHATSAPP_SUPPORT = "2438503737991";

    // =========================
    // UI refs
    // =========================
    const alertBox = document.getElementById("alertBox");
    const balanceValue = document.getElementById("balanceValue");
    const userLabel = document.getElementById("userLabel");
    const authModeLine = document.getElementById("authModeLine");
    const topupNoteEl = document.getElementById("topupNote");
    const txBox = document.getElementById("txBox");
    const debugBox = document.getElementById("debugBox");

    const balanceCurrencyLabel = document.getElementById("balanceCurrencyLabel");
    const balanceCurrencySym = document.getElementById("balanceCurrencySym");
    const lastUpdatedEl = document.getElementById("lastUpdated");

    const methodSel = document.getElementById("methodSel");
    const methodHint = document.getElementById("methodHint");

    const field2Wrap = document.getElementById("field2Wrap");
    const field2Label = document.getElementById("field2Label");
    const field2Inp = document.getElementById("field2Inp");
    const field2Help = document.getElementById("field2Help");

    const manualBox = document.getElementById("manualBox");
    const manualMeta = document.getElementById("manualMeta");
    const manualMsgPreview = document.getElementById("manualMsgPreview");
    const openWaBtn = document.getElementById("openWaBtn");
    const copyManualBtn = document.getElementById("copyManualBtn");
    const hideManualBtn = document.getElementById("hideManualBtn");

    const refreshBtn = document.getElementById("refreshBtn");
    const refreshTxBtn = document.getElementById("refreshTxBtn");
    const paidBtn = document.getElementById("paidBtn");

    // =========================
    // Toast
    // =========================
    function toast(msg){
      const el = document.getElementById("toast");
      el.textContent = String(msg || "");
      el.classList.add("show");
      clearTimeout(window.__vf_toast_t);
      window.__vf_toast_t = setTimeout(()=> el.classList.remove("show"), 2200);
    }

    // =========================
    // Debug
    // =========================
    const DEBUG = new URLSearchParams(location.search).has("debug");
    function dbg(title, obj){
      if(!DEBUG) return;
      try{
        console.log(title, obj);
        debugBox.classList.remove("hidden");
        debugBox.textContent += "\n" + title + ":\n" + JSON.stringify(obj, null, 2) + "\n";
      }catch(e){
        console.log(title, obj);
      }
    }
    function maskToken_(t){
      t = String(t||"");
      if(!t) return "";
      if(t.length <= 10) return t.slice(0,3) + "...";
      return t.slice(0,6) + "..." + t.slice(-4);
    }

    // =========================
    // Helpers UI
    // =========================
    function showAlert(msg, type="info"){
      alertBox.classList.remove("hidden");
      alertBox.classList.remove(
        "bg-green-50","text-green-700","border-green-200",
        "bg-red-50","text-red-700","border-red-200",
        "bg-gray-50","text-gray-700","border-gray-200"
      );
      if (type==="success") alertBox.classList.add("bg-green-50","text-green-700","border-green-200");
      else if (type==="error") alertBox.classList.add("bg-red-50","text-red-700","border-red-200");
      else alertBox.classList.add("bg-gray-50","text-gray-700","border-gray-200");
      alertBox.textContent = msg;
    }
    function hideAlert(){ alertBox.classList.add("hidden"); alertBox.textContent=""; }

    function currencySymbol_(cur){
      const c = String(cur||"").toUpperCase();
      if(c==="USD") return "$";
      if(c==="EUR") return "€";
      if(c==="GBP") return "£";
      if(c==="CDF") return "FC";
      return c ? c : "$";
    }

    function setLastUpdated_(ts){
      if(!ts){ lastUpdatedEl.textContent = "—"; return; }
      const d = new Date(ts);
      if(isNaN(d.getTime())) { lastUpdatedEl.textContent = "—"; return; }
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      lastUpdatedEl.textContent = "Mis à jour: " + hh + ":" + mm;
    }

    function setBusy_(busy){
      refreshBtn.disabled = !!busy;
      refreshTxBtn.disabled = !!busy;
    }

    // =========================
    // Session
    // =========================
    function tryParse_(raw){ try { return JSON.parse(raw); } catch { return null; } }

    function getSession_(){
      const keys = ["vf_session","VF_SESSION","vfSession","VFSession","session","auth","vf_auth"];
      for(const k of keys){
        const raw = localStorage.getItem(k);
        if(!raw) continue;
        const s = tryParse_(raw);
        if(s && typeof s === "object") return s;
      }
      return null;
    }

    function pickStr_(v){
      const s = String(v||"").trim();
      return s ? s : "";
    }

    function getAuth_(s){
      const email =
        pickStr_(s?.email) ||
        pickStr_(s?.userEmail) ||
        pickStr_(s?.mail) ||
        pickStr_(s?.username) ||
        pickStr_(s?.user?.email) || "";

      const token =
        pickStr_(s?.token) ||
        pickStr_(s?.sessionToken) ||
        pickStr_(s?.access_token) ||
        pickStr_(s?.accessToken) ||
        pickStr_(s?.jwt) ||
        pickStr_(s?.user?.token) || "";

      return { email: email.toLowerCase(), token };
    }

    function applyAuthUI_(){
      const btnText = document.getElementById("logoutBtn");
      const btnIcon = document.getElementById("logoutBtnIcon");
      const btnInline = document.getElementById("logoutBtnInline");

      const s = getSession_();

      function setAll_(label, onClick){
        if(btnText){ btnText.textContent = label; btnText.disabled = false; btnText.onclick = onClick; }
        if(btnInline){ btnInline.textContent = label; btnInline.disabled = false; btnInline.onclick = onClick; }
        if(btnIcon){
          btnIcon.setAttribute("aria-label", label);
          btnIcon.setAttribute("title", label);
          btnIcon.disabled = false;
          btnIcon.onclick = onClick;
        }
      }

      if(!s){
        setAll_("Connexion", () => { window.location.href = "login.html"; });
        return;
      }

      setAll_("Déconnexion", () => {
        ["vf_session","VF_SESSION","vfSession","VFSession","session","auth","vf_auth"].forEach(k => {
          try { localStorage.removeItem(k); } catch(_){}
        });
        showAlert("Déconnecté.", "success");
        setTimeout(() => { window.location.href = "login.html"; }, 350);
      });
    }

    window.addEventListener("storage", (e) => {
      const keys = ["vf_session","VF_SESSION","vfSession","VFSession","session","auth","vf_auth"];
      if(keys.includes(e.key)) applyAuthUI_();
    });

    // =========================
    // Topup note
    // =========================
    function setTopupNote_(identityKey, note){
      const k = "vf_topup_note_" + String(identityKey||"user").toLowerCase();
      localStorage.setItem(k, note);
      topupNoteEl.textContent = note;
      return note;
    }

    function ensureTopupNote_(identityKey){
      const k = "vf_topup_note_" + String(identityKey||"user").toLowerCase();
      let note = localStorage.getItem(k);
      if(!note){
        note = "TOPUP-" + Date.now() + "-" + Math.floor(1000 + Math.random()*9000);
        localStorage.setItem(k, note);
      }
      topupNoteEl.textContent = note;
      return note;
    }

    async function copyText_(text){
      const t = String(text||"").trim();
      if(!t) return false;

      try{
        if (navigator.clipboard && typeof navigator.clipboard.writeText === "function"){
          await navigator.clipboard.writeText(t);
          return true;
        }
      }catch(_){}

      try{
        const ta = document.createElement("textarea");
        ta.value = t;
        ta.setAttribute("readonly","true");
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        ta.style.top = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        const ok = document.execCommand("copy");
        ta.remove();
        return !!ok;
      }catch(_){}

      return false;
    }

    // =========================
    // JSONP (évite CORS)
    // =========================
    function jsonp_(params, onOk, onErr, timeoutMs=12000){
      const cb = "vf_cb_" + Date.now() + "_" + Math.floor(Math.random()*1000000);
      let done = false;

      const timer = setTimeout(() => {
        if(done) return;
        done = true;
        try { delete window[cb]; } catch(_){}
        onErr && onErr("TIMEOUT");
      }, timeoutMs);

      window[cb] = function(payload){
        if(done) return;
        done = true;
        clearTimeout(timer);
        try { onOk(payload); }
        finally { try { delete window[cb]; } catch(_){} }
      };

      const s = document.createElement("script");
      const qs = new URLSearchParams({ ...params, callback: cb, t: String(Date.now()) });
      s.src = SCRIPT_URL + "?" + qs.toString();
      s.onerror = function(){
        if(done) return;
        done = true;
        clearTimeout(timer);
        try { delete window[cb]; } catch(_){}
        onErr && onErr("NETWORK");
      };
      document.body.appendChild(s);
      s.onload = () => setTimeout(() => { try { s.remove(); } catch(_){ } }, 0);
    }

    function fmt2(n){
      const x = Number(n||0);
      if(!isFinite(x)) return "0.00";
      return x.toFixed(2);
    }

    function isPhoneLike_(v){
      const s = String(v||"").trim();
      if(!s) return false;
      const cleaned = s.replace(/\s+/g,"");
      if(cleaned.length < 8) return false;
      return /^[+0-9][0-9+]*$/.test(cleaned);
    }

    // =========================
    // Identité API (token + email)
    // =========================
    function identityParams_(auth){
      const token = String(auth?.token || "").trim();
      const email = String(auth?.email || "").trim().toLowerCase();
      const o = {};
      if(token) o.token = token;
      if(email) o.email = email;
      return o;
    }

    // =========================
    // Cache rapide (perçu instantané)
    // =========================
    function cacheKey_(identityKey, name){
      return "vf_wallet_cache_" + String(identityKey||"user").toLowerCase() + "_" + name;
    }

    function saveCache_(key, obj){
      try{
        localStorage.setItem(key, JSON.stringify({ t: Date.now(), v: obj }));
      }catch(_){}
    }

    function readCache_(key){
      try{
        const raw = localStorage.getItem(key);
        if(!raw) return null;
        const o = JSON.parse(raw);
        if(!o || typeof o !== "object") return null;
        return o;
      }catch(_){ return null; }
    }

    // =========================
    // Wallet render
    // =========================
    function normalizeTxList_(res){
      const list =
        (res && Array.isArray(res.txs) && res.txs) ||
        (res && Array.isArray(res.items) && res.items) ||
        (res && Array.isArray(res.list) && res.list) ||
        (res && Array.isArray(res.data) && res.data) ||
        [];

      return list.map(tx => ({
        created_at: tx.created_at || tx.date || tx.createdAt || tx.ts || "-",
        type: tx.type || tx.kind || "-",
        amount: (tx.amount ?? tx.value ?? 0),
        ref: tx.ref || tx.note || tx.reference || tx.tx_id || tx.id || "",
        status: tx.status || "",
        currency: tx.currency || res.currency || "USD"
      }));
    }

    function renderTx_(list){
      if(!Array.isArray(list) || list.length===0){
        txBox.innerHTML = `<div class="p-4 text-sm font-bold text-gray-400">Aucune transaction.</div>`;
        return;
      }

      txBox.innerHTML = `
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-gray-50">
              <tr class="text-left text-[11px] uppercase tracking-widest text-gray-400 font-black">
                <th class="p-3">Date</th>
                <th class="p-3">Type</th>
                <th class="p-3">Montant</th>
                <th class="p-3">Ref</th>
                <th class="p-3">Statut</th>
              </tr>
            </thead>
            <tbody>
              ${list.map(tx => {
                const t = String(tx.type||"").toUpperCase();
                const cls = (t==="CREDIT" || t==="TOPUP") ? "text-green-700" : "text-orange-700";
                const cur = String(tx.currency||"USD").toUpperCase();
                return `
                  <tr class="border-t">
                    <td class="p-3 font-bold text-gray-500">${tx.created_at || "-"}</td>
                    <td class="p-3 font-black ${cls}">${tx.type || "-"}</td>
                    <td class="p-3 font-black text-gray-900">${fmt2(tx.amount)} ${currencySymbol_(cur)}</td>
                    <td class="p-3 font-semibold text-gray-400">${tx.ref || ""}</td>
                    <td class="p-3 font-extrabold text-gray-500">${tx.status || ""}</td>
                  </tr>
                `;
              }).join("")}
            </tbody>
          </table>
        </div>
      `;
    }

    // =========================
    // Lecture solde + tx (API)
    // =========================
    function loadWallet_(auth, identityKey){
      balanceValue.textContent = "—";
      balanceCurrencyLabel.textContent = "USD";
      balanceCurrencySym.textContent = "$";
      setLastUpdated_(null);

      const idp = identityParams_(auth);

      if(DEBUG){
        authModeLine.classList.remove("hidden");
        if(idp.token) authModeLine.textContent = "Auth: token = " + maskToken_(idp.token);
        else if(idp.email) authModeLine.textContent = "Auth: email = " + idp.email;
        else authModeLine.textContent = "Auth: manquant (email/token requis)";
      }

      dbg("wallet_balance request", { action:"wallet_balance", currency:"USD", ...idp });

      jsonp_(
        { action:"wallet_balance", currency:"USD", ...idp },
        (res) => {
          dbg("wallet_balance response", res);

          if(res && res.ok){
            const cur = String(res.currency || "USD").toUpperCase();
            balanceCurrencyLabel.textContent = cur;
            balanceCurrencySym.textContent = currencySymbol_(cur);
            balanceValue.textContent = fmt2(res.balance);
            setLastUpdated_(Date.now());

            saveCache_(cacheKey_(identityKey,"balance"), { balance: Number(res.balance||0), currency: cur });
            saveCache_(cacheKey_(identityKey,"updated"), { t: Date.now() });

            hideAlert();
            return;
          }

          const err = res?.error || "ERREUR";
          showAlert("Solde non chargé (" + err + ").", "error");
          balanceValue.textContent = "0.00";
          setLastUpdated_(Date.now());
        },
        (why) => {
          dbg("wallet_balance error", why);
          showAlert("Solde non chargé (réseau: " + why + ").", "error");
          balanceValue.textContent = "0.00";
          setLastUpdated_(Date.now());
        }
      );
    }

    function loadTx_(auth, identityKey){
      txBox.innerHTML = `
        <div class="p-4 text-sm font-bold text-gray-400">
          <div class="h-4 w-44 skeleton"></div>
          <div class="mt-2 h-4 w-64 skeleton"></div>
        </div>
      `;

      const idp = identityParams_(auth);

      dbg("wallet_tx request", { action:"wallet_tx", currency:"USD", limit:"50", ...idp });

      jsonp_(
        { action:"wallet_tx", currency:"USD", limit:"50", ...idp },
        (res) => {
          dbg("wallet_tx response", res);

          if(res && res.ok){
            const list = normalizeTxList_(res);
            renderTx_(list);
            saveCache_(cacheKey_(identityKey,"tx"), list);
            return;
          }

          txBox.innerHTML = `<div class="p-4 text-sm font-bold text-gray-400">Historique indisponible (${res?.error || "ERREUR"}).</div>`;
        },
        (why) => {
          dbg("wallet_tx error", why);
          txBox.innerHTML = `<div class="p-4 text-sm font-bold text-gray-400">Erreur réseau (${why}).</div>`;
        }
      );
    }

    // =========================
    // Depot manuel WhatsApp
    // =========================
    function buildWhatsappMessage_({ email, amount, method, note, phone, txid }){
      const lines = [];
      lines.push("Bonjour, je veux recharger mon wallet ViralFlowr.");
      lines.push("");
      if(email) lines.push("Email: " + email);
      lines.push("Montant: " + fmt2(amount) + " USD");
      lines.push("Méthode: " + method);
      lines.push("Note: " + note);
      if(phone) lines.push("Téléphone: " + phone);
      if(txid) lines.push("TXID: " + txid);
      lines.push("");
      lines.push("Merci.");
      return lines.join("\n");
    }

    function openWhatsApp_(phoneDigits, message){
      const phone = String(phoneDigits||"").replace(/[^\d]/g,"");
      const text = encodeURIComponent(String(message||""));
      const url = "https://wa.me/" + phone + "?text=" + text;
      window.open(url, "_blank", "noopener");
    }

    function showManual_(message, meta){
      manualBox.classList.remove("hidden");
      manualMsgPreview.textContent = String(message || "");

      const parts = [];
      if(meta?.amount) parts.push("Montant: " + meta.amount);
      if(meta?.method) parts.push("Méthode: " + meta.method);
      if(meta?.note) parts.push("Note: " + meta.note);
      manualMeta.textContent = parts.join(" • ");

      copyManualBtn.onclick = async () => {
        const ok = await copyText_(message);
        toast(ok ? "Copié." : "Copie impossible.");
      };
      openWaBtn.onclick = () => openWhatsApp_(WHATSAPP_SUPPORT, message);
      hideManualBtn.onclick = () => manualBox.classList.add("hidden");
    }

    function applyMethodUI_(){
      const method = String(methodSel.value || "MONEROO_MOMO").toUpperCase();

      field2Inp.value = "";
      field2Help.textContent = "";
      manualBox.classList.add("hidden");
      manualMeta.textContent = "";
      manualMsgPreview.textContent = "";

      if(method === "MONEROO_MOMO"){
        field2Wrap.classList.remove("hidden");
        field2Label.textContent = "Téléphone (Mobile Money)";
        field2Inp.placeholder = "Ex: +243...";
        field2Help.textContent = "Obligatoire. Exemple: +243850000000";
        methodHint.textContent = "Moneroo: redirection + retour automatique + confirmation serveur.";
        return;
      }

      if(method === "BINANCE_PAY"){
        field2Wrap.classList.add("hidden");
        methodHint.textContent = "Dépôt manuel (Binance): WhatsApp pré-rempli.";
        return;
      }

      if(method === "USDT_TRC20" || method === "USDT_BEP20"){
        field2Wrap.classList.remove("hidden");
        field2Label.textContent = "TxID / Hash (optionnel)";
        field2Inp.placeholder = "Colle le hash après paiement (optionnel)";
        field2Help.textContent = "Optionnel. Tu peux envoyer le TXID sur WhatsApp.";
        methodHint.textContent = "Dépôt manuel: WhatsApp pré-rempli + validation support.";
        return;
      }

      field2Wrap.classList.add("hidden");
      methodHint.textContent = "Choisis une méthode.";
    }

    function createTopup_(auth, note){
      const amount = Number(document.getElementById("amountInp").value || 0);
      const method = String(methodSel.value || "MONEROO_MOMO").toUpperCase();
      const field2 = String(field2Inp.value || "").trim();

      if(!amount || !isFinite(amount) || amount <= 0){
        showAlert("Entre un montant valide (USD).", "error");
        return;
      }

      paidBtn.disabled = true;
      paidBtn.textContent = "Traitement...";

      const idp = identityParams_(auth);

      if(!idp.token && !idp.email){
        paidBtn.disabled = false;
        paidBtn.textContent = "Continuer";
        showAlert("email/token requis. Reconnecte-toi.", "error");
        return;
      }

      if(method === "MONEROO_MOMO"){
        const phone = field2;
        if(!isPhoneLike_(phone)){
          paidBtn.disabled = false;
          paidBtn.textContent = "Continuer";
          showAlert("Téléphone Mobile Money invalide. Exemple: +243850000000", "error");
          return;
        }

        const returnUrl = window.location.origin + window.location.pathname;

        dbg("wallet_topup_create request", {
          action:"wallet_topup_create",
          ...idp,
          note, amount:String(amount), method, phone,
          currency:"USD", return_url:returnUrl
        });

        jsonp_(
          { action:"wallet_topup_create", ...idp, note, amount:String(amount), method, phone, currency:"USD", return_url:returnUrl },
          (res) => {
            dbg("wallet_topup_create response", res);

            paidBtn.disabled = false;
            paidBtn.textContent = "Continuer";

            if(res && res.ok && res.mode === "redirect" && res.checkout_url){
              showAlert("Redirection…", "success");
              setTimeout(() => { window.location.href = res.checkout_url; }, 250);
              return;
            }

            if(res && res.ok){
              showAlert("Demande enregistrée.", "success");
              setTimeout(() => { loadWallet_(auth, auth.email || auth.token || "user"); loadTx_(auth, auth.email || auth.token || "user"); }, 700);
              return;
            }

            showAlert("Impossible d’enregistrer (" + (res?.error || "ERREUR") + ").", "error");
          },
          (why) => {
            dbg("wallet_topup_create error", why);
            paidBtn.disabled = false;
            paidBtn.textContent = "Continuer";
            showAlert("Erreur réseau (" + why + ").", "error");
          }
        );

        return;
      }

      const txid = (method === "USDT_TRC20" || method === "USDT_BEP20") ? field2 : "";
      const waMessage = buildWhatsappMessage_({ email: auth.email || "", amount, method, note, phone: "", txid });

      jsonp_(
        { action:"wallet_topup_create", ...idp, note, amount:String(amount), method, txid, currency:"USD", return_url: window.location.origin + window.location.pathname },
        (res) => {
          dbg("wallet_topup_create(manual) response", res);

          paidBtn.disabled = false;
          paidBtn.textContent = "Continuer";

          if(res && res.ok){
            showAlert("Dépôt manuel: WhatsApp prêt.", "success");
            setTimeout(() => { loadTx_(auth, auth.email || auth.token || "user"); }, 600);
          } else {
            showAlert("Dépôt manuel: WhatsApp prêt (API: " + (res?.error || "ERREUR") + ")", "info");
          }

          showManual_(waMessage, { amount: fmt2(amount) + " USD", method, note });
          openWhatsApp_(WHATSAPP_SUPPORT, waMessage);
        },
        (_why) => {
          paidBtn.disabled = false;
          paidBtn.textContent = "Continuer";
          showAlert("Dépôt manuel: WhatsApp prêt.", "success");
          showManual_(waMessage, { amount: fmt2(amount) + " USD", method, note });
          openWhatsApp_(WHATSAPP_SUPPORT, waMessage);
        },
        8000
      );
    }

    // =========================
    // Retour Moneroo (si ton Apps Script gère moneroo_confirm)
    // =========================
    function maybeHandleMonerooReturn_(auth){
      const idp = identityParams_(auth);
      if(!idp.token && !idp.email) return;

      const u = new URL(window.location.href);
      const paymentId = u.searchParams.get("monerooPaymentId");
      const status = u.searchParams.get("monerooPaymentStatus") || u.searchParams.get("status");
      if(!paymentId) return;

      showAlert("Paiement détecté, confirmation en cours…", "info");

      jsonp_(
        { action:"moneroo_confirm", paymentId, ...idp },
        (res) => {
          dbg("moneroo_confirm response", res);

          if(res && res.ok && res.credited){
            showAlert("Crédit ajouté.", "success");
            loadWallet_(auth, auth.email || auth.token || "user");
            loadTx_(auth, auth.email || auth.token || "user");
          }else{
            showAlert("Paiement non confirmé (" + (res?.error || status || "ERREUR") + ").", "error");
          }

          u.searchParams.delete("monerooPaymentId");
          u.searchParams.delete("monerooPaymentStatus");
          u.searchParams.delete("status");
          window.history.replaceState({}, document.title, u.pathname + u.search);
        },
        (why) => showAlert("Confirmation échouée (" + why + ").", "error"),
        20000
      );
    }

    // =========================
    // INIT
    // =========================
    (function(){
      applyAuthUI_();

      const s = getSession_();
      if(!s){
        showAlert("Connecte-toi d’abord pour utiliser le wallet.", "error");
        userLabel.textContent = "Non connecté";
        balanceValue.textContent = "—";
        txBox.innerHTML = `<div class="p-4 text-sm font-bold text-gray-400">Connecte-toi pour voir ton solde.</div>`;
        return;
      }

      const auth = getAuth_(s);
      dbg("session raw", s);
      dbg("auth picked", { email: auth.email, token: maskToken_(auth.token) });

      userLabel.textContent = auth.email || "Utilisateur";

      const identityKey = auth.email || auth.token || "user";

      // Cache instantané (avant API)
      const cachedBal = readCache_(cacheKey_(identityKey,"balance"));
      const cachedUpd = readCache_(cacheKey_(identityKey,"updated"));
      const cachedTx  = readCache_(cacheKey_(identityKey,"tx"));

      if(cachedBal && cachedBal.v){
        const cur = String(cachedBal.v.currency || "USD").toUpperCase();
        balanceCurrencyLabel.textContent = cur;
        balanceCurrencySym.textContent = currencySymbol_(cur);
        balanceValue.textContent = fmt2(cachedBal.v.balance);
      }
      if(cachedUpd && cachedUpd.v && cachedUpd.v.t){
        setLastUpdated_(cachedUpd.v.t);
      }
      if(cachedTx && Array.isArray(cachedTx.v)){
        renderTx_(cachedTx.v);
      }

      // Note
      let note = ensureTopupNote_(identityKey);

      // UI method
      applyMethodUI_();
      methodSel.addEventListener("change", applyMethodUI_);

      // Load API
      setBusy_(true);
      loadWallet_(auth, identityKey);
      loadTx_(auth, identityKey);
      setTimeout(()=> setBusy_(false), 450);

      // Confirme retour Moneroo si présent
      maybeHandleMonerooReturn_(auth);

      refreshBtn.addEventListener("click", () => {
        setBusy_(true);
        loadWallet_(auth, identityKey);
        loadTx_(auth, identityKey);
        setTimeout(()=> setBusy_(false), 450);
      });

      refreshTxBtn.addEventListener("click", () => loadTx_(auth, identityKey));

      document.getElementById("copyNoteBtn").addEventListener("click", async () => {
        const ok = await copyText_(note);
        toast(ok ? "Copié." : "Copie impossible.");
      });

      document.getElementById("newNoteBtn").addEventListener("click", () => {
        note = setTopupNote_(identityKey, "TOPUP-" + Date.now() + "-" + Math.floor(1000 + Math.random()*9000));
        toast("Nouvelle note générée.");
      });

      paidBtn.addEventListener("click", () => createTopup_(auth, note));
    })();
  </script>

</body>
</html>
