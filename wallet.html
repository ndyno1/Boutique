<!DOCTYPE html>
<html lang="fr" class="font-inter">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ViralFlowr | Wallet (D√©p√¥t)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    body { font-family:'Inter',sans-serif; background:#F3F3F3; }
    .brand-gradient { background: linear-gradient(135deg, #F07E13 0%, #FFB26B 100%); }
    .text-orange-bsv { color:#F07E13; }
    .checkout-container { max-width:520px; width:100%; margin:2rem auto; }

    .payment-row{
      display:flex; justify-content:space-between; align-items:center;
      padding:12px; border-radius:12px;
      border:1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.03);
      margin-bottom:8px; gap:10px;
    }
    .copy-badge{
      font-size:10px; font-weight:800;
      background: rgba(255,255,255,0.1);
      padding:4px 8px; border-radius:6px;
      cursor:pointer; transition:0.2s;
      white-space:nowrap;
    }
    .copy-badge:hover{ background:#F07E13; color:#fff; }

    input, textarea, select { outline:none; transition:all .2s; border:1px solid #e5e7eb !important; }
    input:focus, textarea:focus, select:focus { border-color:#F07E13 !important; }
  </style>
</head>

<body class="p-4 md:p-8 text-[#201B16]">

  <div class="checkout-container">
    <div class="text-center mb-6">
      <a href="index.html" class="inline-block text-2xl font-black tracking-tighter mb-1">
        Viral<span class="text-orange-bsv">Flowr</span>
      </a>
      <p class="text-gray-400 text-[10px] font-bold uppercase tracking-widest">Portefeuille ‚Ä¢ D√©p√¥t / Cr√©dit</p>
    </div>

    <div class="bg-white rounded-[32px] shadow-lg border border-gray-100 p-6 md:p-8">

      <!-- MSG -->
      <div id="msgBox" class="hidden w-full text-sm font-semibold px-4 py-3 rounded-2xl border mb-5"></div>

      <!-- HEADER WALLET -->
      <div class="flex items-center justify-between gap-3 mb-6">
        <div>
          <div class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Solde (USD)</div>
          <div class="text-4xl font-black tracking-tighter">
            <span id="balance">‚Äî</span><span class="text-gray-400 text-xl ml-1">$</span>
          </div>
          <div class="text-[11px] text-gray-500 font-bold mt-1">
            Email: <span id="emailLabel" class="text-gray-800">‚Äî</span>
          </div>
        </div>

        <div class="flex flex-col gap-2">
          <button id="refreshBtn" type="button"
            class="px-4 py-2 rounded-2xl bg-gray-900 text-white text-[11px] font-black uppercase hover:bg-gray-800">
            Actualiser
          </button>
          <button id="logoutBtn" type="button"
            class="px-4 py-2 rounded-2xl bg-gray-100 text-gray-800 text-[11px] font-black uppercase hover:bg-gray-200">
            D√©connexion
          </button>
        </div>
      </div>

      <!-- NOTE / TOPUP ID -->
      <div class="bg-gray-50 border-2 border-dashed border-gray-200 rounded-2xl p-4 text-center mb-6 hover:border-orange-200 transition-all">
        <span class="text-[9px] font-black text-gray-400 uppercase tracking-widest block mb-1">Note de d√©p√¥t (IMPORTANT)</span>
        <span id="topupId" class="block text-2xl font-black text-gray-900 tracking-tight cursor-pointer" onclick="copyText(this.innerText)">...</span>
        <div class="mt-2">
          <button type="button" onclick="copyText(document.getElementById('topupId').innerText)"
            class="text-[9px] bg-white border border-gray-300 px-3 py-1 rounded-full font-bold shadow-sm">
            COPIER LA NOTE
          </button>
        </div>
        <p class="text-[10px] text-gray-500 font-bold mt-3 leading-relaxed">
          ‚ö†Ô∏è Mets cette <span class="text-gray-900">NOTE (ID)</span> dans Binance (case ‚ÄúNote / Message‚Äù) pour que je t‚Äôidentifie.
        </p>
      </div>

      <!-- METHODS -->
      <div class="bg-[#121417] rounded-[24px] p-5 text-white shadow-2xl relative overflow-hidden mb-6">
        <h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-4">Moyens accept√©s</h4>

        <div class="payment-row">
          <div>
            <span class="block text-[10px] font-bold text-orange-400 uppercase">Binance Pay</span>
            <span class="text-[13px] font-bold">744370418</span>
          </div>
          <button type="button" class="copy-badge" onclick="copyText('744370418')">COPIER</button>
        </div>

        <div class="payment-row">
          <div class="overflow-hidden mr-2">
            <span class="block text-[10px] font-bold text-blue-400 uppercase">USDT (TRC-20)</span>
            <span id="trc20" class="text-[10px] font-mono opacity-80 truncate block">TN6c8PCwF1TU2XKPFDsGHw1fgen1MTRGka</span>
          </div>
          <button type="button" class="copy-badge" onclick="copyText(document.getElementById('trc20').innerText)">COPIER</button>
        </div>

        <div class="payment-row">
          <div class="overflow-hidden mr-2">
            <span class="block text-[10px] font-bold text-yellow-400 uppercase">USDT (BEP-20)</span>
            <span id="bep20" class="text-[10px] font-mono opacity-80 truncate block">0x532795969be892b943c160b94c075ca3385e2ea0</span>
          </div>
          <button type="button" class="copy-badge" onclick="copyText(document.getElementById('bep20').innerText)">COPIER</button>
        </div>

        <p class="text-[10px] text-gray-400 font-bold mt-4 leading-relaxed">
          ‚úÖ Apr√®s paiement : colle <span class="text-white">la r√©f√©rence (TxID / ID Binance)</span> + ajoute la preuve.
        </p>
      </div>

      <!-- FORM -->
      <form id="topupForm" class="space-y-5">

        <div>
          <label class="text-[11px] font-bold text-gray-900 uppercase ml-1">Montant √† d√©poser (USD)</label>
          <input type="number" id="amount" min="1" step="0.01" placeholder="Ex: 10"
            class="w-full bg-white rounded-xl p-3 text-sm font-black">
          <p class="text-[11px] text-gray-500 font-bold mt-2">
            Le cr√©dit est ajout√© apr√®s validation (manuel ou auto).
          </p>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-[11px] font-bold text-gray-900 uppercase ml-1">M√©thode</label>
            <select id="method" class="w-full bg-white rounded-xl p-3 text-sm font-bold">
              <option value="BINANCE_PAY">Binance Pay</option>
              <option value="USDT_TRC20">USDT TRC-20</option>
              <option value="USDT_BEP20">USDT BEP-20</option>
              <option value="WAVE_CI">Wave (CI)</option>
              <option value="AIRTEL_RDC">Airtel (RDC)</option>
            </select>
          </div>

          <div>
            <label class="text-[11px] font-bold text-gray-900 uppercase ml-1">R√©f√©rence / TxID</label>
            <input type="text" id="txid" placeholder="Ex: 123456789 / hash..."
              class="w-full bg-white rounded-xl p-3 text-sm font-bold">
          </div>
        </div>

        <div>
          <label class="text-[11px] font-bold text-gray-900 uppercase ml-1">Note (optionnel)</label>
          <input type="text" id="note" placeholder="Ex: d√©p√¥t wallet"
            class="w-full bg-white rounded-xl p-3 text-sm font-medium">
        </div>

        <div class="pt-1">
          <label class="text-[11px] font-bold text-gray-900 uppercase ml-1 block mb-2">üì∏ Preuve de paiement (Obligatoire)</label>
          <input type="file" id="file" accept="image/*" required
            class="w-full text-xs bg-white rounded-xl p-3 border border-gray-200
            file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-xs
            file:font-bold file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200">
        </div>

        <button type="submit" id="submitBtn"
          class="w-full brand-gradient text-white py-4 rounded-2xl font-black text-sm uppercase shadow-xl hover:scale-[1.02] transition-transform disabled:opacity-70 disabled:cursor-not-allowed">
          Confirmer le d√©p√¥t
        </button>

      </form>

      <!-- SUCCESS -->
      <div id="success" class="hidden text-center py-12">
        <div class="w-24 h-24 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6 animate-bounce">
          <svg width="40" height="40" fill="none" stroke="currentColor" stroke-width="4" viewBox="0 0 24 24">
            <path d="M5 13l4 4L19 7"></path>
          </svg>
        </div>
        <h3 class="text-3xl font-black text-gray-900 mb-2">Re√ßu ‚úÖ</h3>
        <p class="text-gray-500 text-sm mb-8 font-medium">
          D√©p√¥t <strong id="finalTopupId" class="text-gray-900"></strong> enregistr√©.
          <br/>Ton solde sera cr√©dit√© apr√®s validation.
        </p>
        <button id="backBtn"
          class="w-full bg-gray-900 text-white py-4 rounded-2xl font-black text-xs uppercase hover:bg-gray-800 transition-colors">
          Retour
        </button>
      </div>

    </div>

    <div class="mt-8 text-center">
      <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Wallet s√©curis√© par ViralFlowr</p>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const GOOGLE_URL = "https://script.google.com/macros/s/AKfycbyCvuy-WiLMlAkBb7k6YyPVMk4lQhGGke05heSWSw--twKE2L-oVSOs884g3jn6lt6m/exec";

    // ===== HELPERS UI =====
    const msgBox = document.getElementById("msgBox");
    const btn = document.getElementById("submitBtn");

    function showMsg(text, type) {
      msgBox.classList.remove("hidden");
      msgBox.classList.remove(
        "bg-green-50","text-green-700","border-green-200",
        "bg-red-50","text-red-700","border-red-200",
        "bg-gray-50","text-gray-700","border-gray-200"
      );
      if (type === "success") msgBox.classList.add("bg-green-50","text-green-700","border-green-200");
      else if (type === "error") msgBox.classList.add("bg-red-50","text-red-700","border-red-200");
      else msgBox.classList.add("bg-gray-50","text-gray-700","border-gray-200");
      msgBox.textContent = text;
    }

    function setLoading(isLoading) {
      btn.disabled = isLoading;
      btn.textContent = isLoading ? "Envoi..." : "Confirmer le d√©p√¥t";
    }

    function copyText(txt){
      navigator.clipboard.writeText(String(txt || ""));
      alert("Copi√© !");
    }

    function makeTopupId(){
      return "TOPUP-" + Date.now() + "-" + Math.floor(1000 + Math.random()*9000);
    }

    // ===== SESSION / TOKEN =====
    const session = JSON.parse(localStorage.getItem("vf_session") || "null");
    const token = localStorage.getItem("vf_token") || "";

    if (session && session.email) {
      document.getElementById("emailLabel").innerText = session.email;
    }

    // si pas de token => il faut login
    if (!token) {
      showMsg("‚ö†Ô∏è Connecte-toi d‚Äôabord pour utiliser le wallet.", "error");
      setTimeout(() => location.href = "login.html", 700);
    }

    // ===== TOPUP ID persist =====
    let topupId = sessionStorage.getItem("active_topup_id");
    if (!topupId) {
      topupId = makeTopupId();
      sessionStorage.setItem("active_topup_id", topupId);
    }
    document.getElementById("topupId").innerText = topupId;

    // ===== BALANCE JSONP =====
    function refreshBalance(){
      if (!token){
        document.getElementById("balance").innerText = "‚Äî";
        return;
      }

      const cb = "VF_BAL_" + Date.now();
      window[cb] = function(res){
        try{
          if (res && res.ok){
            document.getElementById("balance").innerText = Number(res.balance || 0).toFixed(2);
          } else {
            document.getElementById("balance").innerText = "‚Äî";
            if (res && res.error === "BAD_TOKEN") {
              showMsg("Session expir√©e. Reconnecte-toi.", "error");
              localStorage.removeItem("vf_token");
              setTimeout(() => location.href="login.html", 700);
            }
          }
        } finally {
          try { delete window[cb]; } catch(_){}
        }
      };

      const s = document.createElement("script");
      s.src = `${GOOGLE_URL}?action=wallet_balance&token=${encodeURIComponent(token)}&currency=USD&callback=${cb}&t=${Date.now()}`;
      document.body.appendChild(s);
    }

    document.getElementById("refreshBtn").addEventListener("click", refreshBalance);

    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("vf_token");
      localStorage.removeItem("vf_session");
      location.href = "login.html";
    });

    refreshBalance();

    // ===== SUBMIT TOPUP (POST) =====
    document.getElementById("topupForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const amount = Number(String(document.getElementById("amount").value || "").replace(",", "."));
      const method = document.getElementById("method").value;
      const txid = String(document.getElementById("txid").value || "").trim();
      const note = String(document.getElementById("note").value || "").trim();

      if (!isFinite(amount) || amount <= 0){
        showMsg("‚ùå Montant invalide. Exemple: 10", "error");
        return;
      }
      if (amount < 1){
        showMsg("‚ùå Montant minimum: 1$", "error");
        return;
      }
      if (!txid){
        showMsg("‚ùå R√©f√©rence / TxID obligatoire.", "error");
        return;
      }

      const file = document.getElementById("file").files[0];
      if (!file){
        showMsg("‚ùå Ajoute la preuve de paiement.", "error");
        return;
      }

      setLoading(true);
      showMsg("Enregistrement du d√©p√¥t‚Ä¶", "info");

      let fileData = "";
      try {
        fileData = await new Promise((resolve, reject) => {
          const r = new FileReader();
          r.onload = () => resolve(r.result);
          r.onerror = reject;
          r.readAsDataURL(file);
        });
      } catch (err) {
        setLoading(false);
        showMsg("‚ùå Impossible de lire l‚Äôimage. R√©essaie.", "error");
        return;
      }

      const payload = {
        action: "wallet_topup_create",
        token: token,
        topup_id: topupId,
        amount: amount,
        currency: "USD",
        method: method,
        note: note,
        txid: txid,
        fileData: fileData,
        fileType: file.type || "image/jpeg",
        fileName: file.name || ("preuve_" + topupId + ".jpg")
      };

      try {
        const r = await fetch(GOOGLE_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" }, // √©vite preflight
          body: JSON.stringify(payload)
        });

        const txt = await r.text();
        let data;
        try { data = JSON.parse(txt); } catch { data = { ok:false, error:"BAD_SERVER_RESPONSE", details:txt }; }

        if (!data.ok){
          const code = String(data.error || "");
          const msg =
            data.message ||
            (code === "BAD_TOKEN" ? "Session expir√©e. Reconnecte-toi." :
            code === "BAD_AMOUNT" ? "Montant invalide." :
            code === "PROOF_REQUIRED" ? "Preuve de paiement obligatoire." :
            code === "MISSING_PROVIDER_REF" ? "R√©f√©rence/TxID obligatoire." :
            "Impossible d‚Äôenregistrer le d√©p√¥t.");

          showMsg("‚ùå " + msg, "error");
          setLoading(false);
          return;
        }

        confetti({ particleCount: 140, spread: 70, origin: { y: 0.6 } });

        document.getElementById("topupForm").classList.add("hidden");
        document.getElementById("success").classList.remove("hidden");
        document.getElementById("finalTopupId").innerText = topupId;

        // reset id pour prochain d√©p√¥t
        sessionStorage.removeItem("active_topup_id");

      } catch (err) {
        showMsg("‚ùå Erreur r√©seau. V√©rifie ta connexion et r√©essaie.", "error");
        setLoading(false);
      }
    });

    document.getElementById("backBtn").addEventListener("click", () => {
      location.reload();
    });
  </script>
</body>
</html>
