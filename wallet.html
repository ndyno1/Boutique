<!DOCTYPE html>
<html lang="fr" class="font-inter">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Portefeuille | ViralFlowr</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #F3F3F3; color: #201B16; overflow-x:hidden; }
    .text-orange-bsv { color: #F07E13; }
    .brand-gradient { background: linear-gradient(90deg, #F07E13 0%, #FFB26B 100%); }
    .brand-gradient:hover { background: linear-gradient(90deg, #d96d0c 0%, #F07E13 100%); }
    .card { background:#fff; border:1px solid #eee; border-radius:24px; box-shadow: 0 12px 25px rgba(0,0,0,.06); }
    .icon-btn{
      display:flex; align-items:center; justify-content:center;
      width:40px; height:40px; border-radius:14px;
      background:#fff; border:1px solid #E5E7EB; color:#374151;
      transition:.2s;
    }
    .icon-btn:hover{ border-color:#F07E13; color:#F07E13; transform:translateY(-1px); }
    .vf-brand-wrap{ min-width:0; overflow:hidden; }
    .vf-brand-text{
      display:block; max-width:100%;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; line-height:1;
    }
    .muted { color:#8A8A8A; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .btn {
      height: 44px; padding: 0 16px; border-radius: 14px;
      font-weight: 900; font-size: 12px; letter-spacing:.08em;
      text-transform: uppercase; transition: .2s; display:inline-flex; align-items:center; justify-content:center; gap:10px;
      white-space: nowrap;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn-outline { background:#fff; border:1px solid #E5E7EB; color:#111827; }
    .btn-outline:hover { border-color:#F07E13; color:#F07E13; }
    .btn-primary { color:#fff; }
    .box-note { border:2px dashed #E5E7EB; border-radius: 22px; background: #FBFBFB; }
    .small { font-size: 12px; }
    .input{
      width:100%;
      height:44px;
      padding:0 14px;
      border-radius:14px;
      background:#fff;
      border:1px solid #E5E7EB;
      outline:none;
      font-weight:800;
      font-size:13px;
      transition:.2s;
    }
    .input:focus{ border-color:#F07E13; box-shadow:0 6px 16px rgba(240,126,19,.10); }
    .select{ appearance:none; }
  </style>
</head>

<body class="min-h-screen flex flex-col">

  <header class="bg-white sticky top-0 w-full z-50 border-b border-gray-200 shadow-sm">
    <div class="max-w-[1240px] mx-auto h-16 px-4 flex items-center justify-between gap-4">
      <a class="flex items-center gap-2 shrink-0 vf-brand-wrap" href="index.html" aria-label="ViralFlowr">
        <div class="text-2xl font-black tracking-tighter vf-brand-text">
          Viral<span class="text-orange-bsv">Flowr</span>
        </div>
      </a>

      <div class="flex items-center gap-2">
        <a href="index.html" class="btn btn-outline hidden sm:inline-flex">Boutique</a>
        <a href="wallet.html" class="icon-btn" title="Portefeuille" aria-label="Portefeuille">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 7H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h13a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2Z"/>
            <path d="M16 7V5a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v2"/>
            <path d="M20 12h-4a2 2 0 0 0 0 4h4"/>
            <circle cx="16" cy="14" r="0.5" />
          </svg>
        </a>
      </div>
    </div>
  </header>

  <main class="flex-1 p-4">
    <div class="max-w-[860px] mx-auto">

      <div class="text-center mt-6 mb-4">
        <div class="text-3xl font-black tracking-tighter">Portefeuille <span class="text-orange-bsv">ViralFlowr</span></div>
        <div class="text-[11px] font-black uppercase tracking-[.2em] text-gray-300 mt-1">Dépôt • Crédit • Paiement instantané</div>
      </div>

      <div id="alertBox" class="hidden mb-4 px-4 py-3 rounded-2xl border text-sm font-bold"></div>

      <section class="card p-6 md:p-8">

        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <div class="text-[11px] font-black uppercase tracking-[.18em] text-gray-300">
              Solde (<span id="balanceCurrencyLabel">USD</span>)
            </div>
            <div class="text-4xl font-black tracking-tighter mt-1">
              <span id="balanceValue">—</span><span id="balanceCurrencySym" class="text-gray-300 ml-1">$</span>
            </div>
            <div class="mt-2 small font-bold">
              <span class="muted">Compte:</span> <span id="userLabel">—</span>
            </div>
          </div>

          <div class="flex items-center gap-2">
            <button id="refreshBtn" class="btn btn-outline">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <path d="M21 12a9 9 0 1 1-3-6.7"/><path d="M21 3v7h-7"/>
              </svg>
              Actualiser
            </button>
            <button id="logoutBtn" class="btn btn-outline">Déconnexion</button>
          </div>
        </div>

        <div class="mt-6 p-4 rounded-2xl bg-[#FFF7EE] border border-[#FFD7B0]">
          <div class="font-black text-[12px] uppercase tracking-[.18em] text-[#B65E0B]">Pourquoi déposer de l’argent ?</div>
          <ul class="mt-2 text-[13px] font-semibold text-[#3B2A16] leading-relaxed list-disc pl-5">
            <li>Tu ajoutes du <b>crédit</b> dans ton wallet.</li>
            <li>Après ça, tu peux payer les commandes <b>instantanément</b> sans refaire de paiement.</li>
            <li><b>Moneroo</b> = paiement Mobile Money + redirection automatique vers la page de paiement.</li>
            <li><b>Dépôt manuel</b> (Binance/USDT) = WhatsApp avec un message déjà rempli.</li>
          </ul>
        </div>

        <div class="mt-6 box-note p-5">
          <div class="text-[10px] font-black uppercase tracking-[.22em] text-gray-300 text-center">Note de dépôt (important)</div>
          <div class="text-center text-2xl md:text-3xl font-black tracking-tight mt-2 mono" id="topupNote">TOPUP-—</div>

          <div class="flex flex-wrap items-center justify-center gap-2 mt-3">
            <button id="copyNoteBtn" class="btn btn-outline">Copier la note</button>
            <button id="newNoteBtn" class="btn btn-outline">Nouvelle note</button>
          </div>

          <div class="mt-3 text-center text-[12px] font-bold text-gray-500">
            Ta NOTE sert de référence interne (wallet).
          </div>
        </div>

        <div class="mt-6 p-5 rounded-2xl bg-white border border-gray-200">
          <div>
            <div class="text-[11px] font-black uppercase tracking-[.18em] text-gray-300">Recharger mon wallet</div>
            <div class="text-[13px] font-semibold text-gray-600 mt-2 leading-relaxed">
              Sélectionne la méthode.
              <b>Moneroo</b> = redirection automatique.
              <b>Binance/USDT</b> = dépôt manuel via WhatsApp (message pré-rempli).
            </div>
          </div>

          <div id="methodHint" class="mt-3 text-[12px] font-bold text-gray-500">
            Moneroo: redirection + retour automatique + confirmation serveur.
          </div>

          <div class="grid md:grid-cols-4 gap-3 mt-4">
            <div>
              <label class="text-[10px] font-black uppercase tracking-widest text-gray-400 ml-1">Montant (USD)</label>
              <input id="amountInp" type="number" min="1" step="0.01" class="input" placeholder="Ex: 10">
            </div>

            <div id="field2Wrap">
              <label id="field2Label" class="text-[10px] font-black uppercase tracking-widest text-gray-400 ml-1">
                Téléphone (Mobile Money)
              </label>
              <input id="field2Inp" type="text" class="input" placeholder="Ex: +243...">
              <div id="field2Help" class="mt-2 text-[11px] font-extrabold text-gray-400"></div>
            </div>

            <div>
              <label class="text-[10px] font-black uppercase tracking-widest text-gray-400 ml-1">Méthode</label>
              <div class="relative">
                <select id="methodSel" class="input select pr-10">
                  <option value="MONEROO_MOMO">Mobile Money (Moneroo)</option>
                  <option value="BINANCE_PAY">Binance Pay (manuel WhatsApp)</option>
                  <option value="USDT_TRC20">USDT (TRC-20) (manuel WhatsApp)</option>
                  <option value="USDT_BEP20">USDT (BEP-20) (manuel WhatsApp)</option>
                </select>
                <div class="pointer-events-none absolute right-4 top-1/2 -translate-y-1/2 text-gray-400">▾</div>
              </div>
            </div>

            <div class="flex items-end">
              <button id="paidBtn" class="btn brand-gradient btn-primary w-full">Continuer</button>
            </div>
          </div>

          <div id="manualBox" class="hidden mt-4 p-4 rounded-2xl bg-gray-50 border border-gray-200">
            <div class="text-[11px] font-black uppercase tracking-[.18em] text-gray-400">Dépôt manuel</div>
            <div id="manualText" class="mt-2 text-[13px] font-semibold text-gray-700 leading-relaxed"></div>
            <div id="manualMeta" class="mt-3 text-[12px] font-bold text-gray-500"></div>

            <div class="flex flex-wrap gap-2 mt-3">
              <button id="openWaBtn" class="btn brand-gradient btn-primary" style="height:38px;padding:0 12px;font-size:11px;">
                Ouvrir WhatsApp
              </button>
              <button id="copyManualBtn" class="btn btn-outline" style="height:38px;padding:0 12px;font-size:11px;">
                Copier le message
              </button>
              <button id="hideManualBtn" class="btn btn-outline" style="height:38px;padding:0 12px;font-size:11px;">
                Fermer
              </button>
            </div>
          </div>
        </div>

        <div class="mt-7">
          <div class="flex items-center justify-between">
            <div class="text-[11px] font-black uppercase tracking-[.18em] text-gray-300">Historique</div>
            <button id="refreshTxBtn" class="btn btn-outline" style="height:38px;padding:0 12px;font-size:11px;">
              Rafraîchir
            </button>
          </div>

          <div id="txBox" class="mt-3 rounded-2xl border border-gray-200 bg-white overflow-hidden">
            <div class="p-4 text-sm font-bold text-gray-400">Chargement…</div>
          </div>

          <div class="mt-2 text-[11px] font-extrabold text-gray-400">
            Affichage direct depuis WALLET_TX (lecture seule).
          </div>
        </div>

      </section>
    </div>
  </main>

  <footer class="bg-white border-t border-gray-200 py-8">
    <div class="max-w-[1240px] mx-auto px-4 text-center">
      <p class="text-[11px] text-[#767676]">© 2026 ViralFlowr. Tous droits réservés.</p>
    </div>
  </footer>

  <script>
    // =========================
    // CONFIG
    // =========================
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx_Tm3cGZs4oYdKmPieUU2SCjegAvn-BTufubyqZTFU4geAiRXN53YYE9XVGdq_uq1H/exec";
    const WHATSAPP_SUPPORT = "2438503737991";

    // =========================
    // UI refs
    // =========================
    const alertBox = document.getElementById("alertBox");
    const balanceValue = document.getElementById("balanceValue");
    const userLabel = document.getElementById("userLabel");
    const topupNoteEl = document.getElementById("topupNote");
    const txBox = document.getElementById("txBox");

    const balanceCurrencyLabel = document.getElementById("balanceCurrencyLabel");
    const balanceCurrencySym = document.getElementById("balanceCurrencySym");

    const methodSel = document.getElementById("methodSel");
    const methodHint = document.getElementById("methodHint");

    const field2Wrap = document.getElementById("field2Wrap");
    const field2Label = document.getElementById("field2Label");
    const field2Inp = document.getElementById("field2Inp");
    const field2Help = document.getElementById("field2Help");

    const manualBox = document.getElementById("manualBox");
    const manualText = document.getElementById("manualText");
    const manualMeta = document.getElementById("manualMeta");
    const openWaBtn = document.getElementById("openWaBtn");
    const copyManualBtn = document.getElementById("copyManualBtn");
    const hideManualBtn = document.getElementById("hideManualBtn");

    // =========================
    // Helpers UI
    // =========================
    function showAlert(msg, type="info"){
      alertBox.classList.remove("hidden");
      alertBox.classList.remove(
        "bg-green-50","text-green-700","border-green-200",
        "bg-red-50","text-red-700","border-red-200",
        "bg-gray-50","text-gray-700","border-gray-200"
      );
      if (type==="success") alertBox.classList.add("bg-green-50","text-green-700","border-green-200");
      else if (type==="error") alertBox.classList.add("bg-red-50","text-red-700","border-red-200");
      else alertBox.classList.add("bg-gray-50","text-gray-700","border-gray-200");
      alertBox.textContent = msg;
    }
    function hideAlert(){ alertBox.classList.add("hidden"); alertBox.textContent=""; }

    function currencySymbol_(cur){
      const c = String(cur||"").toUpperCase();
      if(c==="USD") return "$";
      if(c==="EUR") return "€";
      if(c==="GBP") return "£";
      if(c==="CDF") return "FC";
      return c ? c : "$";
    }

    function getSession_(){
      try{
        const raw = localStorage.getItem("vf_session");
        if(!raw) return null;
        const s = JSON.parse(raw);
        // on accepte email OU token (selon ton login)
        if(!s) return null;
        const hasEmail = !!String(s.email||"").trim();
        const hasToken = !!String(s.token||s.sessionToken||s.access_token||"").trim();
        if(!hasEmail && !hasToken) return null;
        return s;
      }catch{ return null; }
    }

    function getAuth_(s){
      const email = String((s && s.email) || "").trim().toLowerCase();
      const token = String((s && (s.token || s.sessionToken || s.access_token)) || "").trim();
      return { email, token };
    }

    function applyAuthUI_(){
      const btn = document.getElementById("logoutBtn");
      if(!btn) return;
      const s = getSession_();

      if(!s){
        btn.textContent = "Connexion";
        btn.disabled = false;
        btn.onclick = () => { window.location.href = "login.html"; };
        return;
      }

      btn.textContent = "Déconnexion";
      btn.disabled = false;
      btn.onclick = () => {
        localStorage.removeItem("vf_session");
        showAlert("Déconnecté.", "success");
        setTimeout(() => { window.location.href = "login.html"; }, 350);
      };
    }

    window.addEventListener("storage", (e) => {
      if(e.key === "vf_session") applyAuthUI_();
    });

    function setTopupNote_(email, note){
      const keyBase = String(email||"user").toLowerCase();
      const k = "vf_topup_note_" + keyBase;
      localStorage.setItem(k, note);
      topupNoteEl.textContent = note;
      return note;
    }

    function ensureTopupNote_(email){
      const keyBase = String(email||"user").toLowerCase();
      const k = "vf_topup_note_" + keyBase;
      let note = localStorage.getItem(k);
      if(!note){
        note = "TOPUP-" + Date.now() + "-" + Math.floor(1000 + Math.random()*9000);
        localStorage.setItem(k, note);
      }
      topupNoteEl.textContent = note;
      return note;
    }

    function copyText_(text){
      const t = String(text||"").trim();
      if(!t) return;
      navigator.clipboard?.writeText(t).then(()=> {
        showAlert("Copié.", "success");
        setTimeout(hideAlert, 900);
      }).catch(()=>{
        const ta = document.createElement("textarea");
        ta.value = t;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        showAlert("Copié.", "success");
        setTimeout(hideAlert, 900);
      });
    }

    // =========================
    // JSONP (évite CORS)
    // =========================
    function jsonp_(params, onOk, onErr, timeoutMs=12000){
      const cb = "vf_cb_" + Date.now() + "_" + Math.floor(Math.random()*1000000);
      let done = false;

      const timer = setTimeout(() => {
        if(done) return;
        done = true;
        try { delete window[cb]; } catch(_){}
        onErr && onErr("TIMEOUT");
      }, timeoutMs);

      window[cb] = function(payload){
        if(done) return;
        done = true;
        clearTimeout(timer);
        try { onOk(payload); }
        finally { try { delete window[cb]; } catch(_){} }
      };

      const s = document.createElement("script");
      const qs = new URLSearchParams({ ...params, callback: cb, t: String(Date.now()) });
      s.src = SCRIPT_URL + "?" + qs.toString();
      s.onerror = function(){
        if(done) return;
        done = true;
        clearTimeout(timer);
        try { delete window[cb]; } catch(_){}
        onErr && onErr("NETWORK");
      };
      document.body.appendChild(s);
      s.onload = () => setTimeout(() => { try { s.remove(); } catch(_){ } }, 0);
    }

    function jsonpP_(params, timeoutMs){
      return new Promise((resolve, reject) => {
        jsonp_(params, resolve, reject, timeoutMs);
      });
    }

    function fmt2(n){
      const x = Number(n||0);
      if(!isFinite(x)) return "0.00";
      return x.toFixed(2);
    }

    function isPhoneLike_(v){
      const s = String(v||"").trim();
      if(!s) return false;
      const cleaned = s.replace(/\s+/g,"");
      if(cleaned.length < 8) return false;
      return /^[+0-9][0-9+]*$/.test(cleaned);
    }

    // =========================
    // IMPORTANT :
    // On ne change pas l'Apps Script.
    // Donc ici on gère 2 noms d'actions possibles (compat) :
    // - balance: db_wallet_balance OU wallet_balance
    // - tx:      db_wallet_tx_list OU wallet_tx
    // =========================
    async function callWithFallback_(actions, params, timeoutMs=12000){
      const tries = Array.isArray(actions) ? actions : [actions];
      let last = null;

      for(const action of tries){
        try{
          const res = await jsonpP_({ ...params, action }, timeoutMs);
          // si ok => on prend
          if(res && res.ok) return { actionUsed: action, res };

          // si l'action n'existe pas => tenter la suivante
          const err = String((res && res.error) || "").toUpperCase();
          if(err.includes("UNKNOWN") || err.includes("INVALID_ACTION") || err.includes("NOT_FOUND") || err.includes("ACTION")){
            last = res;
            continue;
          }

          // autre erreur => on stop (auth, etc.)
          return { actionUsed: action, res };
        }catch(e){
          last = { ok:false, error:String(e||"NETWORK") };
          // on tente action suivante si possible
        }
      }

      return { actionUsed: tries[tries.length-1], res: (last || { ok:false, error:"NETWORK" }) };
    }

    // =========================
    // Wallet data
    // =========================
    function normalizeTxList_(res){
      const list =
        (res && Array.isArray(res.txs) && res.txs) ||
        (res && Array.isArray(res.items) && res.items) ||
        (res && Array.isArray(res.list) && res.list) ||
        (res && Array.isArray(res.data) && res.data) ||
        [];

      return list.map(tx => ({
        created_at: tx.created_at || tx.date || tx.createdAt || tx.ts || "-",
        type: tx.type || tx.kind || "-",
        amount: (tx.amount ?? tx.value ?? 0),
        ref: tx.ref || tx.note || tx.reference || tx.tx_id || tx.id || "",
        status: tx.status || "",
        currency: tx.currency || res.currency || "USD"
      }));
    }

    function renderTx_(list){
      if(!Array.isArray(list) || list.length===0){
        txBox.innerHTML = `<div class="p-4 text-sm font-bold text-gray-400">Aucune transaction.</div>`;
        return;
      }

      txBox.innerHTML = `
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-gray-50">
              <tr class="text-left text-[11px] uppercase tracking-widest text-gray-400 font-black">
                <th class="p-3">Date</th>
                <th class="p-3">Type</th>
                <th class="p-3">Montant</th>
                <th class="p-3">Ref</th>
                <th class="p-3">Statut</th>
              </tr>
            </thead>
            <tbody>
              ${list.map(tx => {
                const t = String(tx.type||"").toUpperCase();
                const cls = (t==="CREDIT") ? "text-green-700" : "text-orange-700";
                const cur = String(tx.currency||"USD").toUpperCase();
                return `
                  <tr class="border-t">
                    <td class="p-3 font-bold text-gray-500">${tx.created_at || "-"}</td>
                    <td class="p-3 font-black ${cls}">${tx.type || "-"}</td>
                    <td class="p-3 font-black text-gray-900">${fmt2(tx.amount)} ${currencySymbol_(cur)}</td>
                    <td class="p-3 font-semibold text-gray-400">${tx.ref || ""}</td>
                    <td class="p-3 font-extrabold text-gray-500">${tx.status || ""}</td>
                  </tr>
                `;
              }).join("")}
            </tbody>
          </table>
        </div>
      `;
    }

    async function loadWallet_(auth){
      balanceValue.textContent = "—";
      balanceCurrencyLabel.textContent = "USD";
      balanceCurrencySym.textContent = "$";

      const params = {
        currency: "USD",
        // compat: on envoie les deux, sans casser l'Apps Script
        email: auth.email || "",
        token: auth.token || ""
      };

      const { res } = await callWithFallback_(
        ["db_wallet_balance", "wallet_balance"],
        params,
        12000
      );

      if(res && res.ok){
        const cur = String(res.currency || "USD").toUpperCase();
        balanceCurrencyLabel.textContent = cur;
        balanceCurrencySym.textContent = currencySymbol_(cur);
        balanceValue.textContent = fmt2(res.balance);
        hideAlert();
        return;
      }

      showAlert("Impossible de charger le solde. (" + (res?.error || "ERREUR") + ")", "error");
      balanceValue.textContent = "0.00";
    }

    async function loadTx_(auth){
      txBox.innerHTML = `<div class="p-4 text-sm font-bold text-gray-400">Chargement…</div>`;

      const params = {
        currency: "USD",
        limit: "50",
        email: auth.email || "",
        token: auth.token || ""
      };

      const { res } = await callWithFallback_(
        ["db_wallet_tx_list", "wallet_tx"],
        params,
        12000
      );

      if(res && res.ok){
        const list = normalizeTxList_(res);
        renderTx_(list);
        return;
      }

      txBox.innerHTML = `<div class="p-4 text-sm font-bold text-gray-400">Historique indisponible (${res?.error || "ERREUR"}).</div>`;
    }

    // =========================
    // DEPOT MANUEL WHATSAPP
    // =========================
    function buildWhatsappMessage_({ email, amount, method, note, phone, txid }){
      const lines = [];
      lines.push("Bonjour, je veux recharger mon wallet ViralFlowr.");
      lines.push("");
      if(email) lines.push("Email: " + email);
      lines.push("Montant: " + fmt2(amount) + " USD");
      lines.push("Méthode: " + method);
      lines.push("Note: " + note);
      if(phone) lines.push("Téléphone: " + phone);
      if(txid) lines.push("TXID: " + txid);
      lines.push("");
      lines.push("Merci.");
      return lines.join("\n");
    }

    function openWhatsApp_(phoneDigits, message){
      const phone = String(phoneDigits||"").replace(/[^\d]/g,"");
      const text = encodeURIComponent(String(message||""));
      const url = "https://wa.me/" + phone + "?text=" + text;
      window.open(url, "_blank", "noopener");
    }

    function showManual_(message, meta){
      manualBox.classList.remove("hidden");
      manualText.textContent = "Clique sur WhatsApp pour envoyer le message pré-rempli au support.";
      const parts = [];
      if(meta?.amount) parts.push("Montant: " + meta.amount);
      if(meta?.method) parts.push("Méthode: " + meta.method);
      if(meta?.note) parts.push("Note: " + meta.note);
      manualMeta.textContent = parts.join(" • ");

      copyManualBtn.onclick = () => copyText_(message);
      openWaBtn.onclick = () => openWhatsApp_(WHATSAPP_SUPPORT, message);
      hideManualBtn.onclick = () => manualBox.classList.add("hidden");
    }

    // =========================
    // UI selon méthode
    // - BINANCE: champ supprimé
    // =========================
    function applyMethodUI_(){
      const method = String(methodSel.value || "MONEROO_MOMO").toUpperCase();

      field2Inp.value = "";
      field2Help.textContent = "";
      manualBox.classList.add("hidden");
      manualMeta.textContent = "";
      manualText.textContent = "";

      if(method === "MONEROO_MOMO"){
        field2Wrap.classList.remove("hidden");
        field2Label.textContent = "Téléphone (Mobile Money)";
        field2Inp.placeholder = "Ex: +243...";
        field2Inp.dataset.required = "1";
        field2Help.textContent = "Obligatoire. Exemple: +243850000000";
        methodHint.textContent = "Moneroo: redirection + retour automatique + confirmation serveur.";
        return;
      }

      if(method === "BINANCE_PAY"){
        field2Wrap.classList.add("hidden");
        methodHint.textContent = "Dépôt manuel (Binance): WhatsApp avec un message pré-rempli.";
        return;
      }

      if(method === "USDT_TRC20"){
        field2Wrap.classList.remove("hidden");
        field2Label.textContent = "TxID / Hash (optionnel)";
        field2Inp.placeholder = "Colle le hash après paiement (optionnel)";
        field2Inp.dataset.required = "0";
        field2Help.textContent = "Optionnel. Tu peux envoyer le TXID sur WhatsApp.";
        methodHint.textContent = "Dépôt manuel USDT TRC-20: WhatsApp pré-rempli + validation support.";
        return;
      }

      if(method === "USDT_BEP20"){
        field2Wrap.classList.remove("hidden");
        field2Label.textContent = "TxID / Hash (optionnel)";
        field2Inp.placeholder = "Colle le hash après paiement (optionnel)";
        field2Inp.dataset.required = "0";
        field2Help.textContent = "Optionnel. Tu peux envoyer le TXID sur WhatsApp.";
        methodHint.textContent = "Dépôt manuel USDT BEP-20: WhatsApp pré-rempli + validation support.";
        return;
      }

      field2Wrap.classList.add("hidden");
      methodHint.textContent = "Choisis une méthode.";
    }

    // =========================
    // Création dépôt
    // - Moneroo => API => redirect
    // - Binance/USDT => WhatsApp (manuel)
    // =========================
    function createTopup_(auth, note){
      const amount = Number(document.getElementById("amountInp").value || 0);
      const method = String(methodSel.value || "MONEROO_MOMO").toUpperCase();
      const field2 = String(field2Inp.value || "").trim();

      if(!amount || !isFinite(amount) || amount <= 0){
        showAlert("Entre un montant valide (USD).", "error");
        return;
      }

      const btn = document.getElementById("paidBtn");
      btn.disabled = true;
      btn.textContent = "Traitement...";

      // MONEROO
      if(method === "MONEROO_MOMO"){
        const phone = field2;
        if(!isPhoneLike_(phone)){
          btn.disabled = false;
          btn.textContent = "Continuer";
          showAlert("Téléphone Mobile Money invalide. Exemple: +243850000000", "error");
          return;
        }

        const returnUrl = window.location.origin + window.location.pathname;

        jsonp_(
          {
            action: "wallet_topup_create",
            email: auth.email || "",
            token: auth.token || "",
            note,
            amount: String(amount),
            method,
            phone,
            currency: "USD",
            return_url: returnUrl
          },
          (res) => {
            btn.disabled = false;
            btn.textContent = "Continuer";

            if(res && res.ok && res.mode === "redirect" && res.checkout_url){
              showAlert("Redirection vers Moneroo…", "success");
              setTimeout(() => { window.location.href = res.checkout_url; }, 300);
              return;
            }

            if(res && res.ok){
              showAlert("Demande enregistrée.", "success");
              setTimeout(() => { loadWallet_(auth); loadTx_(auth); }, 800);
              return;
            }

            showAlert("Impossible d’enregistrer. (" + (res?.error || "ERREUR") + ")", "error");
          },
          (why) => {
            btn.disabled = false;
            btn.textContent = "Continuer";
            showAlert("Erreur réseau/API: dépôt non enregistré. (" + why + ")", "error");
          }
        );

        return;
      }

      // DEPOT MANUEL (BINANCE/USDT)
      const txid = (method === "USDT_TRC20" || method === "USDT_BEP20") ? field2 : "";

      const waMessage = buildWhatsappMessage_({
        email: auth.email || "",
        amount,
        method,
        note,
        phone: "",
        txid
      });

      jsonp_(
        {
          action: "wallet_topup_create",
          email: auth.email || "",
          token: auth.token || "",
          note,
          amount: String(amount),
          method,
          txid: txid,
          currency: "USD",
          return_url: window.location.origin + window.location.pathname
        },
        (res) => {
          btn.disabled = false;
          btn.textContent = "Continuer";

          if(res && res.ok){
            showAlert("Dépôt manuel: message WhatsApp prêt.", "success");
            setTimeout(() => { loadTx_(auth); }, 600);
          } else {
            showAlert("Dépôt manuel: WhatsApp prêt (API: " + (res?.error || "ERREUR") + ")", "info");
          }

          showManual_(waMessage, { amount: fmt2(amount) + " USD", method, note });
          openWhatsApp_(WHATSAPP_SUPPORT, waMessage);
        },
        (_why) => {
          btn.disabled = false;
          btn.textContent = "Continuer";
          showAlert("Dépôt manuel: WhatsApp prêt.", "success");
          showManual_(waMessage, { amount: fmt2(amount) + " USD", method, note });
          openWhatsApp_(WHATSAPP_SUPPORT, waMessage);
        },
        8000
      );
    }

    // =========================
    // INIT
    // =========================
    (function(){
      applyAuthUI_();

      const s = getSession_();
      if(!s){
        showAlert("Connecte-toi d’abord pour utiliser le wallet.", "error");
        userLabel.textContent = "Non connecté";
        balanceValue.textContent = "—";
        txBox.innerHTML = `<div class="p-4 text-sm font-bold text-gray-400">Connecte-toi pour voir ton solde.</div>`;
        return;
      }

      const auth = getAuth_(s);
      userLabel.textContent = auth.email || "Utilisateur";

      let note = ensureTopupNote_(auth.email || "user");

      applyMethodUI_();
      methodSel.addEventListener("change", applyMethodUI_);

      loadWallet_(auth);
      loadTx_(auth);

      document.getElementById("refreshBtn").addEventListener("click", () => {
        loadWallet_(auth);
        loadTx_(auth);
      });
      document.getElementById("refreshTxBtn").addEventListener("click", () => loadTx_(auth));

      document.getElementById("copyNoteBtn").addEventListener("click", () => copyText_(note));
      document.getElementById("newNoteBtn").addEventListener("click", () => {
        note = setTopupNote_(auth.email || "user", "TOPUP-" + Date.now() + "-" + Math.floor(1000 + Math.random()*9000));
        showAlert("Nouvelle note générée.", "success");
        setTimeout(hideAlert, 900);
      });

      document.getElementById("paidBtn").addEventListener("click", () => createTopup_(auth, note));
    })();
  </script>

</body>
</html>
