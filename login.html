<!DOCTYPE html>
<html lang="fr" class="font-inter">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>ViralFlowr | Connexion</title>

  <meta name="theme-color" content="#111827" />
  <link rel="icon" href="favicon.png" />
  <link rel="apple-touch-icon" href="favicon.png" />

  <!-- Tailwind (dev) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    html, body { width:100%; max-width:100%; overflow-x:hidden; }
    body{
      font-family:'Inter',sans-serif;
      background:#F8FAFC;
      min-height:100svh;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .brand-gradient { background: linear-gradient(135deg, #F07E13 0%, #FFB26B 100%); }
    .icon-btn{
      display:flex; align-items:center; justify-content:center;
      width:40px; height:40px; border-radius:14px;
      background:#fff; border:1px solid #E5E7EB; color:#374151;
      transition:.2s; -webkit-tap-highlight-color: transparent;
    }
    .icon-btn:hover{ border-color:#F07E13; color:#F07E13; transform:translateY(-1px); }
    .btn-auth{
      padding: 10px 14px; border-radius: 14px; font-weight: 900; font-size: 11px;
      text-transform: uppercase; letter-spacing: .12em; transition: .25s;
      display: inline-flex; align-items: center; gap: 8px; white-space: nowrap;
      -webkit-tap-highlight-color: transparent;
    }
    .btn-auth-outline{ background:white; border:1px solid #E5E7EB; color:#111827; }
    .btn-auth-outline:hover{ border-color:#F07E13; color:#F07E13; }
    .btn-auth-solid{ color:white; }
    .badge-soft{
      display:inline-flex; align-items:center; gap:6px;
      font-size:10px; font-weight:900; letter-spacing:.16em;
      text-transform:uppercase;
      padding:7px 10px; border-radius:999px;
      border:1px solid #E5E7EB;
      background:#fff;
      color:#111827;
    }
    .field{
      height: 48px;
      border-radius: 18px;
      border: 1px solid #E5E7EB;
      background: #fff;
      padding: 0 14px;
      font-weight: 700;
      outline: none;
      width: 100%;
      transition: .2s;
    }
    .field:focus{
      border-color:#F07E13;
      box-shadow: 0 0 0 3px rgba(240,126,19,.15);
    }
  </style>

  <!-- (Optionnel) Ton fichier API global : /vf_api.js -->
  <script src="/vf_api.js"></script>
</head>

<body>

  <div class="bg-gray-900 text-white py-2 text-[10px] font-black uppercase tracking-[0.2em] text-center">
    CONNEXION • COMPTE CLIENT
  </div>

  <header class="bg-white sticky top-0 w-full z-50 border-b border-gray-100 shadow-sm">
    <div class="max-w-[1080px] mx-auto px-4 h-16 flex items-center justify-between gap-2 sm:gap-4">
      <a href="index.html" class="flex items-center gap-2 shrink-0" aria-label="ViralFlowr">
        <div class="text-2xl font-black tracking-tighter text-gray-900">
          Viral<span class="text-[#F07E13]">Flowr</span>
        </div>
      </a>

      <div class="flex items-center gap-2 sm:gap-3">
        <a href="register.html" class="btn-auth btn-auth-outline">Inscription</a>
        <a id="backBtn" href="index.html" class="icon-btn" title="Retour">
          ←
        </a>
      </div>
    </div>
  </header>

  <main class="max-w-[1080px] mx-auto px-4 py-8">
    <section class="bg-white rounded-[28px] border border-gray-100 shadow-sm p-6 md:p-10">
      <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-6">
        <div class="max-w-[520px]">
          <h1 class="text-3xl md:text-4xl font-black tracking-tighter text-gray-900">
            Connexion <span class="text-[#F07E13]">ViralFlowr</span>
          </h1>
          <p class="text-sm md:text-base font-semibold text-gray-400 mt-3 leading-relaxed">
            Connecte-toi pour accéder à ton compte et à ton portefeuille.
          </p>

          <div class="mt-5 flex flex-wrap items-center gap-2">
            <span class="badge-soft">LOGIN</span>
            <span class="badge-soft">WALLET</span>
            <span class="badge-soft">ORDERS</span>
          </div>

          <div id="alertBox" class="hidden mt-6 rounded-[18px] border p-4 text-sm font-bold"></div>
        </div>

        <div class="w-full max-w-[440px] bg-gray-50 border border-gray-100 rounded-[24px] p-5 md:p-6">
          <div class="text-[11px] font-black uppercase tracking-widest text-gray-400">Connexion</div>

          <form id="loginForm" class="mt-4 space-y-3">
            <div>
              <label class="text-xs font-black text-gray-500 uppercase tracking-widest">Email</label>
              <input id="email" type="email" class="field mt-2" placeholder="ex: client@email.com" autocomplete="email" required />
            </div>

            <div>
              <label class="text-xs font-black text-gray-500 uppercase tracking-widest">Mot de passe</label>
              <input id="password" type="password" class="field mt-2" placeholder="••••••••" autocomplete="current-password" required />
            </div>

            <button id="submitBtn" type="submit"
              class="w-full h-12 rounded-[18px] brand-gradient text-white font-black uppercase tracking-widest text-[12px] shadow-md hover:opacity-95 transition disabled:opacity-60 disabled:cursor-not-allowed">
              Se connecter
            </button>

            <div class="text-[12px] font-bold text-gray-400">
              Pas encore de compte ?
              <a id="registerLink" href="register.html" class="text-gray-900 font-black hover:text-[#F07E13]">Créer un compte</a>
            </div>
          </form>

          <div class="mt-5 text-[11px] font-bold text-gray-400">
            Conseil: utilise la même adresse email que dans la feuille <b>USERS</b>.
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- iframe caché pour transport login/register -->
  <iframe id="vfTransportFrame" name="vf_transport_iframe" style="display:none; width:0; height:0; border:0;"></iframe>

  <script>
    // =========================
    // CONFIG
    // =========================
    // Si vf_api.js définit déjà VF_WEBAPP_URL, on le garde.
    // Sinon, mets ici ton URL WebApp Apps Script (/exec).
    const VF_WEBAPP_URL = window.VF_WEBAPP_URL || "https://script.google.com/macros/s/AKfycbx_Tm3cGZs4oYdKmPieUU2SCjegAvn-BTufubyqZTFU4geAiRXN53YYE9XVGdq_uq1H/exec";

    // =========================
    // Helpers
    // =========================
    const $ = (id) => document.getElementById(id);

    function safeJsonParse_(s){
      try { return JSON.parse(s); } catch(_) { return null; }
    }

    function getSession_(){
      const raw = localStorage.getItem("vf_session");
      const obj = raw ? safeJsonParse_(raw) : null;
      if (!obj || typeof obj !== "object") return null;
      return obj;
    }

    function setAlert_(type, msg){
      const box = $("alertBox");
      if (!msg) { box.classList.add("hidden"); box.textContent = ""; return; }
      box.classList.remove("hidden");

      // styles
      box.className = "mt-6 rounded-[18px] border p-4 text-sm font-bold";
      if (type === "success") {
        box.classList.add("bg-emerald-50","border-emerald-200","text-emerald-900");
      } else if (type === "warn") {
        box.classList.add("bg-amber-50","border-amber-200","text-amber-900");
      } else {
        box.classList.add("bg-rose-50","border-rose-200","text-rose-900");
      }
      box.textContent = msg;
    }

    function setLoading_(isLoading){
      $("submitBtn").disabled = !!isLoading;
      $("submitBtn").textContent = isLoading ? "Connexion..." : "Se connecter";
    }

    function getNext_(){
      const u = new URL(window.location.href);
      const next = String(u.searchParams.get("next") || "index.html").trim();

      // Anti open-redirect : on accepte seulement un chemin local .html
      const bad = next.includes("://") || next.startsWith("//") || next.startsWith("javascript:");
      if (bad) return "index.html";
      if (!next.endsWith(".html")) return "index.html";
      return next;
    }

    function syncLinks_(){
      const next = getNext_();
      $("backBtn").href = next;
      $("registerLink").href = "register.html?next=" + encodeURIComponent(next);
    }

    // =========================
    // TRANSPORT IFRAME (Apps Script doPost + postMessage)
    // =========================
    function isAllowedSenderOrigin_(origin){
      // L'iframe Apps Script répond depuis un domaine googleusercontent.com (souvent un sous-domaine long)
      try {
        const host = new URL(origin).hostname;
        return host.endsWith("googleusercontent.com") || host.endsWith("google.com");
      } catch(_) {
        return false;
      }
    }

    function postIframe_(payload, timeoutMs = 20000){
      return new Promise((resolve, reject) => {
        const requestId = payload.request_id || ("req_" + Date.now() + "_" + Math.random().toString(16).slice(2));
        payload.request_id = requestId;

        let done = false;
        const timer = setTimeout(() => {
          if (done) return;
          done = true;
          window.removeEventListener("message", onMsg);
          reject(new Error("TIMEOUT"));
        }, timeoutMs);

        function finish_(obj){
          if (done) return;
          done = true;
          clearTimeout(timer);
          window.removeEventListener("message", onMsg);
          resolve(obj);
        }

        function onMsg(ev){
          if (!isAllowedSenderOrigin_(ev.origin)) return;

          let data = ev.data;
          if (typeof data === "string") data = safeJsonParse_(data) || data;

          if (!data || typeof data !== "object") return;
          if (String(data.request_id || "") !== String(requestId)) return;

          finish_(data);
        }

        window.addEventListener("message", onMsg);

        // construire un form invisible -> iframe
        const f = document.createElement("form");
        f.method = "POST";
        f.action = VF_WEBAPP_URL;
        f.target = "vf_transport_iframe";
        f.style.display = "none";

        // Important pour ton script: transport=iframe + origin
        const merged = Object.assign({}, payload, {
          transport: "iframe",
          origin: window.location.origin,
          request_id: requestId
        });

        Object.keys(merged).forEach(k => {
          const inp = document.createElement("input");
          inp.type = "hidden";
          inp.name = k;
          inp.value = String(merged[k] ?? "");
          f.appendChild(inp);
        });

        document.body.appendChild(f);
        try { f.submit(); } catch(e) {}
        try { f.remove(); } catch(e) {}
      });
    }

    // =========================
    // JSONP (doGet get_products) -> pour savoir si revendeur
    // =========================
    function jsonpGet_(url, timeoutMs = 15000){
      return new Promise((resolve, reject) => {
        const cb = "vf_cb_" + Date.now() + "_" + Math.random().toString(16).slice(2);
        let done = false;

        const timer = setTimeout(() => {
          if (done) return;
          done = true;
          try { delete window[cb]; } catch(_) {}
          reject(new Error("JSONP_TIMEOUT"));
        }, timeoutMs);

        window[cb] = (data) => {
          if (done) return;
          done = true;
          clearTimeout(timer);
          try { delete window[cb]; } catch(_) {}
          resolve(data);
        };

        const s = document.createElement("script");
        s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + encodeURIComponent(cb);
        s.onerror = () => {
          if (done) return;
          done = true;
          clearTimeout(timer);
          try { delete window[cb]; } catch(_) {}
          reject(new Error("JSONP_ERROR"));
        };
        document.head.appendChild(s);
      });
    }

    async function checkReseller_(token){
      // get_products renvoie ok/token_valid/is_reseller/products
      const url =
        VF_WEBAPP_URL +
        "?action=get_products" +
        "&cat=all" +
        "&token=" + encodeURIComponent(String(token || "").trim());

      const out = await jsonpGet_(url);
      return {
        token_valid: !!(out && out.token_valid),
        is_reseller: !!(out && out.is_reseller),
        reseller_email_used: String(out && out.reseller_email_used || "")
      };
    }

    // =========================
    // Submit login
    // =========================
    $("loginForm").addEventListener("submit", async (ev) => {
      ev.preventDefault();
      setAlert_("", "");
      setLoading_(true);

      const email = String($("email").value || "").trim().toLowerCase();
      const password = String($("password").value || "");

      if (!email || email.indexOf("@") < 1) {
        setLoading_(false);
        setAlert_("error", "Email invalide.");
        return;
      }
      if (!password || password.length < 6) {
        setLoading_(false);
        setAlert_("error", "Mot de passe trop court.");
        return;
      }

      try {
        const res = await postIframe_({
          action: "login",
          email,
          password
        });

        if (!res || !res.ok) {
          const msg = (res && res.message) ? String(res.message) : "Connexion échouée.";
          setAlert_("error", msg);
          setLoading_(false);
          return;
        }

        const token = String(res.token || "").trim();
        const username = String(res.user && res.user.username || "").trim();
        const emailBack = String(res.user && res.user.email || email).trim().toLowerCase();

        // Enregistrer session
        const session = {
          email: emailBack,
          username,
          token,
          is_reseller: false,
          token_valid: true,
          created_at: Date.now()
        };

        // Vérifier revendeur via doGet (jsonp) -> évite “token => revendeur”
        try {
          if (token) {
            const st = await checkReseller_(token);
            session.is_reseller = !!st.is_reseller;
            session.token_valid = !!st.token_valid;

            // vf_token UNIQUEMENT SI revendeur
            if (session.is_reseller) localStorage.setItem("vf_token", token);
            else localStorage.removeItem("vf_token");
          } else {
            localStorage.removeItem("vf_token");
          }
        } catch(_) {
          // si check échoue, on reste en prix public (sécurisé)
          localStorage.removeItem("vf_token");
        }

        localStorage.setItem("vf_session", JSON.stringify(session));
        localStorage.setItem("vf_session_changed", String(Date.now()));

        setAlert_("success", "Connexion réussie ✅ Redirection...");
        const next = getNext_();
        setTimeout(() => { window.location.href = next; }, 350);

      } catch (err) {
        setAlert_("error", "Erreur connexion (transport). Vérifie l’URL WebApp et le déploiement.");
        setLoading_(false);
      }
    });

    // =========================
    // Init
    // =========================
    syncLinks_();

    // Si déjà connecté -> redirection directe
    (function(){
      const s = getSession_();
      if (s && s.token) {
        const next = getNext_();
        // option: si tu veux forcer rester sur login, commente la ligne suivante
        window.location.href = next;
      }
    })();
  </script>

</body>
</html>
