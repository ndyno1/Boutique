<!DOCTYPE html>
<html lang="fr" class="font-inter">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>ViralFlowr | Boutique</title>

  <meta name="theme-color" content="#111827" />
  <link rel="icon" href="favicon.png" />
  <link rel="apple-touch-icon" href="favicon.png" />

  <!-- Tailwind (dev) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    html, body { width:100%; max-width:100%; overflow-x:hidden; }
    body{
      font-family:'Inter',sans-serif;
      background:#F8FAFC;
      min-height:100svh;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .brand-gradient { background: linear-gradient(135deg, #F07E13 0%, #FFB26B 100%); }
    .icon-btn{
      display:flex; align-items:center; justify-content:center;
      width:40px; height:40px; border-radius:14px;
      background:#fff; border:1px solid #E5E7EB; color:#374151;
      transition:.2s; -webkit-tap-highlight-color: transparent;
    }
    .icon-btn:hover{ border-color:#F07E13; color:#F07E13; transform:translateY(-1px); }
    .btn-auth{
      padding: 9px 14px; border-radius: 14px; font-weight: 900; font-size: 11px;
      text-transform: uppercase; letter-spacing: .12em; transition: .25s;
      display: inline-flex; align-items: center; gap: 8px; white-space: nowrap;
      -webkit-tap-highlight-color: transparent;
    }
    .btn-auth-outline{ background:white; border:1px solid #E5E7EB; color:#111827; }
    .btn-auth-outline:hover{ border-color:#F07E13; color:#F07E13; }
    .btn-auth-solid{ color:white; }
    .badge-soft{
      display:inline-flex; align-items:center; gap:6px;
      font-size:10px; font-weight:900; letter-spacing:.16em;
      text-transform:uppercase;
      padding:7px 10px; border-radius:999px;
      border:1px solid #E5E7EB;
      background:#fff;
      color:#111827;
    }
    .price{ font-weight:900; letter-spacing:-.02em; }
    .card-hover{ transition: .2s; }
    .card-hover:hover{
      transform: translateY(-2px);
      box-shadow: 0 12px 30px rgba(17,24,39,.08);
      border-color:#F07E13;
    }
    .clamp3{
      display:-webkit-box;
      -webkit-line-clamp:3;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
  </style>
</head>

<body>

  <div class="bg-gray-900 text-white py-2 text-[10px] font-black uppercase tracking-[0.2em] text-center">
    BOUTIQUE • SERVICES & ABONNEMENTS
  </div>

  <header class="bg-white sticky top-0 w-full z-50 border-b border-gray-100 shadow-sm">
    <div class="max-w-[1280px] mx-auto px-4 h-16 flex items-center justify-between gap-2 sm:gap-4">
      <a href="index.html" class="flex items-center gap-2 shrink-0" aria-label="ViralFlowr">
        <div class="text-2xl font-black tracking-tighter text-gray-900">
          Viral<span class="text-[#F07E13]">Flowr</span>
        </div>
      </a>

      <div class="flex items-center gap-2 sm:gap-3">
        <!-- Etat connexion -->
        <div id="authGuest" class="flex items-center gap-2 sm:gap-3">
          <a href="login.html?next=index.html" class="btn-auth btn-auth-outline">Connexion</a>
          <a href="register.html?next=index.html" class="btn-auth brand-gradient btn-auth-solid">Inscription</a>
        </div>

        <div id="authUser" class="hidden items-center gap-2 sm:gap-3">
          <button id="accountBtn" class="btn-auth btn-auth-outline" type="button" title="Compte">
            <span class="hidden sm:inline">Compte</span>
            <span id="userTag" class="text-gray-400 font-black tracking-widest text-[10px] hidden md:inline">—</span>
          </button>
          <button id="logoutBtn" class="btn-auth btn-auth-outline" type="button" title="Déconnexion">
            Déconnexion
          </button>
        </div>

        <button id="cartBtn" class="icon-btn" title="Panier (démo)" aria-label="Panier">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="9" cy="21" r="1"></circle>
            <circle cx="20" cy="21" r="1"></circle>
            <path d="M1 1h4l2.7 13.4a2 2 0 0 0 2 1.6h9.7a2 2 0 0 0 2-1.6L23 6H6"></path>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-[1280px] mx-auto px-4 py-8">
    <!-- Bandeau statut -->
    <div id="statusBar" class="hidden mb-6 rounded-[22px] border border-gray-100 bg-white p-4 md:p-5 shadow-sm">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div class="flex items-start gap-3">
          <div class="w-10 h-10 rounded-2xl brand-gradient flex items-center justify-center text-white font-black">VF</div>
          <div>
            <div class="text-sm font-black text-gray-900" id="statusTitle">Statut</div>
            <div class="text-xs font-bold text-gray-400" id="statusSubtitle">—</div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <span id="priceModeBadge" class="badge-soft">PRIX PUBLIC</span>
          <a id="goLoginCta" href="login.html?next=index.html" class="btn-auth brand-gradient btn-auth-solid hidden">
            Activer prix revendeur
          </a>
        </div>
      </div>
    </div>

    <!-- Hero -->
    <section class="bg-white rounded-[28px] border border-gray-100 shadow-sm p-6 md:p-10">
      <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-6">
        <div>
          <h1 class="text-3xl md:text-4xl font-black tracking-tighter text-gray-900">
            Boutique <span class="text-[#F07E13]">ViralFlowr</span>
          </h1>
          <p class="text-sm md:text-base font-semibold text-gray-400 mt-3 max-w-[720px] leading-relaxed">
            Achète tes services en quelques clics. Si tu es revendeur, connecte-toi pour afficher les <span class="text-gray-900">prix revendeur</span>.
          </p>

          <div class="mt-5 flex flex-wrap items-center gap-2">
            <span class="badge-soft">PAYMENTS</span>
            <span class="badge-soft">AUTO-DELIVERY</span>
            <span class="badge-soft">SUPPORT</span>
          </div>
        </div>

        <div class="bg-gray-50 border border-gray-100 rounded-[24px] p-4 md:p-5 min-w-[280px]">
          <div class="text-[11px] font-black uppercase tracking-widest text-gray-400">Session</div>
          <div class="mt-2 text-sm font-black text-gray-900" id="sessionLine">Chargement…</div>
          <div class="mt-1 text-xs font-bold text-gray-400" id="tokenLine">Token: —</div>
        </div>
      </div>
    </section>

    <!-- Produits -->
    <section class="mt-8">
      <div class="flex items-end justify-between gap-4">
        <h2 class="text-xl md:text-2xl font-black tracking-tighter text-gray-900">Services</h2>

        <div class="flex items-center gap-2">
          <input id="searchInput" type="text"
            class="h-11 w-[220px] md:w-[320px] px-4 rounded-2xl bg-white border border-gray-100 shadow-sm text-sm font-semibold outline-none focus:ring-2 focus:ring-[#F07E13]"
            placeholder="Rechercher un service..." />
        </div>
      </div>

      <div id="productsGrid" class="mt-5 grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
    </section>
  </main>

  <!-- Modal -->
  <div id="modal" class="hidden fixed inset-0 z-[999] bg-black/40 p-4">
    <div class="max-w-[560px] mx-auto mt-10 bg-white rounded-[26px] border border-gray-100 shadow-xl overflow-hidden">
      <div class="p-5 border-b border-gray-100 flex items-center justify-between">
        <div>
          <div class="text-lg font-black tracking-tighter text-gray-900" id="modalTitle">—</div>
          <div class="text-xs font-bold text-gray-400" id="modalSubtitle">—</div>
        </div>
        <button id="closeModal" class="icon-btn" aria-label="Fermer">✕</button>
      </div>

      <div class="p-5">
        <div class="text-sm font-semibold text-gray-600 leading-relaxed" id="modalDesc">—</div>

        <div class="mt-5 flex items-center justify-between gap-3 bg-gray-50 border border-gray-100 rounded-2xl p-4">
          <div>
            <div class="text-[11px] font-black uppercase tracking-widest text-gray-400">Prix</div>
            <div class="mt-1 text-2xl font-black text-gray-900 price" id="modalPrice">—</div>
            <div class="mt-1 text-[11px] font-black text-gray-400 hidden" id="modalPublicLine">—</div>
          </div>

          <button id="buyBtn"
            class="h-11 px-5 rounded-2xl brand-gradient text-white font-black uppercase tracking-widest text-[12px] shadow-md hover:opacity-95 transition">
            Commander
          </button>
        </div>

        <div class="mt-4 text-[11px] font-bold text-gray-400" id="modalHint">
          Le bouton “Commander” ouvre le lien de paiement du produit (si défini dans Produits).
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ Ton fichier API à la racine -->
  <script src="/vf_api.js?v=18.4"></script>

  <script>
    // =========================================================
    // CONFIG
    // =========================================================
    // Option A (recommandé) : dans /vf_api.js tu mets :
    // window.VF_API_URL = "https://script.google.com/macros/s/XXXX/exec";
    //
    // Option B : sinon colle ton URL ici :
    const VF_API_URL = (window.VF_API_URL || "").trim() || "PASTE_YOUR_WEBAPP_EXEC_URL_HERE";

    // =========================================================
    // Helpers
    // =========================================================
    const $ = (id) => document.getElementById(id);

    function safeJsonParse_(s){ try { return JSON.parse(s); } catch(_) { return null; } }

    function escapeHtml_(str){
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function formatPrice_(n){
      const v = Number(n || 0);
      if (!isFinite(v) || v <= 0) return "Sur devis";
      return (v % 1 === 0 ? v.toFixed(0) : v.toFixed(2)) + " $";
    }

    function getSession_(){
      const raw = localStorage.getItem("vf_session");
      const obj = raw ? safeJsonParse_(raw) : null;
      if (!obj || typeof obj !== "object") return null;
      return obj;
    }

    function getToken_(){
      return String(localStorage.getItem("vf_token") || "").trim();
    }

    // =========================================================
    // JSONP (pour éviter CORS) -> compatible doGet() Apps Script
    // =========================================================
    function jsonp_(url){
      return new Promise((resolve, reject) => {
        const cb = "vfcb_" + Math.random().toString(36).slice(2) + "_" + Date.now();
        const s = document.createElement("script");
        let done = false;

        window[cb] = (data) => {
          done = true;
          try { resolve(data); } finally {
            try { delete window[cb]; } catch(_) {}
            try { s.remove(); } catch(_) {}
          }
        };

        s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + encodeURIComponent(cb);
        s.async = true;
        s.onerror = () => {
          if (done) return;
          try { delete window[cb]; } catch(_) {}
          try { s.remove(); } catch(_) {}
          reject(new Error("JSONP_LOAD_FAIL"));
        };

        document.head.appendChild(s);

        setTimeout(() => {
          if (done) return;
          try { delete window[cb]; } catch(_) {}
          try { s.remove(); } catch(_) {}
          reject(new Error("JSONP_TIMEOUT"));
        }, 15000);
      });
    }

    function buildUrl_(base, params){
      const u = new URL(base);
      Object.keys(params || {}).forEach(k => {
        const v = params[k];
        if (v === null || v === undefined || String(v).trim() === "") return;
        u.searchParams.set(k, String(v));
      });
      return u.toString();
    }

    async function apiGetProducts_(token){
      if (!VF_API_URL || VF_API_URL.includes("PASTE_YOUR_WEBAPP_EXEC_URL_HERE")) {
        throw new Error("VF_API_URL_NOT_SET");
      }
      const url = buildUrl_(VF_API_URL, {
        action: "get_products",
        cat: "all",
        token: token || ""
      });
      return await jsonp_(url);
    }

    // =========================================================
    // State
    // =========================================================
    const state = {
      products: [],
      lastApi: null,          // dernière réponse get_products
      loading: true,
      error: ""
    };

    function normalizeProduct_(p){
      // Réponse serveur (doGet get_products) -> item
      return {
        id: String(p.id || "").trim(),
        name: String(p.nom || "").trim(),
        desc: String(p.desc || "").trim(),
        long_desc: String(p.long_desc || "").trim(),
        cat: String(p.cat || "").trim(),
        img: String(p.img || "").trim(),
        pay_link: String(p.pay_link || "").trim(),
        min: String(p.min ?? "").trim(),
        max: String(p.max ?? "").trim(),

        // Prix (serveur)
        prix_affiche: Number(p.prix_affiche || p.prix || 0),
        prix_client: Number(p.prix_client || 0),
        reseller_prix: Number(p.reseller_prix || 0)
      };
    }

    // =========================================================
    // UI Auth + Status
    // =========================================================
    function renderAuthUI_(){
      const session = getSession_();
      const token = getToken_();

      // Auth UI
      if (session) {
        $("authGuest").classList.add("hidden");
        $("authUser").classList.remove("hidden");
        $("authUser").classList.add("flex");
        $("userTag").textContent = (session.username || session.email || "Utilisateur");
      } else {
        $("authUser").classList.add("hidden");
        $("authUser").classList.remove("flex");
        $("authGuest").classList.remove("hidden");
      }

      // Session box
      $("sessionLine").textContent = session ? ("Connecté : " + (session.email || "—")) : "Non connecté";
      $("tokenLine").textContent = "Token: " + (token ? (token.slice(0, 6) + "…" + token.slice(-4)) : "—");

      // Status bar
      $("statusBar").classList.remove("hidden");

      // Données serveur
      const api = state.lastApi || {};
      const tokenValid = !!api.token_valid;
      const isReseller = !!api.is_reseller;

      if (!session) {
        $("statusTitle").textContent = "Mode invité";
        $("statusSubtitle").textContent = "Connecte-toi pour afficher les prix revendeur (si autorisé).";
        $("priceModeBadge").textContent = "PRIX PUBLIC";
        $("goLoginCta").classList.remove("hidden");
      } else if (token && tokenValid && isReseller) {
        $("statusTitle").textContent = "Prix revendeur activés";
        $("statusSubtitle").textContent = "Ton token est valide. Prix revendeur affichés.";
        $("priceModeBadge").textContent = "PRIX REVENDEUR";
        $("goLoginCta").classList.add("hidden");
      } else if (token && !tokenValid) {
        $("statusTitle").textContent = "Token expiré / invalide";
        $("statusSubtitle").textContent = "Reconnecte-toi pour régénérer un token valide.";
        $("priceModeBadge").textContent = "PRIX PUBLIC";
        $("goLoginCta").classList.remove("hidden");
      } else {
        $("statusTitle").textContent = "Connecté (prix public)";
        $("statusSubtitle").textContent = "Ton compte est connecté, mais pas en mode revendeur.";
        $("priceModeBadge").textContent = "PRIX PUBLIC";
        $("goLoginCta").classList.add("hidden");
      }
    }

    // =========================================================
    // Render products
    // =========================================================
    function renderProducts_(list){
      const grid = $("productsGrid");
      grid.innerHTML = "";

      if (!list || !list.length) {
        grid.innerHTML = `
          <div class="col-span-full bg-white rounded-[26px] border border-gray-100 shadow-sm p-6">
            <div class="text-lg font-black text-gray-900">Aucun service trouvé</div>
            <div class="mt-2 text-sm font-semibold text-gray-400">Essaie une autre recherche.</div>
          </div>
        `;
        return;
      }

      const api = state.lastApi || {};
      const isReseller = !!api.is_reseller;

      list.forEach(p => {
        const card = document.createElement("div");
        card.className = "bg-white rounded-[26px] border border-gray-100 shadow-sm p-5 card-hover cursor-pointer";

        const showClientLine = isReseller && p.prix_client > 0 && p.prix_affiche > 0 && p.prix_affiche !== p.prix_client;

        card.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <div class="text-[11px] font-black uppercase tracking-widest text-gray-400">${escapeHtml_(p.cat || "—")}</div>
              <div class="mt-1 text-lg font-black tracking-tighter text-gray-900 truncate">${escapeHtml_(p.name || "—")}</div>
              <div class="mt-1 text-xs font-bold text-gray-400 truncate">${escapeHtml_(p.id || "—")}</div>
            </div>
            <span class="badge-soft">VF</span>
          </div>

          <div class="mt-4 text-sm font-semibold text-gray-600 leading-relaxed clamp3">
            ${escapeHtml_(p.desc || p.long_desc || "")}
          </div>

          <div class="mt-5 flex items-end justify-between gap-3 bg-gray-50 border border-gray-100 rounded-2xl p-4">
            <div class="min-w-0">
              <div class="text-[11px] font-black uppercase tracking-widest text-gray-400">Prix</div>

              <div class="mt-1 text-2xl font-black text-gray-900 price">
                ${formatPrice_(p.prix_affiche)}
              </div>

              <div class="mt-1 text-[11px] font-black text-gray-400 ${showClientLine ? "" : "hidden"}">
                Public: <span class="line-through">${formatPrice_(p.prix_client)}</span>
              </div>
            </div>

            <div class="flex items-center gap-2 shrink-0">
              <span class="text-[10px] font-black uppercase tracking-[0.2em] text-gray-400">VOIR</span>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#111827" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 18l6-6-6-6"></path>
              </svg>
            </div>
          </div>
        `;

        card.addEventListener("click", () => openModal_(p));
        grid.appendChild(card);
      });
    }

    // =========================================================
    // Modal
    // =========================================================
    function openModal_(p){
      const api = state.lastApi || {};
      const isReseller = !!api.is_reseller;

      $("modalTitle").textContent = p.name || "—";
      $("modalSubtitle").textContent = (p.id || "—") + (p.cat ? (" • " + p.cat) : "");
      $("modalDesc").textContent = (p.long_desc || p.desc || "").trim() || "—";

      $("modalPrice").textContent = formatPrice_(p.prix_affiche);

      const showClientLine = isReseller && p.prix_client > 0 && p.prix_affiche > 0 && p.prix_affiche !== p.prix_client;
      $("modalPublicLine").classList.toggle("hidden", !showClientLine);
      $("modalPublicLine").textContent = showClientLine ? ("Prix public: " + formatPrice_(p.prix_client)) : "";

      $("modal").classList.remove("hidden");
      document.body.style.overflow = "hidden";

      $("buyBtn").onclick = () => {
        if (p.pay_link && /^https?:\/\//i.test(p.pay_link)) {
          window.open(p.pay_link, "_blank", "noopener,noreferrer");
          return;
        }
        alert("Lien de paiement non défini pour ce produit (colonne pay_link dans Produits).");
      };
    }

    function closeModal_(){
      $("modal").classList.add("hidden");
      document.body.style.overflow = "";
    }

    $("closeModal").addEventListener("click", closeModal_);
    $("modal").addEventListener("click", (e) => { if (e.target === $("modal")) closeModal_(); });

    // =========================================================
    // Logout / UI buttons
    // =========================================================
    $("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("vf_session");
      localStorage.removeItem("vf_token");
      localStorage.setItem("vf_session_changed", String(Date.now()));
      // refresh
      boot_();
    });

    $("cartBtn").addEventListener("click", () => alert("Panier (démo)."));
    $("accountBtn").addEventListener("click", () => {
      const s = getSession_();
      alert(s ? ("Compte: " + (s.email || "—")) : "Non connecté");
    });

    // =========================================================
    // Search
    // =========================================================
    $("searchInput").addEventListener("input", () => {
      const q = String($("searchInput").value || "").trim().toLowerCase();
      const filtered = state.products.filter(p =>
        (p.name || "").toLowerCase().includes(q) ||
        (p.id || "").toLowerCase().includes(q) ||
        (p.cat || "").toLowerCase().includes(q)
      );
      renderProducts_(filtered);
    });

    // Sync onglets
    window.addEventListener("storage", (e) => {
      if (e.key === "vf_session_changed" || e.key === "vf_session" || e.key === "vf_token") {
        boot_();
      }
    });

    // =========================================================
    // Boot
    // =========================================================
    async function boot_(){
      state.loading = true;
      state.error = "";

      // Affichage rapide
      renderAuthUI_();
      $("productsGrid").innerHTML = `
        <div class="col-span-full bg-white rounded-[26px] border border-gray-100 shadow-sm p-6">
          <div class="text-lg font-black text-gray-900">Chargement des services…</div>
          <div class="mt-2 text-sm font-semibold text-gray-400">Connexion au serveur…</div>
        </div>
      `;

      const token = getToken_();

      try {
        const res = await apiGetProducts_(token);
        state.lastApi = res || null;

        if (!res || !res.ok) {
          const d = res ? (res.details || res.error || "Erreur inconnue") : "Réponse vide";
          throw new Error("GET_PRODUCTS_FAIL: " + d);
        }

        const products = (res.products || []).map(normalizeProduct_).filter(x => x.id && x.name);
        state.products = products;

        // Render
        renderProducts_(state.products);
        renderAuthUI_();

      } catch (err) {
        state.error = String(err && err.message ? err.message : err);

        $("productsGrid").innerHTML = `
          <div class="col-span-full bg-white rounded-[26px] border border-red-100 shadow-sm p-6">
            <div class="text-lg font-black text-gray-900">Impossible de charger les services</div>
            <div class="mt-2 text-sm font-semibold text-gray-400 break-words">
              ${escapeHtml_(state.error)}
            </div>
            <div class="mt-4 text-xs font-bold text-gray-400">
              Vérifie VF_API_URL (WebApp) et que l’action get_products fonctionne.
            </div>
          </div>
        `;

        // Status bar
        $("statusBar").classList.remove("hidden");
        $("statusTitle").textContent = "Serveur non joignable";
        $("statusSubtitle").textContent = "Erreur de chargement des produits.";
        $("priceModeBadge").textContent = "PRIX PUBLIC";
        $("goLoginCta").classList.add("hidden");

        renderAuthUI_();
      } finally {
        state.loading = false;
      }
    }

    // INIT
    boot_();
  </script>

</body>
</html>
