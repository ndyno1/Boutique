<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ViralFlowr | Connexion</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">

  <style>
    body{ font-family:Inter,system-ui,sans-serif; background:#F8FAFC; }
    .brand-gradient { background: linear-gradient(135deg, #F07E13 0%, #FFB26B 100%); }
  </style>
</head>

<body class="min-h-screen flex items-center justify-center px-4">
  <div class="w-full max-w-md bg-white border border-gray-100 shadow-sm rounded-3xl p-6">
    <div class="text-2xl font-black tracking-tight text-gray-900">
      Viral<span class="text-[#F07E13]">Flowr</span>
    </div>
    <div class="mt-1 text-sm font-semibold text-gray-400">
      Connexion à ton compte
    </div>

    <div id="msg" class="mt-4 hidden rounded-2xl border p-3 text-sm font-semibold"></div>

    <form id="loginForm" class="mt-5 space-y-3">
      <div>
        <label class="text-xs font-black uppercase tracking-widest text-gray-400">Email</label>
        <input id="email" type="email" required
          class="mt-1 h-11 w-full px-4 rounded-2xl bg-white border border-gray-200 shadow-sm text-sm font-semibold outline-none focus:ring-2 focus:ring-[#F07E13]"
          placeholder="ex: test@gmail.com" />
      </div>

      <div>
        <label class="text-xs font-black uppercase tracking-widest text-gray-400">Mot de passe</label>
        <input id="password" type="password" required
          class="mt-1 h-11 w-full px-4 rounded-2xl bg-white border border-gray-200 shadow-sm text-sm font-semibold outline-none focus:ring-2 focus:ring-[#F07E13]"
          placeholder="••••••••" />
      </div>

      <button id="btn" type="submit"
        class="w-full h-11 rounded-2xl brand-gradient text-white font-black uppercase tracking-widest text-[12px] shadow-md hover:opacity-95 transition">
        Se connecter
      </button>
    </form>

    <div class="mt-4 text-xs font-bold text-gray-400">
      Pas de compte ? <a class="text-gray-900 hover:underline" href="register.html">Créer un compte</a>
    </div>
  </div>

  <script>
  /** ===========================
   *  VF API CLIENT (NO CORS)
   *  - GET => JSONP
   *  - POST => hidden iframe form + postMessage (si ton GAS renvoie postMessage)
   * =========================== */

  const VF_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx_Tm3cGZs4oYdKmPieUU2SCjegAvn-BTufubyqZTFU4geAiRXN53YYE9XVGdq_uq1H/exec";

  (function initVfBridge(){
    if (window.__vfBridgeReady) return;
    window.__vfBridgeReady = true;

    const pending = new Map();

    function ensureIframe_(){
      if (document.getElementById("vf_iframe")) return;
      const iframe = document.createElement("iframe");
      iframe.name = "vf_iframe";
      iframe.id = "vf_iframe";
      iframe.style.display = "none";
      document.body.appendChild(iframe);
    }

    // écoute réponses postMessage
    window.addEventListener("message", (event) => {
      const o = String(event.origin || "");
      const okOrigin = (o === "https://script.google.com") || o.endsWith(".googleusercontent.com");
      if (!okOrigin) return;

      let msg = event.data;
      try { if (typeof msg === "string") msg = JSON.parse(msg); } catch(_) {}

      if (!msg || typeof msg !== "object") return;
      const rid = msg.request_id;
      if (!rid || !pending.has(rid)) return;

      const { resolve, timer } = pending.get(rid);
      clearTimeout(timer);
      pending.delete(rid);
      resolve(msg);
    });

    // JSONP GET
    function vfJsonp(action, params = {}, timeoutMs = 15000){
      return new Promise((resolve, reject) => {
        const cb = "__vf_cb_" + Date.now() + "_" + Math.floor(Math.random() * 1e6);

        const timer = setTimeout(() => {
          try { delete window[cb]; } catch(_) {}
          script.remove();
          reject(new Error("JSONP_TIMEOUT"));
        }, timeoutMs);

        window[cb] = (data) => {
          clearTimeout(timer);
          try { resolve(data); } finally {
            try { delete window[cb]; } catch(_) {}
            script.remove();
          }
        };

        const qs = new URLSearchParams({ action, callback: cb, ...params });
        const script = document.createElement("script");
        script.src = VF_SCRIPT_URL + "?" + qs.toString();
        script.onerror = () => {
          clearTimeout(timer);
          try { delete window[cb]; } catch(_) {}
          script.remove();
          reject(new Error("JSONP_ERROR"));
        };
        document.head.appendChild(script);
      });
    }

    // POST iframe
    function vfPost(payload = {}, timeoutMs = 15000){
      return new Promise((resolve) => {
        ensureIframe_();

        const rid = "REQ-" + Date.now() + "-" + Math.floor(Math.random() * 1e6);

        const timer = setTimeout(() => {
          if (!pending.has(rid)) return;
          pending.delete(rid);
          resolve({ ok:false, error:"TRANSPORT_TIMEOUT", details:"Le serveur n’a pas répondu via postMessage." , request_id: rid });
        }, timeoutMs);

        pending.set(rid, { resolve, timer });

        const form = document.createElement("form");
        form.method = "POST";
        form.action = VF_SCRIPT_URL;
        form.target = "vf_iframe";

        const add = (k, v) => {
          const input = document.createElement("input");
          input.type = "hidden";
          input.name = k;
          input.value = (v === undefined || v === null) ? "" : String(v);
          form.appendChild(input);
        };

        add("transport", "iframe");
        add("origin", location.origin);
        add("request_id", rid);

        Object.keys(payload).forEach((k) => add(k, payload[k]));

        document.body.appendChild(form);
        form.submit();

        setTimeout(() => { try { form.remove(); } catch(_) {} }, 1500);
      });
    }

    // API globale
    window.VF_API = {
      // GET
      getProducts: ({ cat="all", token="" } = {}) => vfJsonp("get_products", { cat, token }),
      orderHistory: ({ email, limit=80 } = {}) => vfJsonp("order_history", { email, limit }),

      // POST
      register: ({ username, email, password }) => vfPost({ action:"register", username, email, password }),
      login: ({ email, password }) => vfPost({ action:"login", email, password }),

      walletBalance: ({ token, currency="USD" }) => vfPost({ action:"db_wallet_balance", token, currency }),
      walletTopupCreate: (data) => vfPost({ action:"db_wallet_topup_create", ...data }),
      walletPay: (data) => vfPost({ action:"wallet_pay", ...data }),
      resellerPay: (data) => vfPost({ action:"reseller_pay", ...data }),
      createOrder: (data) => vfPost({ ...data }),
      chatSupport: ({ chat, orderId, email }) => vfPost({ chat, orderId, email }),
    };
  })();
  </script>

  <script>
    const $ = (id) => document.getElementById(id);

    function showMsg(type, text){
      const box = $("msg");
      box.classList.remove("hidden");
      box.className = "mt-4 rounded-2xl border p-3 text-sm font-semibold";
      if (type === "ok") box.classList.add("border-green-200","bg-green-50","text-green-900");
      else box.classList.add("border-red-200","bg-red-50","text-red-900");
      box.textContent = text;
    }

    function getNext(){
      const u = new URL(location.href);
      return u.searchParams.get("next") || "index.html";
    }

    // Si déjà connecté
    try{
      const s = JSON.parse(localStorage.getItem("vf_session") || "null");
      if (s && (s.email || s.username)) location.href = getNext();
    }catch(_){}

    $("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const email = $("email").value.trim();
      const password = $("password").value;

      $("btn").disabled = true;
      $("btn").classList.add("opacity-70");
      showMsg("ok", "Connexion en cours...");

      try{
        const res = await window.VF_API.login({ email, password });

        if (!res || res.ok !== true){
          const err = (res && (res.error || res.message)) ? (res.error || res.message) : "LOGIN_FAILED";
          const det = (res && res.details) ? (" - " + res.details) : "";
          showMsg("err", "Erreur connexion: " + err + det);
          $("btn").disabled = false;
          $("btn").classList.remove("opacity-70");
          return;
        }

        // Sauvegarde session + token (si présent)
        if (res.session) localStorage.setItem("vf_session", JSON.stringify(res.session));
        if (res.token) localStorage.setItem("vf_token", String(res.token));
        localStorage.setItem("vf_session_changed", String(Date.now()));

        showMsg("ok", "Connecté. Redirection...");
        setTimeout(() => location.href = getNext(), 400);

      }catch(err){
        showMsg("err", "Erreur connexion (transport): " + (err && err.message ? err.message : String(err)));
        $("btn").disabled = false;
        $("btn").classList.remove("opacity-70");
      }
    });
  </script>
</body>
</html>
