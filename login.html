<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Connexion | ViralFlowr</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    body { font-family: Inter, sans-serif; }
  </style>
</head>

<body class="bg-slate-50 min-h-screen flex items-center justify-center px-4">

  <div class="w-full max-w-md bg-white rounded-3xl shadow-sm border border-slate-100 p-6">
    <div class="mb-6">
      <div class="text-2xl font-black tracking-tight">
        Viral<span class="text-[#F07E13]">Flowr</span>
      </div>
      <div class="text-slate-500 font-semibold text-sm mt-1">Connexion revendeur / client</div>
    </div>

    <div id="msg" class="hidden mb-4 text-sm font-bold rounded-2xl px-4 py-3"></div>

    <form id="loginForm" class="space-y-4">
      <div>
        <label class="text-xs font-extrabold uppercase tracking-widest text-slate-400">Email</label>
        <input id="email" name="email" type="email" autocomplete="username" required
          class="mt-2 w-full h-11 px-4 rounded-2xl bg-slate-100 font-semibold outline-none focus:ring-2 focus:ring-[#F07E13]" />
      </div>

      <div>
        <label class="text-xs font-extrabold uppercase tracking-widest text-slate-400">Mot de passe</label>
        <input id="password" name="password" type="password" autocomplete="current-password" required
          class="mt-2 w-full h-11 px-4 rounded-2xl bg-slate-100 font-semibold outline-none focus:ring-2 focus:ring-[#F07E13]" />
      </div>

      <button id="btn" type="submit"
        class="w-full h-12 rounded-2xl font-black text-white shadow-sm"
        style="background: linear-gradient(135deg, #F07E13 0%, #FFB26B 100%);">
        Se connecter
      </button>

      <div class="text-center text-xs font-bold text-slate-400">
        Pas de compte ? <a class="text-[#F07E13]" href="register.html">Créer un compte</a>
      </div>
    </form>
  </div>

  <script>
    // ✅ Mets ton URL Apps Script ici
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx_Tm3cGZs4oYdKmPieUU2SCjegAvn-BTufubyqZTFU4geAiRXN53YYE9XVGdq_uq1H/exec";

    const form = document.getElementById("loginForm");
    const msg  = document.getElementById("msg");
    const btn  = document.getElementById("btn");

    let activeRequestId = "";

    function uid() {
      return "REQ-" + Date.now() + "-" + Math.floor(Math.random() * 1e9);
    }

    function show(type, text) {
      msg.classList.remove("hidden");
      msg.textContent = text;

      msg.classList.remove("bg-red-50","border-red-200","text-red-700");
      msg.classList.remove("bg-green-50","border-green-200","text-green-700");
      msg.classList.add("border");

      if (type === "ok") {
        msg.classList.add("bg-green-50","border-green-200","text-green-700");
      } else {
        msg.classList.add("bg-red-50","border-red-200","text-red-700");
      }
    }

    function setLoading(on) {
      btn.disabled = !!on;
      btn.style.opacity = on ? "0.75" : "1";
      btn.textContent = on ? "Connexion..." : "Se connecter";
    }

    function clearOldTransport() {
      const oldFrame = document.getElementById("vf_login_iframe");
      if (oldFrame) oldFrame.remove();

      const oldForm = document.getElementById("vf_login_post_form");
      if (oldForm) oldForm.remove();
    }

    // ✅ Listener: on accepte UNIQUEMENT la réponse venant de googleusercontent/script
    window.addEventListener("message", (ev) => {
      const okOrigin =
        (typeof ev.origin === "string") &&
        (ev.origin.includes("script.googleusercontent.com") || ev.origin.includes("script.google.com"));

      if (!okOrigin) return;

      const res = ev.data;
      if (!res || typeof res !== "object") return;

      // ✅ anti-mix: on vérifie request_id
      if (activeRequestId && res.request_id && res.request_id !== activeRequestId) return;

      setLoading(false);

      if (!res.ok) {
        show("err", res.message || res.error || "Connexion échouée");
        return;
      }

      // ✅ IMPORTANT : stocker token pour afficher prix revendeur
      const session = {
        email: (res.user && res.user.email) || res.email || document.getElementById("email").value || "",
        username: (res.user && res.user.username) || res.username || "",
        role: (res.user && res.user.role) || res.role || "",
        isReseller: !!((res.user && res.user.isReseller) || res.isReseller),
        token: res.token || res.vf_token || res.session_token || "",
        ts: Date.now()
      };

      localStorage.setItem("vf_session", JSON.stringify(session));
      if (session.token) localStorage.setItem("vf_token", session.token);
      localStorage.setItem("vf_session_changed", String(Date.now()));

      show("ok", "Connexion OK. Redirection…");
      setTimeout(() => location.href = "index.html", 450);
    });

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      show("err", ""); // reset
      msg.classList.add("hidden");

      setLoading(true);
      clearOldTransport();

      activeRequestId = uid();

      // ✅ Crée iframe invisible
      const iframe = document.createElement("iframe");
      iframe.id = "vf_login_iframe";
      iframe.name = "vf_login_iframe";
      iframe.style.display = "none";
      document.body.appendChild(iframe);

      // ✅ Crée form POST caché vers Apps Script
      const post = document.createElement("form");
      post.id = "vf_login_post_form";
      post.method = "POST";
      post.target = "vf_login_iframe";

      // ✅ action en query string (ton doPost lit params.action)
      const actionUrl =
        SCRIPT_URL +
        "?action=login" +
        "&transport=iframe" +
        "&origin=" + encodeURIComponent(location.origin) +
        "&request_id=" + encodeURIComponent(activeRequestId);

      post.action = actionUrl;

      // champs body
      const email = document.createElement("input");
      email.type = "hidden";
      email.name = "email";
      email.value = document.getElementById("email").value.trim();

      const pass = document.createElement("input");
      pass.type = "hidden";
      pass.name = "password";
      pass.value = document.getElementById("password").value;

      // action aussi en body (au cas où)
      const actionB = document.createElement("input");
      actionB.type = "hidden";
      actionB.name = "action";
      actionB.value = "login";

      post.appendChild(email);
      post.appendChild(pass);
      post.appendChild(actionB);

      document.body.appendChild(post);

      // timeout sécurité
      const t = setTimeout(() => {
        setLoading(false);
        show("err", "Pas de réponse du serveur. Vérifie le déploiement Web App et l'action login.");
      }, 15000);

      // si réponse arrive, on clear via message handler
      const onMsgClear = (ev) => {
        const okOrigin =
          (typeof ev.origin === "string") &&
          (ev.origin.includes("script.googleusercontent.com") || ev.origin.includes("script.google.com"));
        if (!okOrigin) return;
        clearTimeout(t);
        window.removeEventListener("message", onMsgClear);
      };
      window.addEventListener("message", onMsgClear);

      post.submit();
    });
  </script>

</body>
</html>
