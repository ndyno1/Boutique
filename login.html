<!DOCTYPE html>
<html lang="fr">
<head>
  <script>
    (function () {
      const ref = document.referrer || "";
      const inAppsScriptPanel = /script\.googleusercontent\.com|script\.google\.com/i.test(ref);
      window.__VF_IN_APPS_SCRIPT_PANEL = inAppsScriptPanel;
      if (inAppsScriptPanel) return;

      const host = (location.hostname || "").toLowerCase();
      const isWWW = host === "www.viralflowr.com";
      const isApex = host === "viralflowr.com";
      const isTarget = isWWW || isApex;
      if (!isTarget) return;

      const CANON_HOST = "viralflowr.com"; 
      if (host === CANON_HOST) return;

      const GUARD_KEY = "vf_canon_redirect_guard";
      const now = Date.now();

      try {
        const guard = JSON.parse(sessionStorage.getItem(GUARD_KEY) || "null");
        if (guard && (now - guard.ts) < 15000) return;
        sessionStorage.setItem(GUARD_KEY, JSON.stringify({ ts: now, from: host, to: CANON_HOST }));
      } catch (_) {}

      location.replace("https://" + CANON_HOST + location.pathname + location.search + location.hash);
    })();
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ViralFlowr | Connexion</title>

  <script>
    const inAppsScriptPanel =
      window.__VF_IN_APPS_SCRIPT_PANEL ||
      /script\.googleusercontent\.com|script\.google\.com/i.test(document.referrer || "");

    window.VF_CONFIG = {
      scriptUrl: "https://script.google.com/macros/s/AKfycbx_Tm3cGZs4oYdKmPieUU2SCjegAvn-BTufubyqZTFU4geAiRXN53YYE9XVGdq_uq1H/exec",
      timeoutMs: 20000,
      debug: true,
      postMessageTargetOrigin: inAppsScriptPanel ? "*" : location.origin
    };
  </script>

  <script src="/vf_api.js?v=102" defer></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">

  <style>
    body{ font-family:Inter,system-ui,sans-serif; background:#F8FAFC; }
    .brand-gradient { background: linear-gradient(135deg, #F07E13 0%, #FFB26B 100%); }
    .input-field { transition: all 0.2s; border: 1px solid #E5E7EB; }
    .is-valid { border-color: #10B981 !important; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.1); }
    .is-invalid { border-color: #EF4444 !important; box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.1); }
  </style>
</head>

<body class="min-h-screen flex items-center justify-center px-4">
  <div class="w-full max-w-md bg-white border border-gray-100 shadow-sm rounded-3xl p-6">
    <div class="text-2xl font-black tracking-tight text-gray-900">
      Viral<span class="text-[#F07E13]">Flowr</span>
    </div>
    <div class="mt-1 text-sm font-semibold text-gray-400">
      Connexion à ton compte
    </div>

    <div id="msg" class="mt-4 hidden rounded-2xl border p-3 text-sm font-semibold"></div>

    <form id="loginForm" class="mt-5 space-y-4">
      <div>
        <label class="text-xs font-black uppercase tracking-widest text-gray-400 ml-1">Email</label>
        <input id="email" type="email" required
          class="input-field mt-1 h-11 w-full px-4 rounded-2xl bg-white text-sm font-semibold outline-none focus:ring-2 focus:ring-[#F07E13]"
          placeholder="ex: test@gmail.com" />
      </div>

      <div>
        <div class="flex justify-between items-center ml-1">
          <label class="text-xs font-black uppercase tracking-widest text-gray-400">Mot de passe</label>
          <a href="forgot.html" class="text-[10px] font-bold text-[#F07E13] hover:underline uppercase tracking-tighter">Mot de passe oublié ?</a>
        </div>
        <input id="password" type="password" required
          class="input-field mt-1 h-11 w-full px-4 rounded-2xl bg-white text-sm font-semibold outline-none focus:ring-2 focus:ring-[#F07E13]"
          placeholder="••••••••" />
      </div>

      <button id="btn" type="submit"
        class="w-full h-11 rounded-2xl brand-gradient text-white font-black uppercase tracking-widest text-[12px] shadow-md hover:opacity-95 transition disabled:opacity-50">
        Se connecter
      </button>
    </form>

    <div class="mt-4 text-xs font-bold text-gray-400 text-center">
      Pas de compte ? <a class="text-gray-900 hover:underline" href="register.html">Créer un compte</a>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const REDIRECT_GUARD_KEY = "vf_login_redirect_guard";

    async function getUserIp() {
      try {
        const res = await fetch('https://api.ipify.org?format=json');
        const data = await res.json();
        return data.ip;
      } catch (e) {
        return "IP_INDISPONIBLE";
      }
    }

    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i.test(email);
    }

    $("email").addEventListener("input", function() {
      const valid = isValidEmail(this.value.trim());
      if(this.value.length > 0) {
        this.classList.toggle("is-valid", valid);
        this.classList.toggle("is-invalid", !valid);
      } else {
        this.classList.remove("is-valid", "is-invalid");
      }
    });

    $("password").addEventListener("input", function() {
      if(this.value.length > 0) {
        this.classList.toggle("is-valid", this.value.length >= 6);
        this.classList.toggle("is-invalid", this.value.length < 6);
      } else {
        this.classList.remove("is-valid", "is-invalid");
      }
    });

    function showMsg(type, text){
      const box = $("msg");
      box.classList.remove("hidden");
      box.className = "mt-4 rounded-2xl border p-3 text-sm font-semibold";
      if (type === "ok") box.classList.add("border-green-200","bg-green-50","text-green-900");
      else box.classList.add("border-red-200","bg-red-50","text-red-900");
      box.textContent = text;
    }

    function getNext(){
      const u = new URL(location.href);
      const raw = u.searchParams.get("next") || "index.html";
      try{
        const n = new URL(raw, location.href);
        if (n.origin !== location.origin) return "index.html";
        const p = (n.pathname || "").toLowerCase();
        if (p.endsWith("/login.html") || p.endsWith("/register.html")) return "index.html";
        return n.pathname + n.search + n.hash;
      }catch(_){ return "index.html"; }
    }

    function clearSession(){
      localStorage.removeItem("vf_token");
      localStorage.removeItem("vf_session");
      localStorage.removeItem("vf_session_changed");
    }

    function redirectIfAlreadyLogged(){
      let s = null;
      try { s = JSON.parse(localStorage.getItem("vf_session") || "null"); } catch(_){}
      const t = localStorage.getItem("vf_token");
      const next = getNext();
      if (!(t && s && (s.email || s.username))) return;

      try{
        const now = Date.now();
        const guard = JSON.parse(localStorage.getItem(REDIRECT_GUARD_KEY) || "null");
        if (guard && guard.next === next && (now - guard.ts) < 8000){
          localStorage.removeItem(REDIRECT_GUARD_KEY);
          clearSession();
          showMsg("err", "Ta session a expiré. Reconnecte-toi.");
          return;
        }
        localStorage.setItem(REDIRECT_GUARD_KEY, JSON.stringify({ ts: now, next }));
        location.replace(next);
      }catch(_){ location.replace(next); }
    }

    redirectIfAlreadyLogged();

    window.addEventListener("DOMContentLoaded", () => {
      const api = window.vfApi;
      if (!api || typeof api.login !== "function") {
        showMsg("err", "Erreur: API non chargée. Recharge la page.");
        return;
      }

      $("loginForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = $("email").value.trim();
        const password = $("password").value;

        $("btn").disabled = true;
        $("btn").classList.add("opacity-70");
        showMsg("ok", "Sécurisation de la connexion...");

        const user_ip = await getUserIp();

        try{
          const res = await api.login({ email, password, user_ip });
          
          if (!res || res.ok !== true){
            showMsg("err", "Erreur: " + (res?.error || res?.message || "Identifiants incorrects"));
            $("btn").disabled = false;
            $("btn").classList.remove("opacity-70");
            return;
          }

          if (res.token) localStorage.setItem("vf_token", String(res.token));
          const session = res.session || res.user || null;
          if (session) localStorage.setItem("vf_session", JSON.stringify(session));

          localStorage.setItem("vf_session_changed", String(Date.now()));
          localStorage.removeItem(REDIRECT_GUARD_KEY);

          showMsg("ok", "Connecté ! Redirection...");
          setTimeout(() => location.replace(getNext()), 350);

        }catch(err){
          showMsg("err", "Erreur réseau. Réessaie.");
          $("btn").disabled = false;
          $("btn").classList.remove("opacity-70");
        }
      });
    });
  </script>
</body>
</html>
