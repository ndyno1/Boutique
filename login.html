<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Connexion • ViralFlowr</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">

  <style>
    body { font-family: Inter, sans-serif; }
    .brand-gradient { background: linear-gradient(135deg, #F07E13 0%, #FFB26B 100%); }
  </style>
</head>

<body class="min-h-screen bg-slate-50 flex items-center justify-center p-4">
  <div class="w-full max-w-md bg-white rounded-3xl shadow-sm border border-slate-100 p-6">
    <div class="text-center mb-6">
      <div class="text-3xl font-black tracking-tighter">
        Viral<span class="text-[#F07E13]">Flowr</span>
      </div>
      <div class="text-xs font-black uppercase tracking-widest text-slate-300 mt-2">Connexion</div>
    </div>

    <div id="err" class="hidden mb-4 bg-red-50 border border-red-200 text-red-700 font-bold text-xs rounded-2xl px-4 py-3"></div>

    <form id="loginForm" class="space-y-4">
      <div>
        <label class="text-xs font-black uppercase tracking-widest text-slate-400">Email</label>
        <input id="email" type="email" required
          class="mt-2 w-full h-12 px-4 rounded-2xl bg-slate-100 font-semibold outline-none focus:ring-2 focus:ring-[#F07E13]" />
      </div>

      <div>
        <label class="text-xs font-black uppercase tracking-widest text-slate-400">Mot de passe</label>
        <input id="password" type="password" required minlength="6"
          class="mt-2 w-full h-12 px-4 rounded-2xl bg-slate-100 font-semibold outline-none focus:ring-2 focus:ring-[#F07E13]" />
      </div>

      <button id="btn" type="submit"
        class="w-full h-12 rounded-2xl brand-gradient text-white font-black uppercase tracking-widest text-xs shadow-sm">
        Se connecter
      </button>

      <div class="text-center text-xs font-semibold text-slate-400">
        Pas de compte ?
        <a href="register.html" class="text-[#F07E13] font-black">Inscription</a>
      </div>
    </form>
  </div>

  <!-- iframe caché pour POST cross-origin sans CORS -->
  <iframe id="vf_iframe" name="vf_iframe" style="display:none;width:0;height:0;border:0;"></iframe>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx_Tm3cGZs4oYdKmPieUU2SCjegAvn-BTufubyqZTFU4geAiRXN53YYE9XVGdq_uq1H/exec";

    let PENDING_REQ = null;

    function showErr(msg){
      const box = document.getElementById("err");
      box.textContent = msg;
      box.classList.remove("hidden");
    }
    function hideErr(){
      const box = document.getElementById("err");
      box.textContent = "";
      box.classList.add("hidden");
    }

    function makeHidden(name, value){
      const i = document.createElement("input");
      i.type = "hidden";
      i.name = name;
      i.value = value;
      return i;
    }

    // ✅ recevoir la réponse du Apps Script (postMessage depuis l'iframe)
    window.addEventListener("message", (event) => {
      // event.origin sera généralement https://script.google.com ou https://script.googleusercontent.com
      let data = event.data;
      try {
        if (typeof data === "string") data = JSON.parse(data);
      } catch (_) {}

      if (!data || !data.request_id || data.request_id !== PENDING_REQ) return;

      PENDING_REQ = null;

      const btn = document.getElementById("btn");
      btn.disabled = false;
      btn.textContent = "Se connecter";

      if (!data.ok) {
        showErr(data.message || data.error || "Connexion échouée.");
        return;
      }

      if (!data.token) {
        showErr("Connexion OK mais token manquant. Vérifie ton Apps Script (login doit renvoyer token).");
        return;
      }

      const email = String(data?.user?.email || "").trim() || String(document.getElementById("email").value || "").trim().toLowerCase();
      const username = String(data?.user?.username || email);

      const session = {
        email,
        username,
        token: String(data.token).trim(),
        ts: Date.now()
      };

      localStorage.setItem("vf_session", JSON.stringify(session));
      localStorage.setItem("vf_token", session.token); // optionnel compat
      localStorage.setItem("vf_session_changed", String(Date.now()));

      window.location.href = "index.html";
    });

    document.getElementById("loginForm").addEventListener("submit", (ev) => {
      ev.preventDefault();
      hideErr();

      const btn = document.getElementById("btn");
      btn.disabled = true;
      btn.textContent = "Connexion...";

      const email = String(document.getElementById("email").value || "").trim().toLowerCase();
      const password = String(document.getElementById("password").value || "");

      // ID pour matcher la réponse
      const requestId = "req_" + Date.now() + "_" + Math.floor(Math.random() * 1000000);
      PENDING_REQ = requestId;

      // ✅ POST via FORM (pas de CORS)
      const form = document.createElement("form");
      form.method = "POST";
      form.action = SCRIPT_URL;
      form.target = "vf_iframe";

      form.appendChild(makeHidden("action", "login"));
      form.appendChild(makeHidden("email", email));
      form.appendChild(makeHidden("password", password));

      // indique au serveur qu'on veut une réponse HTML qui fait postMessage
      form.appendChild(makeHidden("transport", "iframe"));
      form.appendChild(makeHidden("origin", location.origin));
      form.appendChild(makeHidden("request_id", requestId));

      document.body.appendChild(form);
      form.submit();
      form.remove();

      // petit timeout au cas où le script ne répond pas
      setTimeout(() => {
        if (PENDING_REQ === requestId) {
          PENDING_REQ = null;
          btn.disabled = false;
          btn.textContent = "Se connecter";
          showErr("Pas de réponse du serveur. Vérifie le déploiement Apps Script (Web App) et l'action login.");
        }
      }, 15000);
    });
  </script>
</body>
</html>
