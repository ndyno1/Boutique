<!DOCTYPE html>
<html lang="fr" class="font-inter">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ViralFlowr | Paiement S√©curis√©</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #F3F3F3; }
    .brand-gradient { background: linear-gradient(135deg, #F07E13 0%, #FFB26B 100%); }
    .text-orange-bsv { color: #F07E13; }
    .checkout-container { max-width: 500px; width: 100%; margin: 2rem auto; }
    input, textarea { outline: none; transition: all 0.2s; border: 1px solid #e5e7eb !important; }
    input:focus, textarea:focus { border-color: #F07E13 !important; }

    .payment-row {
      display:flex; justify-content:space-between; align-items:center;
      padding:12px; background:rgba(255,255,255,0.03);
      border-radius:12px; border:1px solid rgba(255,255,255,0.1);
      margin-bottom:8px;
    }
    .copy-badge{
      font-size:10px; font-weight:800; background:rgba(255,255,255,0.1);
      padding:4px 8px; border-radius:6px; cursor:pointer; transition:0.2s;
    }
    .copy-badge:hover { background:#F07E13; color:white; }
  </style>
</head>

<body class="p-4 md:p-8 text-[#201B16]">

  <div class="checkout-container">
    <div class="text-center mb-6">
      <a href="index.html" class="inline-block text-2xl font-black tracking-tighter mb-1">
        Viral<span class="text-orange-bsv">Flowr</span>
      </a>
      <p class="text-gray-400 text-[10px] font-bold uppercase tracking-widest">Finaliser votre commande</p>
    </div>

    <div class="bg-white rounded-[32px] shadow-lg border border-gray-100 p-6 md:p-8">

      <div id="form-container">
        <h2 id="service-name" class="text-xl font-extrabold text-center mb-2 leading-tight">Chargement...</h2>
        <div class="text-center mb-6">
          <span id="cat-badge" class="bg-gray-100 text-gray-500 text-[10px] font-bold px-3 py-1 rounded-full uppercase">‚Äî</span>
        </div>

        <!-- Description + Long desc (depuis l‚ÄôURL : desc/long) -->
        <div id="description-section" class="hidden mb-6 bg-blue-50 border border-blue-100 rounded-2xl p-4">
          <h3 class="text-blue-800 text-xs font-black uppercase mb-2 flex items-center gap-2">
            <span>‚ÑπÔ∏è</span> Description & Instructions
          </h3>
          <p id="desc-text" class="text-xs text-blue-900 leading-relaxed whitespace-pre-line font-medium"></p>
        </div>

        <div class="bg-gray-50 border-2 border-dashed border-gray-200 rounded-2xl p-4 text-center mb-8 relative group hover:border-orange-200 transition-all">
          <span class="text-[9px] font-black text-gray-400 uppercase tracking-widest block mb-1">Note de commande (Important)</span>
          <span id="live-order-id" class="block text-2xl font-black text-gray-900 tracking-tight cursor-pointer" onclick="copyText(this.innerText)">...</span>
          <div class="mt-2">
            <button type="button" onclick="copyText(document.getElementById('live-order-id').innerText)" class="text-[9px] bg-white border border-gray-300 px-3 py-1 rounded-full font-bold shadow-sm">
              COPIER LA NOTE
            </button>
          </div>
        </div>

        <form id="orderForm" class="space-y-5">

          <!-- ‚úÖ SMM2 / SMM3 / BOOST : lien + qty (min/max URL) -->
          <div id="section-smm" class="hidden space-y-4">
            <div>
              <label class="text-[11px] font-bold text-gray-900 uppercase ml-1">Lien √† booster</label>
              <input type="text" id="boost-link" required placeholder="https://..." class="w-full bg-white rounded-xl p-3 text-sm font-medium">
            </div>

            <div>
              <label class="text-[11px] font-bold text-gray-900 uppercase ml-1">Quantit√©</label>
              <input type="number" id="qty" value="1000" class="w-full bg-white rounded-xl p-3 text-sm font-black">
              <div id="qty-hint" class="text-[11px] text-gray-500 font-bold mt-2 hidden"></div>
            </div>
          </div>

          <!-- ‚úÖ ABONNEMENT : identifiants + contact livraison obligatoire -->
          <div id="section-abonnement" class="hidden space-y-4">
            <div>
              <label class="text-[11px] font-bold text-gray-900 uppercase ml-1">Vos Identifiants</label>
              <textarea id="creds" required placeholder="NET-mail-oto@gmail.com&#10;NET-motdepasse-toto&#10;NET-CCC-333"
                        class="w-full bg-white rounded-xl p-3 text-sm font-medium h-24 resize-none"></textarea>
            </div>
            <div>
              <label class="text-[11px] font-bold text-gray-900 uppercase ml-1">Contact Livraison (obligatoire)</label>
              <input type="text" id="delivery-contact-abo" required placeholder="WhatsApp ou Email"
                     class="w-full bg-white rounded-xl p-3 text-sm font-medium">
              <p class="text-[11px] text-gray-400 font-bold mt-2">‚ö†Ô∏è Utile si OTP / erreur / livraison</p>
            </div>
          </div>

          <!-- ‚úÖ CARTE : contact livraison obligatoire -->
          <div id="section-carte" class="hidden space-y-4">
            <div>
              <label class="text-[11px] font-bold text-gray-900 uppercase ml-1">O√π recevoir le code ? (obligatoire)</label>
              <input type="text" id="card-delivery" required placeholder="WhatsApp ou Email"
                     class="w-full bg-white rounded-xl p-3 text-sm font-medium">
            </div>
          </div>

          <!-- Fallback (si une autre cat√©gorie arrive) -->
          <div id="section-default" class="hidden space-y-4">
            <input type="text" id="main-input" placeholder="Information requise..."
                   class="w-full bg-white rounded-xl p-3 text-sm font-medium">
            <input type="email" id="email-client" placeholder="Votre Email (optionnel)"
                   class="w-full bg-white rounded-xl p-3 text-sm font-medium">
          </div>

          <div class="py-2 text-center">
            <span class="text-[10px] text-gray-400 uppercase font-bold">Total √† payer</span>
            <div id="display-price" class="text-4xl font-black text-gray-900 tracking-tighter">0.00 $</div>
          </div>

          <div class="bg-[#121417] rounded-[24px] p-5 text-white shadow-2xl relative overflow-hidden">
            <h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-4">Moyens accept√©s</h4>

            <div class="payment-row">
              <div>
                <span class="block text-[10px] font-bold text-orange-400 uppercase">Binance Pay</span>
                <span class="text-[13px] font-bold">744370418</span>
              </div>
              <button type="button" class="copy-badge" onclick="copyText('744370418')">COPIER</button>
            </div>

            <div class="grid grid-cols-2 gap-2 mt-2">
              <div class="bg-white/5 p-3 rounded-xl border border-white/10">
                <span class="block text-[9px] font-bold text-blue-300 uppercase mb-1">Wave (CI)</span>
                <div class="flex justify-between items-center">
                  <span class="text-[11px] font-bold">0546247885</span>
                  <button type="button" onclick="copyText('+2250546247885')">üìã</button>
                </div>
              </div>
              <div class="bg-white/5 p-3 rounded-xl border border-white/10">
                <span class="block text-[9px] font-bold text-red-400 uppercase mb-1">Airtel (RDC)</span>
                <div class="flex justify-between items-center">
                  <span class="text-[11px] font-bold">0971028041</span>
                  <button type="button" onclick="copyText('0971028041')">üìã</button>
                </div>
              </div>
            </div>

            <p class="text-[10px] text-gray-400 font-bold mt-4">
              ‚ö†Ô∏è Mets la <span class="text-white">NOTE</span> (ID commande) dans Binance Pay.
            </p>
          </div>

          <div class="pt-2">
            <label class="text-[11px] font-bold text-gray-900 uppercase ml-1 block mb-2">üì∏ Preuve de paiement</label>
            <input type="file" id="file" accept="image/*" required
                   class="w-full text-xs bg-white rounded-xl p-3 border border-gray-200 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-xs file:font-bold file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200">
          </div>

          <button type="submit" id="submitBtn"
                  class="w-full brand-gradient text-white py-4 rounded-2xl font-black text-sm uppercase shadow-xl hover:scale-[1.02] transition-transform">
            Confirmer le paiement
          </button>
        </form>
      </div>

      <div id="success-msg" class="hidden text-center py-12">
        <div class="w-24 h-24 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6 animate-bounce">
          <svg width="40" height="40" fill="none" stroke="currentColor" stroke-width="4" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"></path></svg>
        </div>
        <h3 class="text-3xl font-black text-gray-900 mb-2">Re√ßu 5/5 !</h3>
        <p class="text-gray-500 text-sm mb-8 font-medium">
          Votre commande <strong id="final-id" class="text-gray-900"></strong> est en cours de traitement.
        </p>
        <button type="button" onclick="location.href='index.html'"
                class="w-full bg-gray-900 text-white py-4 rounded-2xl font-black text-xs uppercase hover:bg-gray-800 transition-colors">
          Retour √† la boutique
        </button>
      </div>

    </div>

    <div class="mt-8 text-center">
      <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Paiement s√©curis√© par ViralFlowr</p>
    </div>
  </div>

  <script>
    // ‚úÖ Ton Apps Script (doPost re√ßoit: orderId, produit, idService, categorie, input1, email, quantite, total, fileData, fileType)
    const GOOGLE_URL = "https://script.google.com/macros/s/AKfycbyCvuy-WiLMlAkBb7k6YyPVMk4lQhGGke05heSWSw--twKE2L-oVSOs884g3jn6lt6m/exec";

    function copyText(txt) {
      navigator.clipboard.writeText(String(txt || ""));
      alert("Copi√© !");
    }

    // --- ID UNIQUE √† chaque chargement ---
    const randomNum = Math.floor(1000 + Math.random() * 9000);
    const orderId = "#VF-" + randomNum;
    document.getElementById('live-order-id').innerText = orderId;

    // --- Params URL (compatibles avec ton syst√®me) ---
    const params = new URLSearchParams(window.location.search);
    const nom  = params.get('nom')  || "Service";
    const cat  = params.get('cat')  || "";
    const idS  = params.get('id')   || "";
    const prixInitial = parseFloat(params.get('prix')) || 0;

    // desc/long (facultatif)
    const desc = params.get('desc') || "";
    const longDesc = params.get('long') || params.get('long_desc') || "";

    // min/max (facultatif pour SMM)
    const minParam = parseFloat(params.get('min'));
    const maxParam = parseFloat(params.get('max'));

    document.getElementById('service-name').innerText = nom;
    document.getElementById('cat-badge').innerText = cat || "Service";

    // --- Description UI ---
    const descBox = document.getElementById('description-section');
    const descText = document.getElementById('desc-text');
    const fullDesc = (String(longDesc || "").trim() !== "") ? longDesc : desc;

    if (String(fullDesc || "").trim() !== "") {
      descText.innerText = fullDesc;
      descBox.classList.remove('hidden');
    }

    // --- Cat logic ---
    const catUpper = String(cat || "").toUpperCase();
    const isSMM = /\b(SMM2|SMM3|BOOST|PEAK|PEAKERR)\b/i.test(catUpper);
    const isABO = /\bABONNEMENT\b/i.test(catUpper);
    const isCARTE = (catUpper === "CARTE" || catUpper === "CARTE2" || /\bCARTE2\b/i.test(catUpper));

    const priceEl = document.getElementById('display-price');

    // Sections
    const secSmm = document.getElementById('section-smm');
    const secAbo = document.getElementById('section-abonnement');
    const secCarte = document.getElementById('section-carte');
    const secDef = document.getElementById('section-default');

    // SMM setup
    const qtyInp = document.getElementById('qty');
    const qtyHint = document.getElementById('qty-hint');

    function fmtMoney(n){
      const x = Number(n);
      return (Number.isFinite(x) ? x.toFixed(2) : "0.00") + " $";
    }

    function clampQty(q){
      let x = parseFloat(q || "0");
      const hasMin = Number.isFinite(minParam);
      const hasMax = Number.isFinite(maxParam);

      if (hasMin && x < minParam) x = minParam;
      if (hasMax && x > maxParam) x = maxParam;
      if (!Number.isFinite(x) || x <= 0) x = hasMin ? minParam : 1;
      return x;
    }

    function setPriceSmm(){
      const q = clampQty(qtyInp.value);
      if (String(qtyInp.value) !== String(q)) qtyInp.value = q;
      priceEl.innerText = fmtMoney((prixInitial / 1000) * q);
    }

    // Show the right section
    if (isSMM) {
      secSmm.classList.remove('hidden');
      priceEl.innerText = fmtMoney(prixInitial); // au d√©part

      // applique min/max si pr√©sents
      const hasMin = Number.isFinite(minParam);
      const hasMax = Number.isFinite(maxParam);

      if (hasMin) qtyInp.min = String(minParam);
      if (hasMax) qtyInp.max = String(maxParam);

      if (hasMin || hasMax) {
        qtyHint.classList.remove('hidden');
        qtyHint.innerText = `Plage autoris√©e : ${hasMin ? minParam : 0} ‚Äì ${hasMax ? maxParam : "‚àû"}`;
      }

      qtyInp.addEventListener('input', setPriceSmm);
      setPriceSmm();

    } else if (isABO) {
      secAbo.classList.remove('hidden');
      priceEl.innerText = fmtMoney(prixInitial);

    } else if (isCARTE) {
      secCarte.classList.remove('hidden');
      priceEl.innerText = fmtMoney(prixInitial);

    } else {
      secDef.classList.remove('hidden');
      priceEl.innerText = fmtMoney(prixInitial);
    }

    // --- Submit (adapt√© √† TON Apps Script / recevoir()) ---
    document.getElementById('orderForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.innerText = "Validation en cours...";

      try {
        const file = document.getElementById('file').files[0];
        if (!file) throw new Error("Preuve manquante");

        // lecture image base64
        const fileData = await new Promise((resolve, reject) => {
          const r = new FileReader();
          r.onload = () => resolve(r.result);
          r.onerror = () => reject(new Error("Lecture image impossible"));
          r.readAsDataURL(file);
        });

        // Construire input1 / email / qty selon cat√©gorie
        let input1 = "";
        let emailField = "";  // ton Apps Script stocke √ßa en "Email Client" (m√™me si WhatsApp)
        let qtyVal = "";

        if (isSMM) {
          const link = document.getElementById('boost-link').value.trim();
          if (!link) throw new Error("Lien √† booster obligatoire");
          input1 = link;
          qtyVal = String(clampQty(qtyInp.value)); // respect min/max
          // email non obligatoire ici => laiss√© vide

        } else if (isABO) {
          const creds = document.getElementById('creds').value.trim();
          const contact = document.getElementById('delivery-contact-abo').value.trim();
          if (!creds) throw new Error("Identifiants obligatoires");
          if (!contact) throw new Error("Contact livraison obligatoire");
          input1 = creds;        // col "Info"
          emailField = contact;  // col "Email Client" (peut √™tre WhatsApp)
          qtyVal = "";           // pas utile

        } else if (isCARTE) {
          const contact = document.getElementById('card-delivery').value.trim();
          if (!contact) throw new Error("Contact livraison obligatoire");
          input1 = contact;      // col "Info"
          emailField = contact;  // col "Email Client" (peut √™tre WhatsApp)
          qtyVal = "";           // pas utile

        } else {
          input1 = (document.getElementById('main-input').value || "").trim();
          emailField = (document.getElementById('email-client').value || "").trim();
          qtyVal = "";
        }

        // total (texte d√©j√† format√©)
        const totalTxt = String(priceEl.innerText || fmtMoney(prixInitial));

        const payload = {
          orderId: orderId,
          produit: nom,
          idService: idS,
          categorie: cat,
          input1: input1,
          email: emailField,
          quantite: qtyVal,
          total: totalTxt,
          fileData: fileData,
          fileType: file.type || ""
        };

        await fetch(GOOGLE_URL, {
          method: 'POST',
          mode: 'no-cors',
          body: JSON.stringify(payload)
        });

        // Confetti
        confetti({
          particleCount: 140,
          spread: 75,
          origin: { y: 0.6 },
          colors: ['#F07E13', '#22C55E', '#121417']
        });

        document.getElementById('form-container').classList.add('hidden');
        document.getElementById('final-id').innerText = orderId;
        document.getElementById('success-msg').classList.remove('hidden');

      } catch (err) {
        alert(err && err.message ? err.message : "Erreur. R√©essayez.");
        btn.disabled = false;
        btn.innerText = "Confirmer le paiement";
      }
    });
  </script>
</body>
</html>
