<!DOCTYPE html>
<html lang="fr" class="font-inter">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>ViralFlowr | Paiement S√©curis√©</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F3F3F3; }
        .brand-gradient { background: linear-gradient(135deg, #F07E13 0%, #FFB26B 100%); }
        .text-orange-bsv { color: #F07E13; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .checkout-container { max-width: 500px; width: 100%; margin: 2rem auto; }
        input, textarea { outline: none; transition: all 0.2s; }
        input:focus, textarea:focus { ring: 2px; ring-color: #F07E13; border-color: transparent; }
    </style>
</head>

<body class="p-4 md:p-8">

    <div class="checkout-container">
        <div class="text-center mb-8">
            <a href="index.html" class="inline-block text-2xl font-black tracking-tighter mb-2">
                Viral<span class="text-orange-bsv">Flowr</span>
            </a>
            <p class="text-gray-400 text-xs font-bold uppercase tracking-widest">Finaliser votre achat</p>
        </div>

        <div class="bg-white rounded-[32px] shadow-sm border border-gray-100 p-6 md:p-8">
            
            <div id="form-container">
                <h2 id="service-name" class="text-xl font-extrabold text-center text-gray-900 mb-6">Chargement...</h2>

                <div class="bg-[#F8FAFC] border-2 border-dashed border-[#F07E13]/30 rounded-2xl p-4 text-center mb-6">
                    <span class="text-[10px] font-black text-orange-600 uppercase tracking-tighter">Note √† mettre sur Binance Pay</span>
                    <span id="live-order-id" class="block text-2xl font-black text-gray-900 my-1">#CMD-XXXX</span>
                    <button type="button" onclick="copyID()" class="text-[10px] font-bold bg-gray-900 text-white px-3 py-1 rounded-full hover:bg-orange-500 transition-colors">COPIER L'ID</button>
                </div>

                <div class="flex justify-center mb-6">
                    <div class="bg-gray-100 px-4 py-1.5 rounded-full text-[11px] font-bold text-gray-600 uppercase">
                        Cat√©gorie : <span id="cat-name" class="text-blue-600">‚Äî</span>
                    </div>
                </div>

                <div class="space-y-3 mb-6">
                    <details class="group bg-gray-50 rounded-xl overflow-hidden hidden" id="long-ui" open>
                        <summary class="list-none p-3 font-bold text-xs cursor-pointer flex justify-between items-center text-gray-700">
                            üìù Description du produit
                            <span class="group-open:rotate-180 transition-transform">‚ñº</span>
                        </summary>
                        <div class="p-3 pt-0 text-xs text-gray-500 leading-relaxed italic" id="service-long"></div>
                    </details>

                    <details class="group bg-green-50 rounded-xl overflow-hidden hidden" id="desc-ui">
                        <summary class="list-none p-3 font-bold text-xs cursor-pointer flex justify-between items-center text-green-700">
                            üìÑ Instructions
                            <span class="group-open:rotate-180 transition-transform">‚ñº</span>
                        </summary>
                        <div class="p-3 pt-0 text-xs text-green-600 leading-relaxed" id="service-desc"></div>
                    </details>
                </div>

                <form id="orderForm" class="space-y-4">
                    
                    <div id="section-smm" class="hidden space-y-4">
                        <div>
                            <label class="block text-[13px] font-bold text-gray-700 mb-2">Lien √† booster (obligatoire)</label>
                            <input type="text" id="boost-link" placeholder="Lien profil ou publication" class="w-full bg-gray-50 border-none rounded-xl p-3 text-sm font-medium">
                        </div>
                        <div>
                            <label class="block text-[13px] font-bold text-gray-700 mb-2">Quantit√©</label>
                            <input type="number" id="qty" value="1000" min="10" class="w-full bg-gray-50 border-none rounded-xl p-3 text-sm font-black">
                            <p id="qty-hint" class="text-[10px] text-gray-400 mt-1"></p>
                        </div>
                        <div id="qty-warn" class="bg-red-50 text-red-600 text-[11px] p-3 rounded-xl hidden"></div>
                    </div>

                    <div id="section-abonnement" class="hidden space-y-4">
                        <div>
                            <label class="block text-[13px] font-bold text-gray-700 mb-2">Identifiants du compte (obligatoire)</label>
                            <textarea id="creds" placeholder="Email : ...&#10;Mot de passe : ..." class="w-full bg-gray-50 border-none rounded-xl p-3 text-sm font-medium"></textarea>
                        </div>
                        <div>
                            <label class="block text-[13px] font-bold text-gray-700 mb-2">Contact Livraison / OTP</label>
                            <input type="text" id="delivery-contact" placeholder="WhatsApp ou Email" class="w-full bg-gray-50 border-none rounded-xl p-3 text-sm font-medium">
                        </div>
                    </div>

                    <div id="section-carte" class="hidden">
                        <label class="block text-[13px] font-bold text-gray-700 mb-2">Contact pour livraison (WhatsApp/Email)</label>
                        <input type="text" id="card-delivery" placeholder="O√π envoyer le code ?" class="w-full bg-gray-50 border-none rounded-xl p-3 text-sm font-medium">
                    </div>

                    <div id="section-default" class="hidden space-y-4">
                        <div>
                            <label id="input-label" class="block text-[13px] font-bold text-gray-700 mb-2">Information requise</label>
                            <input type="text" id="main-input" placeholder="D√©tails ici..." class="w-full bg-gray-50 border-none rounded-xl p-3 text-sm font-medium">
                        </div>
                        <div>
                            <label class="block text-[13px] font-bold text-gray-700 mb-2">Email du client</label>
                            <input type="email" id="email" placeholder="client@example.com" class="w-full bg-gray-50 border-none rounded-xl p-3 text-sm font-medium">
                        </div>
                    </div>

                    <div class="py-4 text-center">
                        <span class="text-gray-400 text-xs font-bold uppercase tracking-widest block">Total √† payer</span>
                        <div id="display-price" class="text-4xl font-black text-gray-900 tracking-tighter">0.00 $</div>
                    </div>

                    <div class="bg-gray-900 rounded-2xl p-5 text-white space-y-3 shadow-xl">
                        <h4 class="text-[10px] font-black text-orange-400 uppercase tracking-widest border-b border-white/10 pb-2 mb-2">M√©thodes accept√©es</h4>
                        <div class="flex justify-between items-center text-sm">
                            <span class="opacity-70 font-medium">Binance Pay ID</span>
                            <span class="font-bold">744370418</span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="opacity-70 font-medium">Airtel (RDC)</span>
                            <span class="font-bold text-red-400">0971028041</span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="opacity-70 font-medium">Wave (CI)</span>
                            <span class="font-bold text-blue-400">+225 0546247885</span>
                        </div>
                    </div>

                    <div class="pt-4">
                        <label class="block text-[13px] font-bold text-gray-700 mb-2">üì∏ Preuve de paiement (Screenshot)</label>
                        <div class="relative group">
                            <input type="file" id="file" accept="image/*" required class="w-full text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-[11px] file:font-black file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100 cursor-pointer bg-white border border-gray-200 rounded-xl p-2">
                        </div>
                    </div>

                    <button type="submit" id="submitBtn" class="w-full brand-gradient text-white py-4 rounded-2xl font-black text-sm uppercase shadow-xl hover:scale-[1.02] transition-all">
                        Confirmer ma commande
                    </button>
                </form>
            </div>

            <div id="success-msg" class="hidden text-center py-10 animate-in fade-in zoom-in duration-500">
                <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg width="40" height="40" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"></path></svg>
                </div>
                <h3 class="text-2xl font-black text-gray-900 mb-2">Commande Re√ßue !</h3>
                <p class="text-gray-500 text-sm mb-6">Activation en cours pour l'ID <strong id="final-id" class="text-gray-900"></strong></p>
                <button onclick="resetAndReload()" class="w-full bg-gray-900 text-white py-4 rounded-2xl font-black text-sm uppercase">Nouvelle commande</button>
            </div>

        </div>

        <p class="text-center text-[10px] font-bold text-gray-400 mt-8 uppercase tracking-tighter">
            ¬© 2026 ViralFlowr Marketplace ‚Ä¢ Elite Digital Solutions
        </p>
    </div>

    <div id="chat-circle" onclick="toggleChat()" class="fixed bottom-6 right-6 brand-gradient text-white w-14 h-14 rounded-full flex items-center justify-center shadow-2xl cursor-pointer hover:rotate-12 transition-all z-50">
        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
    </div>

    <div id="chat-box" class="hidden fixed bottom-24 right-6 w-[320px] bg-white rounded-[24px] shadow-2xl z-50 overflow-hidden border border-gray-100 animate-in slide-in-from-bottom-5">
        <div class="brand-gradient p-4 text-white flex justify-between items-center">
            <span class="font-black text-xs uppercase tracking-widest">Support ViralFlowr</span>
            <button onclick="toggleChat()" class="text-white hover:opacity-50 font-bold">‚úï</button>
        </div>
        <div id="chat-history" class="h-64 overflow-y-auto p-4 bg-gray-50 flex flex-col space-y-3 no-scrollbar text-xs"></div>
        <div class="p-3 bg-white border-t border-gray-100 flex gap-2">
            <input type="text" id="chat-input" placeholder="Posez votre question..." class="flex-1 bg-gray-100 border-none rounded-xl p-2 text-xs font-medium">
            <button onclick="sendMsg()" class="text-[#F07E13] font-black text-xs uppercase px-2">OK</button>
        </div>
    </div>

    <script>
        // --- COPIER LA LOGIQUE DE VOTRE ANCIEN SCRIPT ICI ---
        const GOOGLE_URL = "https://script.google.com/macros/s/AKfycbyCvuy-WiLMlAkBb7k6YyPVMk4lQhGGke05heSWSw--twKE2L-oVSOs884g3jn6lt6m/exec";

        function escapeHTML(str=""){
            return String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
        }

        let orderId = sessionStorage.getItem('active_order_id');
        if (!orderId) {
            orderId = "#CMD-" + Math.floor(1000 + Math.random()*9000);
            sessionStorage.setItem('active_order_id', orderId);
        }
        document.getElementById('live-order-id').innerText = orderId;

        const params = new URLSearchParams(window.location.search);
        const nom = params.get('nom') || "Service";
        const prixInitial = parseFloat(params.get('prix')) || 0;
        const cat = params.get('cat') || "";
        const idS = params.get('id') || "";
        const desc = params.get('desc') || "";
        const longDesc = params.get('long') || params.get('long_desc') || "";
        const minParam = params.get('min') ? Number(params.get('min')) : null;
        const maxParam = params.get('max') ? Number(params.get('max')) : null;

        document.getElementById('service-name').innerText = nom;
        document.getElementById('cat-name').innerText = cat || "‚Äî";

        // UI Description
        if (longDesc) {
            document.getElementById('service-long').textContent = longDesc;
            document.getElementById('long-ui').classList.remove('hidden');
        }
        if (desc) {
            document.getElementById('service-desc').textContent = desc;
            document.getElementById('desc-ui').classList.remove('hidden');
        }

        // --- LOGIQUE DE CAT√âGORIE ---
        const catUpper = cat.toUpperCase();
        const isBoost = /\b(BOOST|SMM|PEAK)\b/.test(catUpper);
        const isAbo = /\bABONNEMENT\b/.test(catUpper);
        const isCard = /\bCARTE\b/.test(catUpper);

        function showSection(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        if (isBoost) {
            showSection('section-smm');
            const qty = document.getElementById('qty');
            const qtyHint = document.getElementById('qty-hint');
            if(minParam) qtyHint.innerText = `Min: ${minParam} ‚Ä¢ Max: ${maxParam || '‚àû'}`;
            qty.addEventListener('input', () => {
                let v = Number(qty.value);
                document.getElementById('display-price').innerText = ((prixInitial / 1000) * v).toFixed(2) + " $";
            });
            qty.dispatchEvent(new Event('input'));
        } else if (isAbo) {
            showSection('section-abonnement');
            document.getElementById('display-price').innerText = prixInitial.toFixed(2) + " $";
        } else if (isCard) {
            showSection('section-carte');
            document.getElementById('display-price').innerText = prixInitial.toFixed(2) + " $";
        } else {
            showSection('section-default');
            document.getElementById('display-price').innerText = prixInitial.toFixed(2) + " $";
        }

        function copyID(){ navigator.clipboard.writeText(orderId); alert("ID Copi√© !"); }
        function resetAndReload(){ sessionStorage.removeItem('active_order_id'); window.location.reload(); }

        // --- CHAT ---
        function toggleChat(){ document.getElementById('chat-box').classList.toggle('hidden'); }
        function addChat(text, isUser){
            const hist = document.getElementById('chat-history');
            const side = isUser ? 'bg-orange-100 self-end text-right' : 'bg-gray-200 self-start';
            hist.innerHTML += `<div class="${side} p-3 rounded-2xl max-w-[80%] shadow-sm">${escapeHTML(text)}</div>`;
            hist.scrollTop = hist.scrollHeight;
        }

        async function sendMsg(){
            const inp = document.getElementById('chat-input');
            if(!inp.value) return;
            addChat(inp.value, true);
            fetch(GOOGLE_URL, { method:'POST', mode:'no-cors', body: JSON.stringify({ chat: inp.value, orderId: orderId }) });
            inp.value = '';
        }

        document.getElementById('orderForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true; btn.innerText = "Traitement en cours...";

            const file = document.getElementById('file').files[0];
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const payload = {
                    orderId: orderId,
                    produit: nom,
                    categorie: cat,
                    total: document.getElementById('display-price').innerText,
                    fileData: reader.result,
                    // Collecte des champs selon la section visible
                    input1: document.getElementById('boost-link').value || document.getElementById('main-input').value || document.getElementById('creds').value,
                    email: document.getElementById('delivery-contact').value || document.getElementById('card-delivery').value || document.getElementById('email').value,
                    quantite: document.getElementById('qty').value || "1"
                };
                
                await fetch(GOOGLE_URL, { method:'POST', mode:'no-cors', body: JSON.stringify(payload) });
                document.getElementById('form-container').classList.add('hidden');
                document.getElementById('final-id').innerText = orderId;
                document.getElementById('success-msg').classList.remove('hidden');
            };
        };

        // Check replies
        setInterval(async () => {
            const res = await fetch(GOOGLE_URL + "?action=check&orderId=" + encodeURIComponent(orderId));
            const data = await res.json();
            if(data.reply) addChat(data.reply, false);
        }, 8000);
    </script>
</body>
</html>
